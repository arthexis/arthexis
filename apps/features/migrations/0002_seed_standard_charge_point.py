# Generated by GPT-5.2-Codex on 2026-03-07

from __future__ import annotations

import json
from pathlib import Path

from django.db import migrations


FIXTURE_PATH = Path(__file__).resolve().parent.parent / "fixtures" / "features__standard_charge_point.json"


def _load_fixture():
    if not FIXTURE_PATH.exists():
        return []
    try:
        payload = json.loads(FIXTURE_PATH.read_text(encoding="utf-8"))
    except (json.JSONDecodeError, IOError) as e:
        print(f"Warning: Could not load or parse fixture {FIXTURE_PATH}: {e}")
        return []
    if isinstance(payload, list):
        return payload
    return []


def seed_standard_charge_point(apps, schema_editor):
    del schema_editor

    Feature = apps.get_model("features", "Feature")
    FeatureTest = apps.get_model("features", "FeatureTest")
    Application = apps.get_model("app", "Application")
    NodeFeature = apps.get_model("nodes", "NodeFeature")

    feature_manager = getattr(Feature, "all_objects", Feature._base_manager)
    test_manager = getattr(FeatureTest, "all_objects", FeatureTest._base_manager)

    for entry in _load_fixture():
        if not isinstance(entry, dict):
            continue
        model = entry.get("model")
        fields = entry.get("fields") or {}
        if not isinstance(fields, dict):
            continue

        if model == "features.feature":
            slug = fields.get("slug")
            if not slug:
                continue

            main_app = fields.get("main_app")
            app_obj = None
            if isinstance(main_app, (list, tuple)) and main_app:
                app_name = str(main_app[0])
                if app_name:
                    app_obj, _ = Application.objects.get_or_create(
                        name=app_name, defaults={"description": ""}
                    )

            node_feature = fields.get("node_feature")
            node_obj = None
            if isinstance(node_feature, (list, tuple)) and node_feature:
                node_obj = NodeFeature.objects.filter(slug=node_feature[0]).first()

            defaults = {
                "display": fields.get("display", ""),
                "summary": fields.get("summary", ""),
                "is_enabled": bool(fields.get("is_enabled", True)),
                "main_app": app_obj,
                "node_feature": node_obj,
                "admin_requirements": fields.get("admin_requirements", ""),
                "public_requirements": fields.get("public_requirements", ""),
                "service_requirements": fields.get("service_requirements", ""),
                "admin_views": fields.get("admin_views", []) or [],
                "public_views": fields.get("public_views", []) or [],
                "service_views": fields.get("service_views", []) or [],
                "code_locations": fields.get("code_locations", []) or [],
                "protocol_coverage": fields.get("protocol_coverage", {}) or {},
                "is_seed_data": bool(fields.get("is_seed_data", False)),
                "is_deleted": bool(fields.get("is_deleted", False)),
            }
            feature_manager.update_or_create(slug=slug, defaults=defaults)
            continue

        if model == "features.featuretest":
            node_id = fields.get("node_id")
            feature_ref = fields.get("feature")
            if not node_id or not isinstance(feature_ref, (list, tuple)):
                continue
            feature_slug = feature_ref[0] if feature_ref else None
            if not feature_slug:
                continue
            feature = feature_manager.filter(slug=feature_slug).first()
            if not feature:
                continue
            defaults = {
                "name": fields.get("name", ""),
                "is_regression_guard": bool(fields.get("is_regression_guard", True)),
                "notes": fields.get("notes", ""),
                "is_seed_data": bool(fields.get("is_seed_data", False)),
                "is_deleted": bool(fields.get("is_deleted", False)),
            }
            test_manager.update_or_create(
                feature=feature,
                node_id=node_id,
                defaults=defaults,
            )


class Migration(migrations.Migration):

    dependencies = [
        ("features", "0001_initial"),
    ]

    operations = [
        migrations.RunPython(seed_standard_charge_point, migrations.RunPython.noop),
    ]
