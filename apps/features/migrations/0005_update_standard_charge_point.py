# Generated by GPT-5.2-Codex on 2026-03-07

from __future__ import annotations

import json
from pathlib import Path

from django.db import migrations


FIXTURE_PATH = Path(__file__).resolve().parent.parent / "fixtures" / "features__standard_charge_point.json"


def _load_fixture():
    if not FIXTURE_PATH.exists():
        return []
    try:
        payload = json.loads(FIXTURE_PATH.read_text(encoding="utf-8"))
    except (json.JSONDecodeError, IOError) as e:
        print(f"Warning: Could not load or parse fixture {FIXTURE_PATH}: {e}")
        return []
    if isinstance(payload, list):
        return payload
    return []


def update_standard_charge_point(apps, schema_editor):
    del schema_editor

    Feature = apps.get_model("features", "Feature")
    Application = apps.get_model("app", "Application")
    NodeFeature = apps.get_model("nodes", "NodeFeature")

    feature_manager = getattr(Feature, "all_objects", Feature._base_manager)
    application_manager = getattr(Application, "all_objects", Application._base_manager)

    for entry in _load_fixture():
        if not isinstance(entry, dict):
            continue
        if entry.get("model") != "features.feature":
            continue
        fields = entry.get("fields") or {}
        if not isinstance(fields, dict):
            continue
        slug = fields.get("slug")
        if slug != "standard-charge-point":
            continue

        main_app = fields.get("main_app")
        app_obj = None
        if isinstance(main_app, (list, tuple)) and main_app:
            app_name = str(main_app[0])
            if app_name:
                app_obj, _ = application_manager.get_or_create(
                    name=app_name, defaults={"description": ""}
                )

        node_feature = fields.get("node_feature")
        node_obj = None
        if isinstance(node_feature, (list, tuple)) and node_feature:
            node_obj = NodeFeature.objects.filter(slug=node_feature[0]).first()

        defaults = {
            "display": fields.get("display", ""),
            "summary": fields.get("summary", ""),
            "is_enabled": bool(fields.get("is_enabled", True)),
            "main_app": app_obj,
            "node_feature": node_obj,
            "admin_requirements": fields.get("admin_requirements", ""),
            "public_requirements": fields.get("public_requirements", ""),
            "service_requirements": fields.get("service_requirements", ""),
            "admin_views": fields.get("admin_views", []) or [],
            "public_views": fields.get("public_views", []) or [],
            "service_views": fields.get("service_views", []) or [],
            "code_locations": fields.get("code_locations", []) or [],
            "protocol_coverage": fields.get("protocol_coverage", {}) or {},
            "is_seed_data": bool(fields.get("is_seed_data", False)),
            "is_deleted": bool(fields.get("is_deleted", False)),
        }
        feature_manager.update_or_create(slug=slug, defaults=defaults)


class Migration(migrations.Migration):

    dependencies = [
        ("features", "0004_feature_notes"),
    ]

    operations = [
        migrations.RunPython(
            update_standard_charge_point, migrations.RunPython.noop
        ),
    ]
