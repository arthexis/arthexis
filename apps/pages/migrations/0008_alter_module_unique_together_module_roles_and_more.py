# Generated by Django 5.2.8 on 2025-12-04 22:22

from django.db import migrations, models


def migrate_module_roles(apps, schema_editor):
    Module = apps.get_model("pages", "Module")
    Landing = apps.get_model("pages", "Landing")

    modules = list(
        Module.objects.select_related("node_role", "application", "security_group")
    )
    module_map: dict[str, Module] = {}

    for module in modules:
        keeper = module_map.get(module.path)
        if keeper is None:
            module_map[module.path] = module
            keeper = module
        else:
            if getattr(keeper, "is_deleted", False) and not module.is_deleted:
                module_map[module.path] = module
                keeper, module = module, keeper
            elif not getattr(keeper, "is_default", False) and module.is_default:
                module_map[module.path] = module
                keeper, module = module, keeper
        if getattr(module, "node_role_id", None):
            keeper.roles.add(module.node_role)

        if keeper.pk != module.pk:
            Landing.objects.filter(module=module).update(module=keeper)
            module.delete()


class Migration(migrations.Migration):

    dependencies = [
        ("app", "0001_initial"),
        ("groups", "0002_initial"),
        ("nodes", "0002_initial"),
        ("pages", "0007_delete_modules_and_landings"),
    ]

    operations = [
        migrations.AlterUniqueTogether(
            name="module",
            unique_together=set(),
        ),
        migrations.AddField(
            model_name="module",
            name="roles",
            field=models.ManyToManyField(
                blank=True,
                help_text="Leave blank to apply this module to all node roles.",
                related_name="modules",
                to="nodes.noderole",
            ),
        ),
        migrations.RunPython(migrate_module_roles, migrations.RunPython.noop),
        migrations.RemoveField(
            model_name="module",
            name="node_role",
        ),
        migrations.AddConstraint(
            model_name="module",
            constraint=models.UniqueConstraint(
                fields=("path",), name="unique_module_path"
            ),
        ),
    ]
