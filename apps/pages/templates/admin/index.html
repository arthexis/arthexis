{% extends "admin/base_site.html" %}
{% load i18n static admin_extras counter_extras tz %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'admin/css/dashboard.css' %}">
  {% include "admin/includes/dashboard_styles.html" %}
{% endblock %}

{% block coltype %}colM{% endblock %}

{% block bodyclass %}{{ block.super }} dashboard{% endblock %}

{% block content_title %}
{% last_net_message as admin_last_net_message %}
<div id="admin-home-header">
  <h1>Home</h1>
  <div class="admin-home-net-message" role="status" aria-live="polite">
    <a class="admin-home-net-message__label admin-home-net-message__link" href="{% url 'admin:nodes_netmessage_send' %}">{% translate 'Net message' %}</a>
    <span class="admin-home-net-message__content{% if not admin_last_net_message.has_content %} admin-home-net-message__content--empty{% endif %}" title="{% if admin_last_net_message.has_content %}{{ admin_last_net_message.text }}{% else %}{% translate 'No net messages available' %}{% endif %}">{% if admin_last_net_message.has_content %}{{ admin_last_net_message.text }}{% else %}{% translate 'No net messages available' %}{% endif %}</span>
  </div>
  <div class="admin-home-actions">
    <a class="button" href="{% url 'admin:seed_data' %}">{% translate 'Seed Data' %}</a>
    <a class="button" href="{% url 'admin:user_data' %}">{% translate 'User Data' %}</a>
    <a class="button" href="{% url 'admin:system' %}">{% translate 'System Reports' %}</a>
    <a class="button" href="{% url 'admin:environment' %}">{% translate 'Environment' %}</a>
    <a class="button" href="{% url 'admin:config' %}">{% translate 'Django Config' %}</a>
    <a class="button" href="{% url 'admin:sigil_builder' %}">{% translate 'Sigil Builder' %}</a>
    {% if user.is_superuser %}
      <a class="button" href="{% url 'admin:run_command' %}">{% translate 'Run Command' %}</a>
    {% endif %}
    <a class="button" href="{% url 'admin:log_viewer' %}">{% translate 'Log Viewer' %}</a>
  </div>
</div>
{% endblock %}

{% block nav-breadcrumbs %}{% endblock %}
{% block nav-sidebar %}{% endblock %}

{% block content %}
<div class="dashboard" id="admin-dashboard">
  <div id="content-main" class="dashboard-main">
    {% include "admin/dashboard_app_list.html" with app_list=app_list %}
  </div>
<div class="dashboard-side" id="recent-boxes">
    <div class="module" id="viewhistory-mini-module">
        <h2>{% translate 'Public site traffic' %}</h2>
        <div class="chart-wrapper">
            <canvas id="viewhistory-mini-chart" role="img" aria-label="{% translate 'Mini chart of public visits' %}" height="160"></canvas>
            <p id="viewhistory-mini-empty" class="quiet" hidden>{% translate 'No visit data yet.' %}</p>
        </div>
        <p class="chart-link"><a id="viewhistory-mini-link" href="{% url 'admin:pages_viewhistory_traffic_graph' %}">{% translate 'Open full report' %}</a></p>
    </div>
</div>
</div>
{% endblock %}

{% block sidebar %}{% endblock %}

{% block extrahead %}
  {{ block.super }}
  <script>
    const initializeMiniTrafficChart = () => {
      const canvas = document.getElementById('viewhistory-mini-chart');
      const emptyLabel = document.getElementById('viewhistory-mini-empty');
      if (!canvas) return;

      const chartJsUrl = "{% static 'core/vendor/chart.umd.min.js' %}";

      const ensureChartJs = () => {
        if (window.Chart) {
          return Promise.resolve(window.Chart);
        }

        const waitForChart = (resolve) => {
          if (window.Chart) {
            resolve(window.Chart);
            return true;
          }
          return false;
        };

        return new Promise((resolve) => {
          const existing = document.querySelector('script[data-chartjs]');
          if (existing) {
            if (existing.dataset.chartjsState === 'error') {
              resolve(null);
              return;
            }

            if (waitForChart(resolve)) {
              return;
            }

            existing.addEventListener(
              'load',
              () => {
                existing.dataset.chartjsState = 'loaded';
                resolve(window.Chart || null);
              },
              { once: true },
            );
            existing.addEventListener(
              'error',
              () => {
                existing.dataset.chartjsState = 'error';
                resolve(null);
              },
              { once: true },
            );

            if (existing.readyState === 'complete') {
              waitForChart(resolve);
            }
            return;
          }

          const script = document.createElement('script');
          script.src = chartJsUrl;
          script.async = true;
          script.dataset.chartjs = 'true';
          script.dataset.chartjsState = 'loading';
          script.addEventListener(
            'load',
            () => {
              script.dataset.chartjsState = 'loaded';
              resolve(window.Chart || null);
            },
            { once: true },
          );
          script.addEventListener(
            'error',
            () => {
              script.dataset.chartjsState = 'error';
              resolve(null);
            },
            { once: true },
          );
          document.head.appendChild(script);
        });
      };

      const chartDataUrl = new URL(
        '{% url "admin:pages_viewhistory_traffic_data" %}',
        window.location,
      );
      chartDataUrl.searchParams.set('days', '7');

      const fetchData = () =>
        fetch(chartDataUrl.toString(), {
          headers: { Accept: 'application/json' },
        }).then((response) => (response.ok ? response.json() : Promise.reject()));

      ensureChartJs()
        .then((Chart) => {
          if (!Chart) {
            throw new Error('chartjs');
          }
          return fetchData().then((data) => ({ Chart, data }));
        })
        .then(({ Chart, data }) => {
          if (!data || !Array.isArray(data.datasets) || !data.datasets.length) {
            canvas.hidden = true;
            if (emptyLabel) {
              emptyLabel.hidden = false;
              emptyLabel.textContent = '{% translate "No visit data yet." %}';
            }
            return;
          }

          if (emptyLabel) {
            emptyLabel.hidden = true;
          }
          canvas.hidden = false;
          const context = canvas.getContext('2d');
          new Chart(context, {
            type: 'line',
            data: {
              labels: data.labels,
              datasets: data.datasets.map((dataset) => ({
                ...dataset,
                pointRadius: 0,
                pointHoverRadius: 3,
                borderWidth: 2,
              })),
            },
            options: {
              animation: false,
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  mode: 'nearest',
                  intersect: false,
                },
              },
              elements: {
                line: { tension: 0.3 },
              },
              scales: {
                x: { display: false },
                y: { display: false, beginAtZero: true },
              },
            },
          });
        })
        .catch(() => {
          canvas.hidden = true;
          if (emptyLabel) {
            emptyLabel.hidden = false;
            emptyLabel.textContent = '{% translate "Unable to load visit data at this time." %}';
          }
        });
    };

    const scheduleMiniTrafficChart = () => {
      const startChart = () => {
        initializeMiniTrafficChart();
      };

      if (window.requestIdleCallback) {
        window.requestIdleCallback(startChart, { timeout: 1000 });
        return;
      }

      window.setTimeout(startChart, 0);
    };

    window.addEventListener('load', scheduleMiniTrafficChart);
  </script>
  <script>
    (function () {
      const renderStatusFallback = (loader, template) => {
        if (!loader || !template) {
          return;
        }

        const content = template.content
          ? template.content.cloneNode(true)
          : template.cloneNode(true);

        if (!content) {
          return;
        }

        loader.replaceChildren(content);
      };

      const configureStatusLoaders = () => {
        const loaders = document.querySelectorAll('[data-model-status-loader]');
        if (!loaders.length) {
          return;
        }

        loaders.forEach((loader) => {
          const fallbackId = loader.dataset.fallbackTemplate;
          if (!fallbackId) {
            return;
          }

          const fallbackTemplate = document.getElementById(fallbackId);

          const render = () => renderStatusFallback(loader, fallbackTemplate);

          if (!window.htmx) {
            render();
            return;
          }

          htmx.on(loader, 'htmx:responseError', render);
          htmx.on(loader, 'htmx:sendError', render);
          htmx.on(loader, 'htmx:timeout', render);
        });
      };

      document.addEventListener('DOMContentLoaded', () => {
        configureStatusLoaders();
      });
    })();
  </script>
{% endblock %}
