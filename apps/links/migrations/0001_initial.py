# Generated by ChatGPT

import uuid

import apps.core.entity
import apps.links.models
from django.conf import settings
from django.db import migrations, models


def move_reference_content_type_forward(apps, schema_editor):
    ContentType = apps.get_model("contenttypes", "ContentType")

    core_types = list(
        ContentType.objects.filter(app_label="core", model="reference").order_by("pk")
    )
    links_type = ContentType.objects.filter(app_label="links", model="reference").first()

    target = links_type or (core_types[0] if core_types else None)
    if target is None:
        return

    if target.app_label != "links":
        target.app_label = "links"
        target.save(update_fields=["app_label"])

    for content_type in core_types:
        if content_type.pk == target.pk:
            continue
        content_type.delete()

    if links_type and links_type.pk != target.pk:
        links_type.delete()


def move_reference_content_type_backward(apps, schema_editor):
    ContentType = apps.get_model("contenttypes", "ContentType")

    links_types = list(
        ContentType.objects.filter(app_label="links", model="reference").order_by("pk")
    )
    target = links_types[0] if links_types else None
    if target is None:
        return

    target.app_label = "core"
    target.save(update_fields=["app_label"])

    for content_type in links_types[1:]:
        content_type.delete()


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ("core", "0002_initial"),
        ("nodes", "0001_initial"),
        ("sites", "0002_alter_domain_unique"),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.SeparateDatabaseAndState(
            database_operations=[],
            state_operations=[
                migrations.CreateModel(
                    name="Reference",
                    fields=[
                        (
                            "id",
                            models.BigAutoField(
                                auto_created=True,
                                primary_key=True,
                                serialize=False,
                                verbose_name="ID",
                            ),
                        ),
                        ("is_seed_data", models.BooleanField(default=False, editable=False)),
                        ("is_user_data", models.BooleanField(default=False, editable=False)),
                        ("is_deleted", models.BooleanField(default=False, editable=False)),
                        (
                            "content_type",
                            models.CharField(
                                choices=[("text", "Text"), ("image", "Image")],
                                default="text",
                                max_length=5,
                            ),
                        ),
                        (
                            "alt_text",
                            models.CharField(max_length=500, verbose_name="Title / Alt Text"),
                        ),
                        ("value", models.TextField(blank=True)),
                        ("file", models.FileField(blank=True, upload_to="refs/")),
                        ("image", models.ImageField(blank=True, upload_to="refs/qr/")),
                        ("uses", models.PositiveIntegerField(default=0)),
                        ("method", models.CharField(default="qr", max_length=50)),
                        (
                            "validated_url_at",
                            models.DateTimeField(
                                blank=True,
                                help_text="Timestamp of the last URL validation check.",
                                null=True,
                                verbose_name="Validated URL",
                            ),
                        ),
                        (
                            "validation_status",
                            models.IntegerField(
                                blank=True,
                                help_text="HTTP status code from the last URL validation attempt.",
                                null=True,
                                verbose_name="Validation Status",
                            ),
                        ),
                        (
                            "include_in_footer",
                            models.BooleanField(
                                default=False, verbose_name="Include in Footer"
                            ),
                        ),
                        (
                            "show_in_header",
                            models.BooleanField(
                                default=False, verbose_name="Show in Header"
                            ),
                        ),
                        (
                            "footer_visibility",
                            models.CharField(
                                choices=[
                                    ("public", "Public"),
                                    ("private", "Private"),
                                    ("staff", "Staff"),
                                ],
                                default="public",
                                max_length=7,
                                verbose_name="Footer Visibility",
                            ),
                        ),
                        (
                            "transaction_uuid",
                            models.UUIDField(
                                db_index=True,
                                default=uuid.uuid4,
                                verbose_name="Transaction UUID",
                            ),
                        ),
                        ("created", models.DateTimeField(auto_now_add=True)),
                        (
                            "author",
                            models.ForeignKey(
                                blank=True,
                                null=True,
                                on_delete=models.deletion.CASCADE,
                                related_name="references",
                                to=settings.AUTH_USER_MODEL,
                            ),
                        ),
                        (
                            "features",
                            models.ManyToManyField(
                                blank=True, related_name="references", to="nodes.nodefeature"
                            ),
                        ),
                        (
                            "roles",
                            models.ManyToManyField(
                                blank=True, related_name="references", to="nodes.noderole"
                            ),
                        ),
                        (
                            "sites",
                            models.ManyToManyField(
                                blank=True, related_name="references", to="sites.site"
                            ),
                        ),
                    ],
                    options={
                        "db_table": "core_reference",
                        "verbose_name": "Reference",
                        "verbose_name_plural": "References",
                    },
                    bases=(apps.core.entity.Entity,),
                    managers=[
                        ("objects", apps.links.models.ReferenceManager()),
                    ],
                ),
            ],
        ),
        migrations.RunPython(
            move_reference_content_type_forward,
            reverse_code=move_reference_content_type_backward,
        ),
    ]
