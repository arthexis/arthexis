# Generated by Django 5.2.8 on 2025-11-30 19:03

from django.db import migrations


def migrate_payment_processors(apps, schema_editor):
    old_model = apps.get_model("core", "OpenPayProfile")
    openpay_model = apps.get_model("payments", "OpenPayProcessor")
    paypal_model = apps.get_model("payments", "PayPalProcessor")
    stripe_model = apps.get_model("payments", "StripeProcessor")

    manager = getattr(old_model, "all_objects", old_model.objects)
    for profile in manager.all():
        base_kwargs = {
            "id": profile.id,
            "user_id": profile.user_id,
            "group_id": profile.group_id,
            "is_seed_data": profile.is_seed_data,
            "is_user_data": profile.is_user_data,
            "is_deleted": profile.is_deleted,
        }
        default_processor = profile.default_processor or profile.PROCESSOR_OPENPAY

        def verification_for(processor):
            if processor != default_processor:
                return {"verified_on": None, "verification_reference": ""}
            return {
                "verified_on": profile.verified_on,
                "verification_reference": profile.verification_reference or "",
            }

        if profile.merchant_id and profile.private_key and profile.public_key:
            openpay_defaults = {
                **base_kwargs,
                "merchant_id": profile.merchant_id,
                "private_key": profile.private_key,
                "public_key": profile.public_key,
                "is_production": profile.is_production,
                "webhook_secret": profile.webhook_secret,
                "is_default": default_processor == profile.PROCESSOR_OPENPAY,
                **verification_for(profile.PROCESSOR_OPENPAY),
            }
            openpay_model.objects.update_or_create(
                pk=profile.pk, defaults=openpay_defaults
            )

        if profile.paypal_client_id and profile.paypal_client_secret:
            paypal_defaults = {
                **base_kwargs,
                "client_id": profile.paypal_client_id,
                "client_secret": profile.paypal_client_secret,
                "webhook_id": profile.paypal_webhook_id,
                "is_production": profile.paypal_is_production,
                "is_default": default_processor == profile.PROCESSOR_PAYPAL,
                **verification_for(profile.PROCESSOR_PAYPAL),
            }
            paypal_model.objects.update_or_create(pk=profile.pk, defaults=paypal_defaults)

        if profile.stripe_secret_key and profile.stripe_publishable_key:
            stripe_defaults = {
                **base_kwargs,
                "secret_key": profile.stripe_secret_key,
                "publishable_key": profile.stripe_publishable_key,
                "webhook_secret": profile.stripe_webhook_secret,
                "is_production": profile.stripe_is_production,
                "is_default": default_processor == profile.PROCESSOR_STRIPE,
                **verification_for(profile.PROCESSOR_STRIPE),
            }
            stripe_model.objects.update_or_create(pk=profile.pk, defaults=stripe_defaults)


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0004_initial"),
        ("payments", "0001_initial"),
    ]

    operations = [
        migrations.RunPython(migrate_payment_processors, migrations.RunPython.noop),
        migrations.DeleteModel(
            name="OpenPayProfile",
        ),
    ]
