{% extends "admin/base_site.html" %}
{% load i18n %}

{% block breadcrumbs %}
<div class="breadcrumbs">
  <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
  &rsaquo; <a href="{% url 'admin:system' %}">{% trans 'System' %}</a>
  &rsaquo; {% trans "Upgrade Report" %}
</div>
{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
  .upgrade-report .upgrade-report-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  .upgrade-report .upgrade-report-header h2 {
    margin: 0;
  }

  .upgrade-report .upgrade-report-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(16rem, 1fr));
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .upgrade-report .upgrade-summary-card {
    border: 1px solid var(--border-color, #e0e0e0);
    border-radius: 4px;
    padding: 0.75rem 1rem;
    background: #fff;
  }

  .upgrade-report .upgrade-summary-card h4 {
    margin: 0 0 0.35rem 0;
    font-size: 0.95rem;
    text-transform: uppercase;
    letter-spacing: 0.02em;
  }

  .upgrade-report .upgrade-summary-value {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0;
    word-break: break-word;
  }

  .upgrade-report .upgrade-status-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.35rem 0.65rem;
    border-radius: 9999px;
    font-weight: 600;
    font-size: 0.95rem;
  }

  .upgrade-report .state-ok {
    background: #e6f4ea;
    color: #0d652d;
  }

  .upgrade-report .state-warning {
    background: #fef3c7;
    color: #92400e;
  }

  .upgrade-report .state-error {
    background: #fee2e2;
    color: #991b1b;
  }

  .upgrade-report .upgrade-issues {
    margin: 0.25rem 0 0;
    padding-left: 1.25rem;
  }

  .upgrade-report .upgrade-issues li {
    margin: 0.15rem 0;
  }

  .upgrade-report .upgrade-report-actions {
    display: flex;
    flex-wrap: wrap;
    align-items: stretch;
    gap: 0.5rem;
    justify-content: flex-end;
  }

  .upgrade-report .upgrade-action-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 1.25rem;
    gap: 0.375rem;
    min-height: 2.5rem;
    flex: 1 1 8rem;
  }

  .upgrade-report .upgrade-report-action-group {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin: 0;
  }

  .upgrade-report .upgrade-report-action-group form {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .upgrade-report .precheck-button {
    flex: 0 0 auto;
  }
</style>
{% endblock %}

{% block content %}
<div id="content-main">
  <div class="module upgrade-report">
    <div class="upgrade-report-header">
      <h2>{% trans "Upgrade Report" %}</h2>
      <div class="upgrade-report-actions">
        <div class="upgrade-report-action-group">
          <form method="post" action="{% url 'admin:system-upgrade-run-check' %}" class="upgrade-report-trigger">
            {% csrf_token %}
            {% if report.settings.is_stable_mode %}
            {% blocktrans trimmed asvar unstable_confirm_message %}
              This node is configured for stable updates. Continue with an unstable upgrade?
            {% endblocktrans %}
            {% endif %}
            <div class="upgrade-report-action-group">
              <button
                type="submit"
                name="channel"
                value="unstable"
                class="button default upgrade-action-button"
                {% if report.settings.is_stable_mode %}
                onclick="return confirm('{{ unstable_confirm_message|escapejs }}');"
                {% endif %}
              >
                {% trans "Upgrade Immediately (Unstable)" %}
              </button>
              <button
                type="submit"
                name="channel"
                value="stable"
                class="button upgrade-action-button"
              >
                {% trans "Upgrade on Next Release (Stable)" %}
              </button>
            </div>
          </form>
        </div>
        <div class="upgrade-report-action-group">
          <form method="post" action="{% url 'admin:system-upgrade-check-revision' %}">
            {% csrf_token %}
            <button type="submit" class="button upgrade-action-button precheck-button">
              {% trans "Pre-Upgrade Checks" %}
            </button>
          </form>
        </div>
      </div>
    </div>
    {% with report=auto_upgrade_report %}
    <div class="upgrade-report-summary">
      <div class="upgrade-summary-card">
        <h4>{% trans "Overall status" %}</h4>
        <p class="upgrade-summary-value">
          <span class="upgrade-status-chip state-{{ report.summary.state }}">
            {{ report.summary.headline }}
          </span>
        </p>
        {% if report.summary.issues %}
          <ul class="upgrade-issues">
            {% for issue in report.summary.issues %}
            <li class="state-{{ issue.severity }}">{{ issue.label }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="help">{% trans "No outstanding issues detected." %}</p>
        {% endif %}
      </div>
      <div class="upgrade-summary-card">
        <h4>{% trans "Current channel" %}</h4>
        <p class="upgrade-summary-value"><code>{{ report.settings.channel }}</code></p>
        {% if report.settings.raw_mode and report.settings.raw_mode|lower != report.settings.channel %}
          <p class="help">{% blocktrans %}Legacy mode value: {{ report.settings.raw_mode }}{% endblocktrans %}</p>
        {% endif %}
      </div>
      <div class="upgrade-summary-card">
        <h4>{% trans "Next scheduled run" %}</h4>
        <p class="upgrade-summary-value">
          {% if report.summary.next_run %}
            {{ report.summary.next_run }}
          {% else %}
            <em>{% trans "Not scheduled" %}</em>
          {% endif %}
        </p>
        {% if report.schedule.description %}
          <p class="help">{{ report.schedule.description }}</p>
        {% endif %}
      </div>
      <div class="upgrade-summary-card">
        <h4>{% trans "Last activity" %}</h4>
        {% if report.summary.last_activity.message %}
          <p class="upgrade-summary-value">
            <code>{{ report.summary.last_activity.message }}</code>
          </p>
          <p class="help">{{ report.summary.last_activity.timestamp|default:"" }}</p>
        {% else %}
          <p class="upgrade-summary-value"><em>{% trans "No activity recorded yet." %}</em></p>
        {% endif %}
      </div>
    </div>
    <div class="upgrade-report-section">
      <h3>{% trans "Settings" %}</h3>
      <dl>
        <dt>{% trans "Auto-upgrade status" %}</dt>
        <dd>
          {% if report.settings.enabled %}
            {% if report.settings.is_unstable_mode %}
              {% trans "Enabled (tracking the unstable channel)" %}
            {% elif report.settings.is_stable_mode %}
              {% trans "Enabled (tracking the stable release channel)" %}
            {% else %}
              {% blocktrans %}Enabled (mode "{{ report.settings.mode }}"){% endblocktrans %}
            {% endif %}
          {% else %}
            {% if report.settings.lock_exists %}
              {% trans "Disabled (mode file present but unreadable)" %}
            {% else %}
              {% trans "Disabled" %}
            {% endif %}
          {% endif %}
        </dd>
        <dt>{% trans "Channel" %}</dt>
        <dd>
          <code>{{ report.settings.channel }}</code>
          {% if report.settings.raw_mode and report.settings.raw_mode|lower != report.settings.channel %}
            <p class="help">{% blocktrans %}Legacy mode value: {{ report.settings.raw_mode }}{% endblocktrans %}</p>
          {% endif %}
        </dd>
        <dt>{% trans "Local revision" %}</dt>
        <dd>
          {% if report.settings.local_revision %}
            <code>{{ report.settings.local_revision }}</code>
          {% else %}
            <em>{% trans "Unavailable" %}</em>
          {% endif %}
        </dd>
        <dt>{% trans "Origin revision" %}</dt>
        <dd>
          {% if report.settings.origin_revision %}
            <code>{{ report.settings.origin_revision }}</code>
          {% else %}
            <em>{% trans "Unavailable" %}</em>
          {% endif %}
          {% if report.settings.origin_revision_error %}
            <p class="errornote">{{ report.settings.origin_revision_error }}</p>
          {% endif %}
        </dd>
        <dt>{% trans "Revision checks" %}</dt>
        <dd>
          {% if report.settings.revision_checked_label %}
            <p class="help">{% blocktrans %}Last checked {{ report.settings.revision_checked_label }}.{% endblocktrans %}</p>
          {% else %}
            <p class="help">{% trans "Run Pre-Upgrade Checks to refresh revision details." %}</p>
          {% endif %}
        </dd>
        <dt>{% trans "CI status" %}</dt>
        <dd>
          {% if report.settings.ci_status %}
            <code>{{ report.settings.ci_status }}</code>
          {% else %}
            <em>{% trans "Unavailable" %}</em>
          {% endif %}
          {% if not report.settings.revision_checked_label %}
            <p class="help">{% trans "Run Pre-Upgrade Checks to retrieve the current CI status." %}</p>
          {% endif %}
        </dd>
        <dt>{% trans "Task" %}</dt>
        <dd>
          <code>{{ report.settings.task_name }}</code>
          {% if report.schedule.task_admin_url %}
            [ <a href="{{ report.schedule.task_admin_url }}">{% trans "View" %}</a> ]
          {% endif %}
          {% if report.settings.task_path %}
            â€” <code>{{ report.settings.task_path }}</code>
          {% endif %}
        </dd>
        <dt>{% trans "Log file" %}</dt>
        <dd><code>{{ report.settings.log_path }}</code></dd>
        <dt>{% trans "Suite uptime" %}</dt>
        <dd>
          {% if report.settings.suite_uptime %}
            {{ report.settings.suite_uptime }}
          {% else %}
            <em>{% trans "Unavailable" %}</em>
          {% endif %}
        </dd>
        <dt>{% trans "Blocked revisions" %}</dt>
        <dd>
          {% if report.settings.skip_revisions %}
          <ul>
            {% for revision in report.settings.skip_revisions %}
            <li><code>{{ revision }}</code></li>
            {% endfor %}
          </ul>
          {% else %}
          <em>{% trans "No revisions are currently blocked." %}</em>
          {% endif %}
        </dd>
      </dl>
      {% if report.settings.read_error %}
        <p class="errornote">{% trans "The auto-upgrade mode could not be read; verify the lock file permissions." %}</p>
      {% endif %}
    </div>
    <div class="upgrade-report-section">
      <h3>{% trans "Schedule" %}</h3>
      {% if report.schedule.available %}
        {% if report.schedule.configured %}
        <table class="table table-striped">
          <tbody>
            <tr>
              <th scope="row">{% trans "Enabled" %}</th>
              <td>
                {% if report.schedule.enabled %}
                  {% trans "Yes" %}
                {% else %}
                  {% trans "No" %}
                {% endif %}
              </td>
            </tr>
            <tr>
              <th scope="row">{% trans "One-off" %}</th>
              <td>
                {% if report.schedule.one_off %}
                  {% trans "Yes" %}
                {% else %}
                  {% trans "No" %}
                {% endif %}
              </td>
            </tr>
            <tr>
              <th scope="row">{% trans "Queue" %}</th>
              <td>{{ report.schedule.queue|default:"" }}</td>
            </tr>
            <tr>
              <th scope="row">{% trans "Schedule" %}</th>
              <td>
                {{ report.schedule.schedule|default:"" }}
                {% if report.schedule.config_admin_url %}
                  [ <a href="{{ report.schedule.config_admin_url }}">{% trans "View" %}</a> ]
                {% endif %}
              </td>
            </tr>
            <tr>
              <th scope="row">{% trans "Next run" %}</th>
              <td>{{ report.schedule.next_run|default:"" }}</td>
            </tr>
            <tr>
              <th scope="row">{% trans "Last run" %}</th>
              <td>{{ report.schedule.last_run_at|default:"" }}</td>
            </tr>
            <tr>
              <th scope="row">{% trans "Start time" %}</th>
              <td>{{ report.schedule.start_time|default:"" }}</td>
            </tr>
            <tr>
              <th scope="row">{% trans "Expires" %}</th>
              <td>{{ report.schedule.expires|default:"" }}</td>
            </tr>
            <tr>
              <th scope="row">{% trans "Run count" %}</th>
              <td>{{ report.schedule.total_run_count }}</td>
            </tr>
            <tr>
              <th scope="row">{% trans "Failure count" %}</th>
              <td>{{ report.schedule.failure_count }}</td>
            </tr>
            {% if report.schedule.description %}
            <tr>
              <th scope="row">{% trans "Description" %}</th>
              <td>{{ report.schedule.description }}</td>
            </tr>
            {% endif %}
          </tbody>
        </table>
        {% else %}
          <p class="help">{% trans "The auto-upgrade periodic task has not been created yet." %}</p>
        {% endif %}
      {% else %}
        {% if report.schedule.error %}
          <p class="help">{{ report.schedule.error }}</p>
        {% else %}
          <p class="help">{% trans "Scheduling information is unavailable." %}</p>
        {% endif %}
      {% endif %}
    </div>
    <div class="upgrade-report-section">
      <h3>{% trans "Recent activity" %}</h3>
      {% if report.log_entries %}
      <table class="table table-striped">
        <thead>
          <tr>
            <th scope="col">{% trans "Timestamp" %}</th>
            <th scope="col">{% trans "Message" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for entry in report.log_entries %}
          <tr>
            <td>{{ entry.timestamp|default:"" }}</td>
            <td><code>{{ entry.message }}</code></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <p class="help">{% trans "No auto-upgrade activity has been recorded yet." %}</p>
      {% endif %}
      {% if report.log_error %}
        <p class="errornote">{{ report.log_error }}</p>
      {% endif %}
    </div>
    {% endwith %}
  </div>
</div>
{% endblock %}
