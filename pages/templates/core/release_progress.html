{% extends "admin/base_site.html" %}
{% load i18n %}

{% block extrastyle %}
{{ block.super }}
<style>
  .todo-item { position: relative; }
  .todo-item .todo-details {
    display: none;
    position: absolute;
    left: 0;
    top: 100%;
    background: var(--body-bg);
    border: 1px solid var(--hairline-color);
    padding: 8px;
    z-index: 1000;
    width: 200px;
  }
  .todo-item:hover .todo-details { display: block; }
</style>
{% endblock %}

{% block nav-breadcrumbs %}
<nav aria-label="{% translate 'Breadcrumbs' %}">
  <div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a> ‚Ä∫
    <a href="{% url 'admin:app_list' 'core' %}">{% trans '2. Business' %}</a> ‚Ä∫
    <a href="{% url 'admin:core_packagerelease_changelist' %}">{% trans 'Package Releases' %}</a> ‚Ä∫
    <a href="{% url 'admin:core_packagerelease_change' release.pk %}">{{ release }}</a> ‚Ä∫
    {{ action|capfirst }}
  </div>
</nav>
{% endblock %}

{% block content %}
<h1>{{ action|capfirst }} {{ release.package.name }} {{ release.version }}</h1>
<div>
  {% if not started %}
  <form method="get" style="display:inline;">
    <input type="hidden" name="step" value="0">
    <button type="submit" name="start" value="1">‚ñ∂Ô∏è {% trans 'Start Publish' %}</button>
  </form>
  {% endif %}
  <form method="get" style="display:inline;">
    <button type="submit" name="abort" value="1" {% if not started %}disabled{% endif %}>‚èπÔ∏è {% trans 'Stop Publish' %}</button>
  </form>
  {% if started %}
  <form method="get" style="display:inline;">
    <button type="submit" name="restart" value="1">üîÑ {% trans 'Restart Publish' %}</button>
  </form>
  {% endif %}
</div>
<ol>
{% for step in steps %}
  <li>{% if forloop.counter0 < current_step %}‚úÖ{% elif forloop.counter0 == current_step and not done and not error %}‚è≥{% else %}‚¨ú{% endif %} {{ step }}</li>
{% endfor %}
</ol>
{% if fixtures %}
<h2>{% trans 'Fixture changes' %}</h2>
<table>
  <thead>
    <tr>
      <th>{% trans 'Fixture' %}</th>
      <th>{% trans 'Entries' %}</th>
      <th>{% trans 'Models' %}</th>
    </tr>
  </thead>
  <tbody>
  {% for fx in fixtures %}
    <tr>
      <td>{{ fx.path }}</td>
      <td>{{ fx.count }}</td>
      <td>{{ fx.models|join:', ' }}</td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% endif %}
<pre>{{ log_content }}</pre>
{% if todos %}
<h2>{% trans 'Pending TODOs' %}</h2>
<form method="get">
  <input type="hidden" name="step" value="{{ current_step }}">
  <ul>
  {% for todo in todos %}
  <li class="todo-item">
    <label>
      <input type="checkbox" class="todo-check">
      {% if todo.url %}
      <a href="{{ todo.url }}" target="_blank" rel="noopener" class="todo-link">{{ todo.request }}</a>
      {% else %}
      {{ todo.request }}
      {% endif %}
    </label>
    {% if todo.request_details %}
    <div class="todo-details">{{ todo.request_details }}</div>
    {% endif %}
  </li>
  {% endfor %}
  </ul>
  <button type="submit" name="ack_todos" value="1" id="continue-btn" disabled>{% trans 'Continue' %}</button>
</form>
<script>
  const btn = document.getElementById('continue-btn');
  const checks = document.querySelectorAll('.todo-check');
  function updateBtn(){ btn.disabled = !Array.from(checks).every(c=>c.checked); }
  checks.forEach(c=>c.addEventListener('change', updateBtn));
  updateBtn();
</script>
{% endif %}
{% if error %}
<p class="error">{{ error }}</p>
{% elif not done %}
{% if started and next_step is not None %}
<meta http-equiv="refresh" content="1; url={{ request.path }}?step={{ next_step }}">
{% endif %}
{% if started %}
<p>Running...</p>
{% else %}
<p>{% trans 'Waiting to start' %}</p>
{% endif %}
{% else %}
<p>All steps completed.</p>
{% if release.pypi_url %}
<p><a href="{{ release.pypi_url }}" target="_blank" rel="noopener">{{ release.pypi_url }}</a></p>
{% endif %}
<div>
  <input type="text" id="logpath" value="{{ log_path }}" readonly>
  <button type="button" onclick="navigator.clipboard.writeText(document.getElementById('logpath').value)">Copy log path</button>
</div>
{% if cert_log %}
<p>Certification logged in {{ cert_log }}</p>
{% endif %}
{% endif %}
<p>{% trans 'Restarts' %}: {{ restart_count }}</p>
{% endblock %}

