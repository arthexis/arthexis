{% extends "pages/base.html" %}
{% load i18n %}

{% block title %}{% trans "Login" %}{% endblock %}

{% block content %}
<div class="d-flex justify-content-center">
  <div class="card p-4" style="max-width: 400px; width: 100%;">
    <h1 class="text-center mb-4">{% trans "Login" %}</h1>
    {% with current_method=form.auth_method.value|default:'password' %}
    <form method="post" novalidate data-auth-form>
      {% csrf_token %}
      {% if form.non_field_errors %}
      <div class="alert alert-danger" role="alert">
        {% for error in form.non_field_errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
      </div>
      {% endif %}
      <div class="mb-3">
        <label for="{{ form.username.id_for_label }}" class="form-label">{{ form.username.label }}</label>
        <input
          type="text"
          name="{{ form.username.html_name }}"
          class="form-control{% if form.username.errors %} is-invalid{% endif %}"
          id="{{ form.username.id_for_label }}"
          value="{{ form.username.value|default_if_none:'' }}"
          autocomplete="username"
          required
          autofocus
        >
        {% for error in form.username.errors %}
        <div class="invalid-feedback">{{ error }}</div>
        {% endfor %}
      </div>
      {{ form.auth_method }}
      <div class="mb-3{% if current_method == 'otp' %} d-none{% endif %}" data-password-group>
        <label for="{{ form.password.id_for_label }}" class="form-label">{{ form.password.label }}</label>
        <input
          type="password"
          name="{{ form.password.html_name }}"
          class="form-control{% if form.password.errors %} is-invalid{% endif %}"
          id="{{ form.password.id_for_label }}"
          autocomplete="current-password"
          {% if current_method != 'otp' %}required{% endif %}
        >
        {% for error in form.password.errors %}
        <div class="invalid-feedback">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="mb-3{% if current_method != 'otp' %} d-none{% endif %}" data-otp-group>
        <label for="{{ form.otp_token.id_for_label }}" class="form-label">{{ form.otp_token.label }}</label>
        <input
          type="text"
          name="{{ form.otp_token.html_name }}"
          class="form-control{% if form.otp_token.errors %} is-invalid{% endif %}"
          id="{{ form.otp_token.id_for_label }}"
          value="{{ form.otp_token.value|default_if_none:'' }}"
          inputmode="numeric"
          pattern="[0-9]*"
          autocomplete="one-time-code"
          {% if current_method == 'otp' %}required{% endif %}
        >
        {% for error in form.otp_token.errors %}
        <div class="invalid-feedback">{{ error }}</div>
        {% endfor %}
        <div class="form-text">{% trans "Enter the code from your authenticator app." %}</div>
      </div>
      {% if next %}<input type="hidden" name="next" value="{{ next }}">{% endif %}
      <button type="submit" class="btn btn-primary w-100">{% trans "Log in" %}</button>
    </form>
    <div class="mt-3 text-center">
      <a
        href="#"
        data-auth-toggle
        data-password-label="{% trans "Use Password" %}"
        data-otp-label="{% trans "Use Authenticator app" %}"
      >
        {% if current_method == 'otp' %}{% trans "Use Password" %}{% else %}{% trans "Use Authenticator app" %}{% endif %}
      </a>
    </div>
    {% endwith %}
    {% if can_request_invite %}
    <div class="mt-3 text-center">
      <a href="{% url 'pages:request-invite' %}">{% trans "Request email invitation" %}</a>
    </div>
    {% endif %}
  </div>
</div>
<script>
(function () {
  const form = document.querySelector('[data-auth-form]');
  const toggle = document.querySelector('[data-auth-toggle]');
  if (!form || !toggle) {
    return;
  }
  const passwordGroup = form.querySelector('[data-password-group]');
  const otpGroup = form.querySelector('[data-otp-group]');
  const authMethodField = form.querySelector('input[name="{{ form.auth_method.html_name }}"]');
  const passwordInput = form.querySelector('#{{ form.password.id_for_label }}');
  const otpInput = form.querySelector('#{{ form.otp_token.id_for_label }}');
  const passwordLabel = toggle.getAttribute('data-password-label');
  const otpLabel = toggle.getAttribute('data-otp-label');

  const setMode = (mode) => {
    if (!authMethodField) {
      return;
    }
    authMethodField.value = mode;
    if (mode === 'otp') {
      passwordGroup?.classList.add('d-none');
      otpGroup?.classList.remove('d-none');
      passwordInput?.removeAttribute('required');
      if (otpInput) {
        otpInput.setAttribute('required', 'required');
        otpInput.focus();
      }
      toggle.textContent = passwordLabel;
    } else {
      passwordGroup?.classList.remove('d-none');
      otpGroup?.classList.add('d-none');
      otpInput?.removeAttribute('required');
      if (passwordInput) {
        passwordInput.setAttribute('required', 'required');
        passwordInput.focus();
      }
      toggle.textContent = otpLabel;
    }
  };

  toggle.addEventListener('click', (event) => {
    event.preventDefault();
    const nextMode = authMethodField && authMethodField.value === 'otp' ? 'password' : 'otp';
    setMode(nextMode);
  });

  const initialMode = authMethodField && authMethodField.value === 'otp' ? 'otp' : 'password';
  setMode(initialMode);
})();
</script>
{% endblock %}
