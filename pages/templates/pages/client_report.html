{% extends "pages/base.html" %}
{% load i18n tz %}
{% block content %}
<h1>{% trans "Client Report" %}</h1>
{% if download_url %}
  <div class="notification success auto-download" role="status">
    {% trans "Consumer report generated. If the download does not start automatically," %}
    <a href="{{ download_url }}">{% trans "click here to download it." %}</a>
  </div>
  <iframe
    src="{{ download_url }}"
    title="{% trans "Consumer report download" %}"
    class="report-download-frame"
    aria-hidden="true"
  ></iframe>
{% endif %}
{% if report %}
  <section class="report-results" id="client-report-results">
    <h2>{% blocktrans with start=report.start_date end=report.end_date %}Report from {{ start }} to {{ end }}{% endblocktrans %}</h2>
    {% with data=report.rows_for_display %}
      {% if data.schema == "evcs-session/v1" %}
        {% if data.evcs %}
          {% for evcs in data.evcs %}
            <article class="client-report-evcs">
              <header class="client-report-evcs__header">
                <h3 class="client-report-evcs__title">
                  {{ evcs.display_name }}
                  {% if evcs.serial_number %}
                    <small class="client-report-evcs__serial">({% trans "Serial" %}: {{ evcs.serial_number }})</small>
                  {% endif %}
                </h3>
                <p class="client-report-evcs__summary">
                  {% trans "Total kW (all time)" %}: {{ evcs.total_kw|floatformat:2 }} ·
                  {% trans "Total kW (period)" %}: {{ evcs.total_kw_period|floatformat:2 }}
                </p>
              </header>
              {% if evcs.transactions %}
                <table class="client-report-table">
                  <thead>
                    <tr>
                      <th scope="col">{% trans "Connector" %}</th>
                      <th scope="col">{% trans "Start kWh" %}</th>
                      <th scope="col">{% trans "End kWh" %}</th>
                      <th scope="col">{% trans "Session kWh" %}</th>
                      <th scope="col">{% trans "Session start" %}</th>
                      <th scope="col">{% trans "Session end" %}</th>
                      <th scope="col">{% trans "RFID label" %}</th>
                      <th scope="col">{% trans "Account" %}</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in evcs.transactions %}
                      <tr>
                        <td data-label="{% trans "Connector" %}">
                          {% if row.connector is not None %}{{ row.connector }}{% else %}&mdash;{% endif %}
                        </td>
                        <td data-label="{% trans "Start kWh" %}">
                          {% if row.start_kwh is not None %}{{ row.start_kwh|floatformat:2 }}{% else %}&mdash;{% endif %}
                        </td>
                        <td data-label="{% trans "End kWh" %}">
                          {% if row.end_kwh is not None %}{{ row.end_kwh|floatformat:2 }}{% else %}&mdash;{% endif %}
                        </td>
                        <td data-label="{% trans "Session kWh" %}">{{ row.session_kwh|floatformat:2 }}</td>
                        <td data-label="{% trans "Session start" %}">
                          {% if row.start %}
                            <time datetime="{{ row.start|date:'c' }}">{{ row.start|localtime|date:"M j, Y H:i" }}</time>
                          {% else %}&mdash;{% endif %}
                        </td>
                        <td data-label="{% trans "Session end" %}">
                          {% if row.end %}
                            <time datetime="{{ row.end|date:'c' }}">{{ row.end|localtime|date:"M j, Y H:i" }}</time>
                          {% else %}&mdash;{% endif %}
                        </td>
                        <td data-label="{% trans "RFID label" %}">{{ row.rfid_label|default:"—" }}</td>
                        <td data-label="{% trans "Account" %}">{{ row.account_name|default:"—" }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              {% else %}
                <p class="empty-state">{% trans "No charging sessions recorded for this charge point." %}</p>
              {% endif %}
            </article>
          {% endfor %}
          <div class="client-report-totals">
            <p><strong>{% trans "Report totals" %}</strong></p>
            <p>{% trans "Total kW (all time)" %}: {{ data.totals.total_kw|floatformat:2 }}</p>
            <p>{% trans "Total kW (period)" %}: {{ data.totals.total_kw_period|floatformat:2 }}</p>
          </div>
        {% else %}
          <p class="empty-state">{% trans "No charging sessions were recorded for this period." %}</p>
        {% endif %}
      {% else %}
        {% with rows=data.rows %}
          {% if rows %}
            {% with first=rows|first %}
              {% if first.start %}
                <table class="client-report-table">
                  <thead>
                    <tr>
                      <th scope="col">{% trans "RFID / Account" %}</th>
                      <th scope="col">{% trans "Session start" %}</th>
                      <th scope="col">{% trans "Session end" %}</th>
                      <th scope="col">{% trans "Energy (kWh)" %}</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in rows %}
                      <tr>
                        <td data-label="{% trans "RFID / Account" %}"><span class="report-subject">{{ row.subject }}</span></td>
                        <td data-label="{% trans "Session start" %}">
                          {% if row.start %}
                            <time datetime="{{ row.start|date:'c' }}">{{ row.start|localtime|date:"M j, Y H:i" }}</time>
                          {% else %}<span class="report-missing">{% trans "Unavailable" %}</span>{% endif %}
                        </td>
                        <td data-label="{% trans "Session end" %}">
                          {% if row.end %}
                            <time datetime="{{ row.end|date:'c' }}">{{ row.end|localtime|date:"M j, Y H:i" }}</time>
                          {% else %}<span class="report-missing">{% trans "In progress" %}</span>{% endif %}
                        </td>
                        <td data-label="{% trans "Energy (kWh)" %}">{{ row.kw|floatformat:2 }}</td>
                      </tr>
                    {% empty %}
                      <tr><td colspan="4">{% trans "No data available." %}</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              {% else %}
                <table class="client-report-table">
                  <thead>
                    <tr>
                      <th scope="col">{% trans "RFID/Account" %}</th>
                      <th scope="col">{% trans "Sessions" %}</th>
                      <th scope="col">{% trans "Total kWh" %}</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in rows %}
                      <tr>
                        <td data-label="{% trans "RFID/Account" %}">{{ row.subject }}</td>
                        <td data-label="{% trans "Sessions" %}">{{ row.count }}</td>
                        <td data-label="{% trans "Total kWh" %}">{{ row.kw|floatformat:2 }}</td>
                      </tr>
                    {% empty %}
                      <tr><td colspan="3">{% trans "No data available." %}</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              {% endif %}
            {% endwith %}
          {% else %}
            <p class="empty-state">{% trans "No data available." %}</p>
          {% endif %}
        {% endwith %}
      {% endif %}
    {% endwith %}
    {% if schedule %}
      <p class="success">{% blocktrans with freq=schedule.get_periodicity_display %}Next run scheduled ({{ freq }}){% endblocktrans %}</p>
    {% endif %}
  </section>
{% endif %}
{% if previous_reports %}
  <section class="client-report-history" aria-labelledby="client-report-history-title">
    <h2 id="client-report-history-title">{% trans "Previous reports" %}</h2>
    <table class="client-report-table history-table">
      <thead>
        <tr>
          <th scope="col">{% trans "Generated on" %}</th>
          <th scope="col">{% trans "Period" %}</th>
          <th scope="col">{% trans "Email delivery" %}</th>
          <th scope="col">{% trans "Recipients" %}</th>
          <th scope="col">{% trans "Total kW (period)" %}</th>
          <th scope="col">{% trans "Download" %}</th>
        </tr>
      </thead>
      <tbody>
        {% for item in previous_reports %}
          <tr>
            <td data-label="{% trans "Generated on" %}">
              <time datetime="{{ item.instance.created_on|date:'c' }}">{{ item.instance.created_on|localtime|date:"M j, Y H:i" }}</time>
            </td>
            <td data-label="{% trans "Period" %}">{{ item.instance.start_date }} – {{ item.instance.end_date }}</td>
            <td data-label="{% trans "Email delivery" %}">
              {% if item.email_enabled %}{% trans "Enabled" %}{% else %}{% trans "Disabled" %}{% endif %}
            </td>
            <td data-label="{% trans "Recipients" %}">
              {% if item.recipients %}
                {{ item.recipients|join:", " }}
              {% else %}
                —
              {% endif %}
            </td>
            <td data-label="{% trans "Total kW (period)" %}">{{ item.totals.total_kw_period|floatformat:2 }}</td>
            <td data-label="{% trans "Download" %}"><a href="{{ item.download_url }}">{% trans "Download" %}</a></td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
{% endif %}
{% if not request.user.is_authenticated %}
  <div class="notification warning" role="alert">
    {% if login_url %}
      {% blocktrans trimmed with login_url=login_url %}
        Please <a href="{{ login_url }}">log in</a> to generate client reports.
      {% endblocktrans %}
    {% else %}
      {% trans "Please log in to generate client reports." %}
    {% endif %}
  </div>
{% endif %}
<form method="post" id="report-form" class="client-report-form">
  {% csrf_token %}
  {% if form.non_field_errors %}
    <div class="form-errors" role="alert">
      {% for error in form.non_field_errors %}
        <p class="error">{{ error }}</p>
      {% endfor %}
    </div>
  {% endif %}
  <fieldset class="report-section" aria-describedby="id_period-help">
    <legend class="section-title">{% trans "Reporting period" %}</legend>
    <div class="form-group">
      {{ form.period.label_tag }}
      <div class="option-list">
        {{ form.period }}
      </div>
      {% if form.period.help_text %}
        <p class="help-text" id="id_period-help">{{ form.period.help_text }}</p>
      {% endif %}
    </div>
    <div class="form-grid" id="range-fields">
      <div class="form-group">
        {{ form.start.label_tag }}
        {{ form.start }}
        {% if form.start.help_text %}
          <p class="help-text" id="id_start-help">{{ form.start.help_text }}</p>
        {% endif %}
      </div>
      <div class="form-group">
        {{ form.end.label_tag }}
        {{ form.end }}
        {% if form.end.help_text %}
          <p class="help-text" id="id_end-help">{{ form.end.help_text }}</p>
        {% endif %}
      </div>
    </div>
    <div class="form-group" id="week-field">
      {{ form.week.label_tag }}
      <div class="week-input-wrapper">
        {{ form.week }}
        <button
          type="button"
          class="button button-secondary week-shortcut"
          data-week-target="{{ form.week.id_for_label }}"
        >
          {% trans "Last week" %}
        </button>
      </div>
      {% if form.week.help_text %}
        <p class="help-text" id="id_week-help">{{ form.week.help_text }}</p>
      {% endif %}
    </div>
    <div class="form-group" id="month-field">
      {{ form.month.label_tag }}
      {{ form.month }}
      {% if form.month.help_text %}
        <p class="help-text" id="id_month-help">{{ form.month.help_text }}</p>
      {% endif %}
    </div>
  </fieldset>
  <fieldset class="report-section" aria-describedby="delivery-help">
    <legend class="section-title">{% trans "Delivery and ownership" %}</legend>
    <p class="section-description" id="delivery-help">
      {% trans "Control who receives the report and how it is scheduled for delivery." %}
    </p>
    <div class="form-group">
      {{ form.owner.label_tag }}
      {{ form.owner }}
      {% if form.owner.help_text %}
        <p class="help-text" id="id_owner-help">{{ form.owner.help_text }}</p>
      {% endif %}
    </div>
    <div class="form-group">
      {{ form.destinations.label_tag }}
      {{ form.destinations }}
      {% if form.destinations.help_text %}
        <p class="help-text" id="id_destinations-help">{{ form.destinations.help_text }}</p>
      {% endif %}
    </div>
    <div class="form-group">
      {{ form.recurrence.label_tag }}
      {{ form.recurrence }}
      {% if form.recurrence.help_text %}
        <p class="help-text" id="id_recurrence-help">{{ form.recurrence.help_text }}</p>
      {% endif %}
    </div>
    <div class="form-group checkbox-group">
      <div class="checkbox-wrapper">
        {{ form.enable_emails }}
        {{ form.enable_emails.label_tag }}
      </div>
      {% if form.enable_emails.help_text %}
        <p class="help-text" id="id_enable_emails-help">{{ form.enable_emails.help_text }}</p>
      {% endif %}
    </div>
  </fieldset>
  <div class="form-actions">
    <button type="submit" class="button button-primary" id="generate-report-button"{% if not request.user.is_authenticated %} disabled aria-disabled="true"{% endif %}>
      {% trans "Generate report" %}
    </button>
  </div>
</form>
<script>
  const periodRadios = document.querySelectorAll('input[name="period"]');
  const rangeFields = document.getElementById('range-fields');
  const weekField = document.getElementById('week-field');
  const monthField = document.getElementById('month-field');

  function toggleFields() {
    const checked = document.querySelector('input[name="period"]:checked');
    const value = checked ? checked.value : 'range';
    rangeFields.style.display = value === 'range' ? 'grid' : 'none';
    weekField.style.display = value === 'week' ? 'flex' : 'none';
    monthField.style.display = value === 'month' ? 'flex' : 'none';
  }

  periodRadios.forEach((radio) => radio.addEventListener('change', toggleFields));
  toggleFields();

  const describedByMap = {
    id_start: 'id_start-help',
    id_end: 'id_end-help',
    id_week: 'id_week-help',
    id_month: 'id_month-help',
    id_owner: 'id_owner-help',
    id_destinations: 'id_destinations-help',
    id_recurrence: 'id_recurrence-help',
    id_enable_emails: 'id_enable_emails-help',
  };

  Object.entries(describedByMap).forEach(([fieldId, helpId]) => {
    const field = document.getElementById(fieldId);
    const help = document.getElementById(helpId);
    if (field && help) {
      field.setAttribute('aria-describedby', helpId);
    }
  });

  periodRadios.forEach((radio) => { 
    const help = document.getElementById('id_period-help');
    if (help) {
      radio.setAttribute('aria-describedby', 'id_period-help');
    }
  });

  function isoWeekString(date) {
    const target = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const day = target.getUTCDay() || 7;
    target.setUTCDate(target.getUTCDate() + 4 - day);
    const yearStart = new Date(Date.UTC(target.getUTCFullYear(), 0, 1));
    const week = Math.ceil(((target - yearStart) / 86400000 + 1) / 7);
    const year = target.getUTCFullYear();
    return `${year}-W${String(week).padStart(2, '0')}`;
  }

  function computeLastWeekValue() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    today.setDate(today.getDate() - 7);
    return isoWeekString(today);
  }

  document.querySelectorAll('[data-week-target]').forEach((button) => {
    const targetId = button.getAttribute('data-week-target');
    const weekInput = document.getElementById(targetId);
    if (!weekInput) {
      return;
    }
    button.addEventListener('click', () => {
      const lastWeekValue = computeLastWeekValue();
      weekInput.value = lastWeekValue;
      weekInput.dispatchEvent(new Event('input', { bubbles: true }));
      weekInput.dispatchEvent(new Event('change', { bubbles: true }));
      const weekRadio = document.querySelector('input[name="period"][value="week"]');
      if (weekRadio && !weekRadio.checked) {
        weekRadio.checked = true;
        weekRadio.dispatchEvent(new Event('change', { bubbles: true }));
      } else {
        toggleFields();
      }
      weekInput.focus();
    });
  });
</script>
<style>
  .report-results {
    margin-bottom: 2.5rem;
    padding: 1.75rem;
    border-radius: 1rem;
    background: var(--form-bg, rgba(255, 255, 255, 0.04));
    border: 1px solid var(--hairline-color, rgba(0, 0, 0, 0.1));
  }

  .report-results h2 {
    margin-top: 0;
    margin-bottom: 1.25rem;
  }

  .client-report-form {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    max-width: 48rem;
  }

  .client-report-form fieldset {
    border: 1px solid var(--hairline-color, rgba(0, 0, 0, 0.1));
    border-radius: 8px;
    padding: 0 1.5rem 1.5rem;
    background-color: var(--form-bg, rgba(255, 255, 255, 0.04));
  }

  .client-report-form .section-title {
    font-size: 1.1rem;
    font-weight: 600;
  }

  .client-report-form legend.section-title {
    display: block;
    box-sizing: border-box;
    width: calc(100% + 3rem);
    margin: 0 -1.5rem 0.75rem;
    padding: 1.25rem 1.5rem 0.75rem;
    background-color: inherit;
    border-bottom: 1px solid var(--hairline-color, rgba(0, 0, 0, 0.12));
    border-radius: 8px 8px 0 0;
  }

  .client-report-form fieldset > legend + * {
    margin-top: 0.75rem;
  }

  .client-report-form .section-description {
    margin: 0 0 1rem;
    color: var(--body-quiet-color, #6b7280);
  }

  .client-report-form .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .client-report-form .week-input-wrapper {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.75rem;
  }

  .client-report-form .week-shortcut {
    margin: 0;
  }

  .client-report-form .form-grid {
    display: grid;
    gap: 1rem;
  }

  @media (min-width: 40rem) {
    .client-report-form .form-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  .client-report-form .option-list ul,
  .client-report-form .option-list {
    margin: 0;
    padding: 0;
    list-style: none;
  }

  .notification {
    border-radius: 0.75rem;
    padding: 1rem 1.25rem;
    margin-bottom: 1.5rem;
  }

  .notification.warning {
    background-color: #fef3c7;
    color: #92400e;
  }

  .notification.success {
    background-color: #dcfce7;
    color: #166534;
  }

  .auto-download {
    margin-bottom: 1.5rem;
  }

  .report-download-frame {
    display: none;
  }

  .notification.warning a {
    color: inherit;
    font-weight: 600;
    text-decoration: underline;
  }

  .form-errors {
    border-left: 4px solid #dc2626;
    background-color: #fee2e2;
    color: #7f1d1d;
    padding: 1rem 1.25rem;
    border-radius: 0.5rem;
    margin-bottom: 1.5rem;
  }

  .form-errors .error {
    margin: 0;
  }

  .client-report-evcs {
    border: 1px solid rgba(148, 163, 184, 0.25);
    border-radius: 12px;
    padding: 1.5rem;
    background-color: rgba(15, 23, 42, 0.08);
    margin-bottom: 1.5rem;
  }

  .client-report-evcs__summary {
    margin: 0.5rem 0 0;
    color: var(--body-quiet-color, #6b7280);
  }

  .client-report-totals {
    margin-top: 1.5rem;
    border-top: 1px solid rgba(148, 163, 184, 0.3);
    padding-top: 1rem;
  }

  .client-report-history {
    margin-top: 3rem;
  }

  .history-table {
    margin-top: 1rem;
  }

  .client-report-form .help-text {
    margin: 0;
    font-size: 0.85rem;
    color: var(--body-quiet-color, #6b7280);
  }

  .client-report-form .checkbox-group {
    gap: 0.25rem;
  }

  .client-report-form .checkbox-wrapper {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .client-report-form .form-actions {
    display: flex;
    justify-content: flex-end;
  }

  #generate-report-button {
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    font-weight: 600;
    border-radius: 6px;
  }

  #generate-report-button[disabled] {
    opacity: 0.6;
    cursor: not-allowed;
  }

  @media (max-width: 40rem) {
    .client-report-form {
      gap: 1.5rem;
    }

    .client-report-form .form-actions {
      justify-content: stretch;
    }

    #generate-report-button {
      width: 100%;
    }
  }

  .client-report-table {
    width: 100%;
    border-collapse: collapse;
    margin: 0;
  }

  .client-report-table th,
  .client-report-table td {
    border: 1px solid var(--hairline-color, rgba(0, 0, 0, 0.12));
    padding: 0.75rem 1rem;
    text-align: left;
    vertical-align: top;
  }

  .client-report-table th {
    background: rgba(255, 255, 255, 0.05);
    font-weight: 600;
  }

  .report-subject {
    display: block;
    font-weight: 600;
  }

  .report-missing {
    color: var(--body-quiet-color, #6b7280);
  }

  .empty-state {
    margin: 0;
    color: var(--body-quiet-color, #6b7280);
  }

  @media (max-width: 48rem) {
    .client-report-table thead {
      display: none;
    }

    .client-report-table tr {
      display: block;
      border-bottom: 1px solid var(--hairline-color, rgba(0, 0, 0, 0.1));
      margin-bottom: 1rem;
    }

    .client-report-table td {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      border: none;
      border-bottom: 1px solid var(--hairline-color, rgba(0, 0, 0, 0.06));
    }

    .client-report-table td:last-child {
      border-bottom: none;
    }

    .client-report-table td::before {
      content: attr(data-label);
      font-weight: 600;
      color: inherit;
    }

    .report-subject {
      font-size: 1rem;
    }
  }
</style>
{% endblock %}
