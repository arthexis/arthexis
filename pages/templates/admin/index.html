{% extends "admin/base_site.html" %}
{% load i18n static admin_extras %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'admin/css/dashboard.css' %}">
  <style>
    .dashboard {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        box-sizing: border-box;
    }
    .dashboard-main {
        flex: 1 1 calc(70% - 0.5rem);
        min-width: 300px;
        max-width: 100%;
        box-sizing: border-box;
    }
    .dashboard-side {
        flex: 1 1 calc(30% - 0.5rem);
        min-width: 300px;
        max-width: 100%;
        box-sizing: border-box;
        background: var(--darkened-bg);
        padding-top: 12px;
        padding-left: 12px;
        padding-right: 12px;
    }
    .dashboard-side .module {
        background: none;
    }
    .dashboard-side .module h2 {
        background: none;
        padding-left: 16px;
        padding-right: 16px;
        padding-top: 0;
        padding-bottom: 0;
        margin-bottom: 16px;
        border-bottom: 1px solid var(--hairline-color);
        font-size: 1.125rem;
        color: var(--body-fg);
    }
    .dashboard-side h3 {
        color: var(--body-quiet-color);
        padding: 0 16px;
        margin: 0 0 16px;
    }
    .dashboard-side p {
        padding: 0 16px;
    }
    .dashboard-side .actionlist {
        padding: 0;
        margin: 16px;
    }
    .dashboard-side .actionlist li {
        line-height: 1.2;
        margin-bottom: 10px;
        padding-left: 18px;
    }
    /* Override Django's dashboard defaults so the flex layout works */
    .dashboard #content {
        width: auto;
        box-sizing: border-box;
    }
    #content-main,
    #recent-boxes {
        float: none;
        width: auto;
    }
    .dashboard-main td.actions {
        text-align: right;
        white-space: nowrap;
    }
    .dashboard-main td.actions .actionlink {
        display: inline;
        margin-left: 0;
    }
    .dashboard-main .module table {
        width: 100%;
    }
    .dashboard-main .app-caption {
        width: 100%;
        box-sizing: border-box;
    }
    .dashboard-main .lead-open-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-left: 8px;
        padding: 0.125rem 0.5rem;
        min-width: 1.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        line-height: 1;
        border-radius: 999px;
        background-color: var(--button-bg, #0d6efd);
        color: var(--button-fg, #fff);
    }
    .dashboard-main .rfid-release-stats {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        margin-left: 8px;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--body-quiet-color);
    }
    .dashboard-main .rfid-release-badge,
    .dashboard-main .charger-availability-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-left: 8px;
        padding: 0.125rem 0.5rem;
        min-width: 1.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        line-height: 1;
        border-radius: 999px;
        background-color: var(--button-bg, #0d6efd);
        color: var(--button-fg, #fff);
        border: none;
    }
    .dashboard-main .rfid-release-separator {
        font-weight: 700;
        color: var(--body-quiet-color);
    }
    .dashboard-main .app-caption .section {
        display: block;
        width: 100%;
    }
    .dashboard-side .actionlist li {
        position: relative;
    }
    .dashboard-side .actionlist li .todo-details {
        display: none;
        position: absolute;
        left: 0;
        top: 100%;
        background: var(--body-bg);
        border: 1px solid var(--hairline-color);
        padding: 8px;
        z-index: 1000;
        width: 200px;
    }
    .dashboard-side .actionlist li:hover .todo-details {
        display: block;
    }
    #viewhistory-mini-module {
        margin-top: 16px;
    }
    #viewhistory-mini-module .chart-wrapper {
        position: relative;
        padding: 0 16px 16px;
    }
    #viewhistory-mini-module canvas {
        display: block;
        width: 100%;
        height: 180px;
    }
    #viewhistory-mini-empty {
        padding: 0 16px;
        margin: 0;
        color: var(--body-quiet-color);
    }
    #viewhistory-mini-module .chart-link {
        padding: 0 16px 16px;
        margin: 0;
    }
    .todo-status {
        float: right;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.04em;
    }
    .todo-status-completed {
        color: var(--body-quiet-color);
    }
    .todo-status-date {
        font-weight: 400;
        text-transform: none;
        letter-spacing: normal;
    }
  </style>
{% endblock %}

{% block coltype %}colM{% endblock %}

{% block bodyclass %}{{ block.super }} dashboard{% endblock %}

{% block content_title %}
<div id="admin-home-header" style="display:flex; justify-content:space-between; align-items:center;">
  <h1>Home</h1>
  <div style="display:flex; align-items:center; gap:8px;">
    <a class="button" href="{% url 'admin:seed_data' %}">{% translate 'Seed Data' %}</a>
    <a class="button" href="{% url 'admin:user_data' %}">{% translate 'User Data' %}</a>
    <a class="button" href="{% url 'admin:system' %}">{% translate 'System Reports' %}</a>
    <a class="button" href="{% url 'admin:environment' %}">{% translate 'Environ' %}</a>
    <a class="button" href="{% url 'admin:config' %}">{% translate 'Config' %}</a>
    <a class="button" href="{% url 'admin:sigil_builder' %}">{% translate 'Sigil Builder' %}</a>
    <a class="button" href="{% url 'admin:log_viewer' %}">{% translate 'Log Viewer' %}</a>
    {% if datasette_enabled %}
      <a class="button" href="/data/">{% translate 'Datasette' %}</a>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block nav-breadcrumbs %}{% endblock %}
{% block nav-sidebar %}{% endblock %}

{% block content %}
<div class="dashboard" id="admin-dashboard">
  <div id="content-main" class="dashboard-main">
    {% include "admin/app_list.html" with app_list=app_list show_changelinks=True show_model_badges=True %}
  </div>
<div class="dashboard-side" id="recent-boxes">
    <div class="module" id="future-actions-module">
        <h2>{% translate 'Future actions' %}</h2>
        {% future_action_items as future_items %}
        {% if future_items.models %}
            <ul class="actionlist">
                {% for item in future_items.models %}
                <li class="changelink"><a href="{{ item.url }}" target="_blank" rel="noopener noreferrer">Change {{ item.label|capfirst }}</a></li>
                {% endfor %}
            </ul>
        {% endif %}
        {% if future_items.todos %}
            <h3>
              <a href="{% url 'admin:system-pending-todos-report' %}" class="release-manager-link">
                {% translate 'Release manager tasks' %}
              </a>
            </h3>
            <ul class="actionlist">
                {% for todo in future_items.todos %}
                <li class="changelink">
                    <a href="{{ todo.url }}?next={{ request.get_full_path|urlencode }}" class="todo-link">{{ todo.label }}</a>
                    {% if todo.details %}
                    <div class="todo-details">{{ todo.details }}</div>
                    {% endif %}
                    {% if todo.completed %}
                    <span class="todo-status todo-status-completed">{% translate 'Completed' %}{% if todo.done_on %} <span class="todo-status-date">({{ todo.done_on|date:"SHORT_DATETIME_FORMAT" }})</span>{% endif %}</span>
                    {% else %}
                    <form method="post" action="{{ todo.done_url }}" style="display:inline; float:right;">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <button class="button" title="Done" style="padding-bottom:2px;">DONE</button>
                    </form>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        {% elif not future_items.models %}
            <p>{% translate 'None available' %}</p>
        {% endif %}
    </div>
    <div class="module" id="viewhistory-mini-module">
        <h2>{% translate 'Public site traffic' %}</h2>
        <div class="chart-wrapper">
            <canvas id="viewhistory-mini-chart" role="img" aria-label="{% translate 'Mini chart of public visits' %}" height="160"></canvas>
            <p id="viewhistory-mini-empty" class="quiet" hidden>{% translate 'No visit data yet.' %}</p>
        </div>
        <p class="chart-link"><a id="viewhistory-mini-link" href="{% url 'admin:pages_viewhistory_traffic_graph' %}">{% translate 'Open full report' %}</a></p>
    </div>
    <div class="module" id="recent-actions-module">
        <h2>{% translate 'Recent actions' %}</h2>
        <h3>{% translate 'My actions' %}</h3>
            {% load log %}
            {% get_admin_log 10 as admin_log for_user user %}
            {% if not admin_log %}
            <p>{% translate 'None available' %}</p>
            {% else %}
            <ul class="actionlist">
            {% for entry in admin_log %}
            <li class="{% if entry.is_addition %}addlink{% endif %}{% if entry.is_change %} changelink{% endif %}{% if entry.is_deletion %} deletelink{% endif %}">
                <span class="visually-hidden">{% if entry.is_addition %}{% translate 'Added:' %}{% elif entry.is_change %}{% translate 'Changed:' %}{% elif entry.is_deletion %}{% translate 'Deleted:' %}{% endif %}</span>
                {% if entry.is_deletion or not entry.get_admin_url %}
                    {{ entry.object_repr }}
                {% else %}
                    <a href="{{ entry.get_admin_url }}">{{ entry.object_repr }}</a>
                {% endif %}
                <br>
                {% if entry.content_type %}
                    <span class="mini quiet">{% filter capfirst %}{{ entry.content_type.name }}{% endfilter %}</span>
                {% else %}
                    <span class="mini quiet">{% translate 'Unknown content' %}</span>
                {% endif %}
            </li>
            {% endfor %}
            </ul>
            {% endif %}
    </div>
</div>
</div>
{% endblock %}

{% block sidebar %}{% endblock %}

{% block extrahead %}
  {{ block.super }}
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const canvas = document.getElementById('viewhistory-mini-chart');
      const emptyLabel = document.getElementById('viewhistory-mini-empty');
      if (!canvas) return;

      const chartJsUrl = "{% static 'core/vendor/chart.umd.min.js' %}";

      const ensureChartJs = () => {
        if (window.Chart) {
          return Promise.resolve(window.Chart);
        }

        const waitForChart = (resolve) => {
          if (window.Chart) {
            resolve(window.Chart);
            return true;
          }
          return false;
        };

        return new Promise((resolve) => {
          const existing = document.querySelector('script[data-chartjs]');
          if (existing) {
            if (existing.dataset.chartjsState === 'error') {
              resolve(null);
              return;
            }

            if (waitForChart(resolve)) {
              return;
            }

            existing.addEventListener(
              'load',
              () => {
                existing.dataset.chartjsState = 'loaded';
                resolve(window.Chart || null);
              },
              { once: true },
            );
            existing.addEventListener(
              'error',
              () => {
                existing.dataset.chartjsState = 'error';
                resolve(null);
              },
              { once: true },
            );

            if (existing.readyState === 'complete') {
              waitForChart(resolve);
            }
            return;
          }

          const script = document.createElement('script');
          script.src = chartJsUrl;
          script.async = true;
          script.dataset.chartjs = 'true';
          script.dataset.chartjsState = 'loading';
          script.addEventListener(
            'load',
            () => {
              script.dataset.chartjsState = 'loaded';
              resolve(window.Chart || null);
            },
            { once: true },
          );
          script.addEventListener(
            'error',
            () => {
              script.dataset.chartjsState = 'error';
              resolve(null);
            },
            { once: true },
          );
          document.head.appendChild(script);
        });
      };

      const fetchData = () =>
        fetch('{% url "admin:pages_viewhistory_traffic_data" %}', {
          headers: { Accept: 'application/json' },
        }).then((response) => (response.ok ? response.json() : Promise.reject()));

      ensureChartJs()
        .then((Chart) => {
          if (!Chart) {
            throw new Error('chartjs');
          }
          return fetchData().then((data) => ({ Chart, data }));
        })
        .then(({ Chart, data }) => {
          if (!data || !Array.isArray(data.datasets) || !data.datasets.length) {
            canvas.hidden = true;
            if (emptyLabel) {
              emptyLabel.hidden = false;
              emptyLabel.textContent = '{% translate "No visit data yet." %}';
            }
            return;
          }

          if (emptyLabel) {
            emptyLabel.hidden = true;
          }
          canvas.hidden = false;
          const context = canvas.getContext('2d');
          new Chart(context, {
            type: 'line',
            data: {
              labels: data.labels,
              datasets: data.datasets.map((dataset) => ({
                ...dataset,
                pointRadius: 0,
                pointHoverRadius: 3,
                borderWidth: 2,
              })),
            },
            options: {
              animation: false,
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  mode: 'nearest',
                  intersect: false,
                },
              },
              elements: {
                line: { tension: 0.3 },
              },
              scales: {
                x: { display: false },
                y: { display: false, beginAtZero: true },
              },
            },
          });
        })
        .catch(() => {
          canvas.hidden = true;
          if (emptyLabel) {
            emptyLabel.hidden = false;
            emptyLabel.textContent = '{% translate "Unable to load visit data at this time." %}';
          }
        });
    });
  </script>
{% endblock %}
