{% load i18n admin_extras favorites %}

{% if app_list %}
  {% favorite_map as favorites_map %}
  {% favorite_entries app_list favorites_map as favorite_entries %}
  {% if favorite_entries %}
    <div class="module favorites-module">
      <table>
        <caption class="visually-hidden">{% translate 'Favorite models' %}</caption>
        <thead class="visually-hidden">
          <tr>
            <th scope="col">{% translate 'Model name' %}</th>
            <th scope="col">{% translate 'Model actions' %}</th>
            <th scope="col">{% translate 'Add link' %}</th>
            <th scope="col">{% translate 'Change or view list link' %}</th>
          </tr>
        </thead>
        <tbody>
        {% for entry in favorite_entries %}
          {% with app=entry.app model=entry.model fav=entry.favorite ct_id=entry.ct_id model_name=model.object_name|lower %}
            <tr class="model-{{ model_name }}{% if model.admin_url in request.path|urlencode %} current-model{% endif %}">
              <th scope="row" id="favorites-{{ app.app_label }}-{{ model_name }}">
                {% if ct_id %}
                  <a href="{% url 'admin:favorite_toggle' ct_id %}?next={{ request.get_full_path|urlencode }}" class="favorite-star favorited" title="Toggle favorite">&#9733;</a>
                {% endif %}
                {% model_db_status app.app_label model.object_name as model_ok %}
                {% if model_ok %}
                  {% translate 'Installed' as status_label %}
                {% else %}
                  {% translate 'Missing' as status_label %}
                {% endif %}
                <span class="model-status {% if model_ok %}ok{% else %}missing{% endif %}" title="{{ status_label }}" aria-label="{{ status_label }}"></span>
                {% if model.admin_url %}
                  <a href="{{ model.admin_url }}"{% if model.admin_url in request.path|urlencode %} aria-current="page"{% endif %}>{{ fav.custom_label|default:model.name }}</a>
                {% else %}
                  {{ fav.custom_label|default:model.name }}
                {% endif %}
                {% if show_model_badges %}
                  {% if model.object_name == 'RFID' %}
                    {% rfid_release_stats as rfid_stats %}
                    {% if rfid_stats %}
                      {% blocktranslate with released_allowed=rfid_stats.released_allowed registered=rfid_stats.total asvar rfid_badge_label trimmed %}
                        {{ released_allowed }} released and allowed RFIDs out of {{ registered }} registered RFIDs
                      {% endblocktranslate %}
                      <span class="rfid-release-badge" aria-label="{{ rfid_badge_label }}" title="{{ rfid_badge_label }}">
                        {{ rfid_stats.released_allowed }} / {{ rfid_stats.total }}
                      </span>
                    {% endif %}
                  {% endif %}
                  {% if model.object_name == 'Charger' %}
                    {% charger_availability_stats as charger_stats %}
                    {% if charger_stats %}
                      {% if charger_stats.available_missing_cp_number %}
                        {% blocktranslate with available=charger_stats.available_with_cp_number total=charger_stats.available_total missing=charger_stats.available_missing_cp_number asvar charger_badge_label trimmed %}
                          {{ available }} chargers reporting Available status with a CP number, out of {{ total }} total Available chargers. {{ missing }} Available chargers are missing a connector number.
                        {% endblocktranslate %}
                      {% else %}
                        {% blocktranslate with available=charger_stats.available_with_cp_number total=charger_stats.available_total asvar charger_badge_label trimmed %}
                          {{ available }} chargers reporting Available status with a CP number.
                        {% endblocktranslate %}
                      {% endif %}
                      <span class="charger-availability-badge" aria-label="{{ charger_badge_label }}" title="{{ charger_badge_label }}">
                        {{ charger_stats.available_with_cp_number }} / {{ charger_stats.available_total }}
                      </span>
                    {% endif %}
                  {% endif %}
                  {% lead_open_count app.app_label model.object_name as lead_open_count %}
                  {% if lead_open_count is not None %}
                    {% blocktranslate count open_count=lead_open_count asvar lead_open_label trimmed %}
                      {{ open_count }} open lead
                    {% plural %}
                      {{ open_count }} open leads
                    {% endblocktranslate %}
                    <span class="lead-open-badge" aria-label="{{ lead_open_label }}" title="{{ lead_open_label }}">{{ lead_open_count }}</span>
                  {% endif %}
                {% endif %}
              </th>

              {% if model.admin_url and show_changelinks %}
                {% model_admin_actions app.app_label model.object_name as extra_actions %}
                <td class="actions">
                  {% for action in extra_actions %}
                    <a href="{{ action.url }}" class="actionlink" aria-describedby="favorites-{{ app.app_label }}-{{ model_name }}">{{ action.label }}</a>{% if not forloop.last %}&nbsp;{% endif %}
                  {% endfor %}
                </td>
              {% else %}
                <td class="actions"></td>
              {% endif %}

              {% if model.add_url %}
                <td><a href="{{ model.add_url }}" class="addlink" aria-describedby="favorites-{{ app.app_label }}-{{ model_name }}">{% translate 'Add' %}</a></td>
              {% else %}
                <td></td>
              {% endif %}

              {% if model.admin_url and show_changelinks %}
                <td>
                  {% if model.view_only %}
                    <a href="{{ model.admin_url }}" class="viewlink" aria-describedby="favorites-{{ app.app_label }}-{{ model_name }}">{% translate 'View' %}</a>
                  {% else %}
                    <a href="{{ model.admin_url }}" class="changelink" aria-describedby="favorites-{{ app.app_label }}-{{ model_name }}" target="_blank" rel="noopener noreferrer">{% translate 'Change' %}</a>
                  {% endif %}
                </td>
              {% elif show_changelinks %}
                <td></td>
              {% endif %}
            </tr>
          {% endwith %}
        {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}
  {% celery_feature_enabled as celery_enabled %}
  {% for app in app_list %}
    {% if app.app_label != 'django_celery_beat' or celery_enabled %}
    <div class="app-{{ app.app_label }} module{% if app.app_url in request.path|urlencode %} current-app{% endif %}" data-app-label="{{ app.app_label }}">
      <table>
        <caption class="app-caption">
          <div class="app-caption-inner">
            <a href="{{ app.app_url }}" class="section" title="{% blocktranslate with name=app.name %}Models in the {{ name }} application{% endblocktranslate %}">{{ app.name }}</a>
          </div>
        </caption>
        <thead class="visually-hidden">
          <tr>
            <th scope="col">{% translate 'Model name' %}</th>
            <th scope="col">{% translate 'Model actions' %}</th>
            <th scope="col">{% translate 'Add link' %}</th>
            <th scope="col">{% translate 'Change or view list link' %}</th>
          </tr>
        </thead>
        <tbody id="app-{{ app.app_label }}-models">
        {% for model in app.models %}
          {% with model_name=model.object_name|lower %}
            {% favorite_ct_id app.app_label model.object_name as ct_id %}
            {% favorite_from_map favorites_map ct_id as fav %}
            {% if not fav %}
            <tr class="model-{{ model_name }}{% if model.admin_url in request.path|urlencode %} current-model{% endif %}">
              <th scope="row" id="{{ app.app_label }}-{{ model_name }}">
                {% if ct_id %}
                  <a href="{% url 'admin:favorite_toggle' ct_id %}?next={{ request.get_full_path|urlencode }}" class="favorite-star{% if fav %} favorited{% endif %}" title="Toggle favorite">&#9733;</a>
                {% endif %}
                {% model_db_status app.app_label model.object_name as model_ok %}
                {% if model_ok %}
                  {% translate 'Installed' as status_label %}
                {% else %}
                  {% translate 'Missing' as status_label %}
                {% endif %}
                <span class="model-status {% if model_ok %}ok{% else %}missing{% endif %}" title="{{ status_label }}" aria-label="{{ status_label }}"></span>
                {% if model.admin_url %}
                  <a href="{{ model.admin_url }}"{% if model.admin_url in request.path|urlencode %} aria-current="page"{% endif %}>{{ fav.custom_label|default:model.name }}</a>
                {% else %}
                  {{ fav.custom_label|default:model.name }}
                {% endif %}
                {% if show_model_badges %}
                  {% if model.object_name == 'RFID' %}
                    {% rfid_release_stats as rfid_stats %}
                    {% if rfid_stats %}
                      {% blocktranslate with released_allowed=rfid_stats.released_allowed registered=rfid_stats.total asvar rfid_badge_label trimmed %}
                        {{ released_allowed }} released and allowed RFIDs out of {{ registered }} registered RFIDs
                      {% endblocktranslate %}
                      <span class="rfid-release-badge" aria-label="{{ rfid_badge_label }}" title="{{ rfid_badge_label }}">
                        {{ rfid_stats.released_allowed }} / {{ rfid_stats.total }}
                      </span>
                    {% endif %}
                  {% endif %}
                  {% if model.object_name == 'Charger' %}
                    {% charger_availability_stats as charger_stats %}
                    {% if charger_stats %}
                      {% if charger_stats.available_missing_cp_number %}
                        {% blocktranslate with available=charger_stats.available_with_cp_number total=charger_stats.available_total missing=charger_stats.available_missing_cp_number asvar charger_badge_label trimmed %}
                          {{ available }} chargers reporting Available status with a CP number, out of {{ total }} total Available chargers. {{ missing }} Available chargers are missing a connector number.
                        {% endblocktranslate %}
                      {% else %}
                        {% blocktranslate with available=charger_stats.available_with_cp_number total=charger_stats.available_total asvar charger_badge_label trimmed %}
                          {{ available }} chargers reporting Available status with a CP number.
                        {% endblocktranslate %}
                      {% endif %}
                      <span class="charger-availability-badge" aria-label="{{ charger_badge_label }}" title="{{ charger_badge_label }}">
                        {{ charger_stats.available_with_cp_number }} / {{ charger_stats.available_total }}
                      </span>
                    {% endif %}
                  {% endif %}
                  {% lead_open_count app.app_label model.object_name as lead_open_count %}
                  {% if lead_open_count is not None %}
                    {% blocktranslate count open_count=lead_open_count asvar lead_open_label trimmed %}
                      {{ open_count }} open lead
                    {% plural %}
                      {{ open_count }} open leads
                    {% endblocktranslate %}
                    <span class="lead-open-badge" aria-label="{{ lead_open_label }}" title="{{ lead_open_label }}">{{ lead_open_count }}</span>
                  {% endif %}
                {% endif %}
              </th>

              {% if model.admin_url and show_changelinks %}
                {% model_admin_actions app.app_label model.object_name as extra_actions %}
                <td class="actions">
                  {% for action in extra_actions %}
                    <a href="{{ action.url }}" class="actionlink" aria-describedby="{{ app.app_label }}-{{ model_name }}">{{ action.label }}</a>{% if not forloop.last %}&nbsp;{% endif %}
                  {% endfor %}
                </td>
              {% else %}
                <td class="actions"></td>
              {% endif %}

              {% if model.add_url %}
                <td><a href="{{ model.add_url }}" class="addlink" aria-describedby="{{ app.app_label }}-{{ model_name }}">{% translate 'Add' %}</a></td>
              {% else %}
                <td></td>
              {% endif %}

              {% if model.admin_url and show_changelinks %}
                <td>
                  {% if model.view_only %}
                    <a href="{{ model.admin_url }}" class="viewlink" aria-describedby="{{ app.app_label }}-{{ model_name }}">{% translate 'View' %}</a>
                  {% else %}
                    <a href="{{ model.admin_url }}" class="changelink" aria-describedby="{{ app.app_label }}-{{ model_name }}" target="_blank" rel="noopener noreferrer">{% translate 'Change' %}</a>
                  {% endif %}
                </td>
              {% elif show_changelinks %}
                <td></td>
              {% endif %}
            </tr>
            {% endif %}
          {% endwith %}
        {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
  {% endfor %}
{% else %}
  <p>{% translate 'You don’t have permission to view or edit anything.' %}</p>
{% endif %}
