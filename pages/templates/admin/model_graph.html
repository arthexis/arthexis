{% extends "admin/base_site.html" %}
{% load i18n %}

{% block extrastyle %}
  {{ block.super }}
  <style>
    .model-graph-wrapper {
      background: var(--darkened-bg);
      border: 1px solid var(--hairline-color);
      padding: 1rem;
      overflow: auto;
      margin-bottom: 1.5rem;
    }
    .model-graph svg {
      max-width: none;
    }
    .model-graph__status {
      margin: 0;
      color: var(--body-quiet-color);
    }
    .model-graph__status.error {
      color: var(--error-fg);
    }
    .model-graph-list {
      columns: 2;
      gap: 1rem;
    }
    @media (max-width: 900px) {
      .model-graph-list {
        columns: 1;
      }
    }
  </style>
{% endblock %}

{% block breadcrumbs %}
  <div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% translate 'Home' %}</a>
    › <a href="{% url 'admin:app_list' app_label %}">{{ app_verbose_name }}</a>
    › {% translate 'Model graph' %}
  </div>
{% endblock %}

{% block content %}
  <h1>{{ app_verbose_name }} {% translate 'model graph' %}</h1>
  <p class="help">{% blocktranslate %}This diagram is rendered with Graphviz and reflects the models registered in the {{ app_verbose_name }} admin group, including their relationships.{% endblocktranslate %}</p>

  <div class="model-graph-wrapper">
    <div id="model-graph" class="model-graph" aria-live="polite">
      <p class="model-graph__status">{% translate 'Rendering diagram…' %}</p>
    </div>
  </div>
  <noscript>
    <p class="model-graph__status error">{% translate 'Enable JavaScript to see the database model graph.' %}</p>
  </noscript>

  {% if models %}
    <h2>{% translate 'Included models' %}</h2>
    <ul class="model-graph-list">
      {% for model in models %}
        <li>
          {% if model.url %}
            <a href="{{ model.url }}">{{ model.label }}</a>
          {% else %}
            {{ model.label }}
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% endif %}

  {{ graph_source|json_script:"model-graph-data" }}
  <script src="https://cdn.jsdelivr.net/npm/@viz-js/viz@3.4.0/lib/viz-standalone.js" crossorigin="anonymous"></script>
  <script>
    (function() {
      const dataElement = document.getElementById('model-graph-data');
      const container = document.getElementById('model-graph');
      if (!dataElement || !container) {
        return;
      }
      const dot = JSON.parse(dataElement.textContent);

      function showStatus(text, isError) {
        container.innerHTML = '';
        const message = document.createElement('p');
        message.className = 'model-graph__status' + (isError ? ' error' : '');
        message.textContent = text;
        container.appendChild(message);
      }

      if (typeof window.Viz !== 'function') {
        showStatus('{% translate "The Graphviz renderer could not be loaded." %}', true);
        return;
      }

      const viz = new window.Viz();
      viz.renderSVGElement(dot)
        .then(function(element) {
          container.innerHTML = '';
          element.setAttribute('role', 'img');
          element.setAttribute('aria-label', '{{ app_verbose_name|escapejs }} {% translate "model diagram" %}');
          container.appendChild(element);
        })
        .catch(function(error) {
          console.error('Graph rendering failed', error);
          showStatus('{% translate "Unable to render the diagram. Check the browser console for details." %}', true);
        });
    })();
  </script>
{% endblock %}
