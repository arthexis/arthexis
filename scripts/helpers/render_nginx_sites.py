#!/usr/bin/env python3
"""Render managed NGINX site configurations."""

from __future__ import annotations

import argparse
import json
import sys
from pathlib import Path

ROOT = Path(__file__).resolve().parents[2]
if str(ROOT) not in sys.path:
    sys.path.insert(0, str(ROOT))

from scripts.helpers.nginx_config import (
    http_proxy_server,
    http_redirect_server,
    https_proxy_server,
    slugify,
    write_if_changed,
)


def apply_sites(
    config_path: Path,
    mode: str,
    port: int,
    dest_path: Path,
) -> bool:
    try:
        raw = config_path.read_text(encoding="utf-8")
        sites = json.loads(raw)
    except FileNotFoundError:
        sites = []
    except json.JSONDecodeError as exc:
        raise SystemExit(f"Invalid JSON in {config_path}: {exc}")

    dest_path.parent.mkdir(parents=True, exist_ok=True)

    seen_domains: set[str] = set()
    mode = mode.lower()

    site_blocks: list[str] = ["# Autogenerated by render_nginx_sites.py"]

    for entry in sites:
        domain = (entry.get("domain") or "").strip()
        if not domain:
            continue
        require_https = bool(entry.get("require_https"))
        slug = slugify(domain)
        if slug in seen_domains:
            continue
        seen_domains.add(slug)

        blocks: list[str] = [f"# Managed site for {domain}"]

        if require_https and mode == "public":
            blocks.append(http_redirect_server(domain))
        else:
            blocks.append(http_proxy_server(domain, port))

        if mode == "public":
            blocks.append(https_proxy_server(domain, port))
        elif require_https:
            blocks.append(
                "# HTTPS requested but unavailable in internal mode; update nginx_mode.lck to 'public'."
            )

        site_blocks.append("\n\n".join(blocks))

    if len(site_blocks) == 1:
        site_blocks.append("# No managed sites configured.")

    content = "\n\n".join(site_blocks)
    return write_if_changed(dest_path, content)


def main(argv: list[str] | None = None) -> int:
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument(
        "--config",
        type=Path,
        default=Path("scripts/generated/nginx-sites.json"),
        help="Path to the staged site configuration JSON file.",
    )
    parser.add_argument(
        "--mode",
        default="internal",
        help="Current nginx mode (internal or public).",
    )
    parser.add_argument(
        "--port",
        type=int,
        default=8888,
        help="Local application port used by nginx upstream.",
    )
    parser.add_argument(
        "--dest",
        type=Path,
        default=Path("/etc/nginx/sites-enabled/arthexis-sites.conf"),
        help="Destination file for generated nginx configs.",
    )

    args = parser.parse_args(argv)

    try:
        changed = apply_sites(args.config, args.mode, args.port, args.dest)
    except SystemExit as exc:
        print(exc, file=sys.stderr)
        return 1

    if changed:
        print("Managed nginx site configuration updated.")
        return 2

    print("Managed nginx site configuration unchanged.")
    return 0


if __name__ == "__main__":
    sys.exit(main())
