{% with prefix=prefix|default:"rfid" %}
  <div id="{{ prefix }}-scanner">
  <p id="{{ prefix }}-status">Scanner ready</p>
  <p>
    <button id="{{ prefix }}-restart-test">Restart &amp; Test Scanner</button>
  </p>
  <div class="field"><span class="label">Label:</span><span class="value" id="{{ prefix }}-label"></span></div>
  <div class="field"><span class="label">RFID:</span><span class="value" id="{{ prefix }}-rfid"></span></div>
  <div class="field"><span class="label">Color:</span><span class="value" id="{{ prefix }}-color"></span></div>
  <div class="field"><span class="label">Valid:</span><span class="value" id="{{ prefix }}-allowed"></span></div>
  <div class="field"><span class="label">Released:</span><span class="value" id="{{ prefix }}-released"></span></div>
  <div class="field"><span class="label">Reference:</span><span class="value" id="{{ prefix }}-reference"></span></div>
</div>
<style>
#{{ prefix }}-scanner .field {
  display: flex;
  margin: 0.5em 0;
  font-size: 1.2em;
}
#{{ prefix }}-scanner .label {
  width: 7em;
  font-weight: bold;
}
#{{ prefix }}-scanner .value {
  flex: 1;
}
#{{ prefix }}-status {
  font-size: 1.2em;
  margin-bottom: 1em;
}
</style>
<script>
(function(){
  const statusEl = document.getElementById('{{ prefix }}-status');
  const labelEl = document.getElementById('{{ prefix }}-label');
  const rfidEl = document.getElementById('{{ prefix }}-rfid');
  const colorEl = document.getElementById('{{ prefix }}-color');
  const allowedEl = document.getElementById('{{ prefix }}-allowed');
  const releasedEl = document.getElementById('{{ prefix }}-released');
  const referenceEl = document.getElementById('{{ prefix }}-reference');
  const restartTestBtn = document.getElementById('{{ prefix }}-restart-test');

  function showError(message){
    console.error(message);
    statusEl.textContent = 'RFID reader not detected. Please connect the reader and press Restart & Test Scanner.';
  }

  async function poll(){
    try {
      const resp = await fetch('{{ scan_url }}');
      const data = await resp.json();
      if(data.error){
        showError(data.error);
        return;
      } else if(data.rfid){
        labelEl.textContent = data.label_id;
        rfidEl.textContent = data.rfid || '';
        colorEl.textContent = data.color || '';
        allowedEl.textContent = data.allowed === undefined ? '' : (data.allowed ? 'Yes' : 'No');
        releasedEl.textContent = data.released === undefined ? '' : (data.released ? 'Yes' : 'No');
        referenceEl.textContent = data.reference || '';
        if(data.reference && /^https?:\/\//i.test(data.reference)){
          const w = window.open(data.reference, '_blank');
          if(w){ w.focus(); }
        }
        const okText = data.allowed === undefined ? '' : (data.allowed ? 'OK' : 'BAD');
        const statusMsg = okText ? `RFID ${data.label_id} ${okText}` : `RFID ${data.label_id}`;
        statusEl.textContent = data.created ? `Created ${statusMsg}` : statusMsg;
      }
    } catch(err){
      showError(err);
      return;
    }
    setTimeout(poll, 200);
  }
  restartTestBtn.addEventListener('click', async () => {
    try {
      await fetch('{{ restart_url }}', {method: 'POST'});
      const resp = await fetch('{{ test_url }}');
      const data = await resp.json();
      let msg = '';
      if(data.error){
        msg = 'No local scanner detected.';
      } else if(data.irq_pin !== undefined){
        msg = `IRQ pin ${data.irq_pin}.`;
      }
      statusEl.textContent = msg || 'Test completed';
      poll();
    } catch(err) {
      statusEl.textContent = 'Test failed';
    }
  });
  poll();
})();
</script>
{% endwith %}
