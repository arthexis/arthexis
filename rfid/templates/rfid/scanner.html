{% with prefix=prefix|default:"rfid" %}
  <div id="{{ prefix }}-scanner">
  <p id="{{ prefix }}-status">Scanner ready</p>
  <p>
    <button id="{{ prefix }}-restart-test">Restart &amp; Test Scanner</button>
  </p>
  <div class="field"><span class="label">Label:</span><span class="value" id="{{ prefix }}-label"></span></div>
  <div class="field"><span class="label">RFID:</span><span class="value" id="{{ prefix }}-rfid"></span></div>
  <div class="field"><span class="label">Color:</span><span class="value" id="{{ prefix }}-color"></span></div>
  <div class="field"><span class="label">Valid:</span><span class="value" id="{{ prefix }}-allowed"></span></div>
  <div class="field"><span class="label">Released:</span><span class="value" id="{{ prefix }}-released"></span></div>
</div>
<style>
#{{ prefix }}-scanner .field {
  display: flex;
  margin: 0.5em 0;
  font-size: 1.2em;
}
#{{ prefix }}-scanner .label {
  width: 7em;
  font-weight: bold;
}
#{{ prefix }}-scanner .value {
  flex: 1;
}
#{{ prefix }}-status {
  font-size: 1.2em;
  margin-bottom: 1em;
}
</style>
<script>
(function(){
  const statusEl = document.getElementById('{{ prefix }}-status');
  const labelEl = document.getElementById('{{ prefix }}-label');
  const rfidEl = document.getElementById('{{ prefix }}-rfid');
  const colorEl = document.getElementById('{{ prefix }}-color');
  const allowedEl = document.getElementById('{{ prefix }}-allowed');
  const releasedEl = document.getElementById('{{ prefix }}-released');
  const restartTestBtn = document.getElementById('{{ prefix }}-restart-test');

  function showError(message){
    console.error(message);
    statusEl.textContent = 'RFID reader not detected. Please connect the reader and press Restart & Test Scanner.';
  }

  async function poll(){
    try {
      const resp = await fetch('{{ scan_url }}');
      const data = await resp.json();
      if(data.error){
        showError(data.error);
        return;
      } else if(data.rfid){
        labelEl.textContent = data.label_id;
        rfidEl.textContent = data.rfid || '';
        colorEl.textContent = data.color || '';
        allowedEl.textContent = data.allowed === undefined ? '' : (data.allowed ? 'Yes' : 'No');
        releasedEl.textContent = data.released === undefined ? '' : (data.released ? 'Yes' : 'No');
        statusEl.textContent = data.created ? `Created label ${data.label_id}` : `Detected label ${data.label_id}`;
      }
    } catch(err){
      showError(err);
      return;
    }
    setTimeout(poll, 200);
  }
  restartTestBtn.addEventListener('click', async () => {
    try {
      await fetch('{{ restart_url }}', {method: 'POST'});
      const resp = await fetch('{{ test_url }}');
      const data = await resp.json();
      let msg = '';
      if(data.local){
        if(data.local.error){
          msg += 'No local scanner detected.';
        } else if(data.local.irq_pin !== undefined){
          msg += `IRQ pin ${data.local.irq_pin}.`;
        }
      }
      if(data.remote && data.remote.length){
        const parts = data.remote.map(r => `${r.source}: ${r.error ? r.error : 'ok'}`);
        msg += ` Checking remote scanner... ${parts.join('; ')}`;
      }
      statusEl.textContent = msg || 'Test completed';
      poll();
    } catch(err) {
      statusEl.textContent = 'Test failed';
    }
  });
  poll();
})();
</script>
{% endwith %}
