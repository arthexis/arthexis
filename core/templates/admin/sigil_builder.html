{% extends "admin/base_site.html" %}
{% load i18n %}

{% block content %}
<div id="content-main">
  <h1>{{ title }}</h1>
  <form method="post" enctype="multipart/form-data" style="margin-bottom:1em;">
    {% csrf_token %}
    <label for="sigils_text">{% trans "Sigils" %}</label>
    <textarea name="sigils_text" id="sigils_text" rows="10" cols="80" style="width:100%;">{{ sigils_text }}</textarea>
    <input type="file" name="sigils_file" id="sigils_file" />
    <button type="submit">{% trans "Validate" %}</button>
  </form>
  {% if sigils_text %}
  <label for="resolved_text">{% trans "Result" %}</label>
  <textarea id="resolved_text" rows="10" cols="80" style="width:100%;" readonly>{{ resolved_text }}</textarea>
  {% endif %}
  <input type="text" id="sigil-filter" placeholder="{% trans 'Filter' %}" />
  <table id="sigil-table">
    <thead>
      <tr><th>{% trans "Prefix" %}</th><th>{% trans "Model" %}</th><th>{% trans "Fields" %}</th></tr>
    </thead>
    <tbody>
    {% for root in sigil_roots %}
      <tr>
        <td>[{{ root.prefix }}]</td>
        <td>{{ root.model }}</td>
        <td>{% for field in root.fields %}{{ field }}{% if not forloop.last %}, {% endif %}{% endfor %}</td>
      </tr>
    {% empty %}
      <tr><td colspan="3">{% trans "No Sigil Roots." %}</td></tr>
    {% endfor %}
    </tbody>
  </table>
  <h2 style="margin-top:1em;">{% trans "Auto-resolvable Fields" %}</h2>
  <input type="text" id="auto-filter" placeholder="{% trans 'Filter' %}" />
  <table id="auto-table">
    <thead>
      <tr><th>{% trans "Model" %}</th><th>{% trans "Field" %}</th></tr>
    </thead>
    <tbody>
    {% for item in auto_fields %}
      <tr>
        <td>{{ item.model }}</td>
        <td>{{ item.field }}</td>
      </tr>
    {% empty %}
      <tr><td colspan="2">{% trans "No auto-resolvable fields." %}</td></tr>
    {% endfor %}
    </tbody>
  </table>
</div>
<script>
  function setupFilter(inputId, tableId) {
    const input = document.getElementById(inputId);
    const table = document.getElementById(tableId);
    if (!input || !table) return;
    input.addEventListener('input', function () {
      const term = this.value.toLowerCase();
      for (const row of table.tBodies[0].rows) {
        row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
      }
    });
  }
  document.addEventListener('DOMContentLoaded', function () {
    setupFilter('sigil-filter', 'sigil-table');
    setupFilter('auto-filter', 'auto-table');
  });
</script>
{% endblock %}
