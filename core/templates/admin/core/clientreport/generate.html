{% extends "admin/base_site.html" %}
{% block content %}
<h1>Client Report</h1>
<form method="post" id="report-form" class="client-report-form">
  {% csrf_token %}
  <fieldset class="report-section" aria-describedby="id_period-help">
    <legend class="section-title">Reporting period</legend>
    <div class="form-group">
      {{ form.period.label_tag }}
      <div class="option-list">
        {{ form.period }}
      </div>
      {% if form.period.help_text %}
        <p class="help-text" id="id_period-help">{{ form.period.help_text }}</p>
      {% endif %}
    </div>
    <div class="form-grid" id="range-fields">
      <div class="form-group">
        {{ form.start.label_tag }}
        {{ form.start }}
        {% if form.start.help_text %}
          <p class="help-text" id="id_start-help">{{ form.start.help_text }}</p>
        {% endif %}
      </div>
      <div class="form-group">
        {{ form.end.label_tag }}
        {{ form.end }}
        {% if form.end.help_text %}
          <p class="help-text" id="id_end-help">{{ form.end.help_text }}</p>
        {% endif %}
      </div>
    </div>
    <div class="form-group" id="week-field">
      {{ form.week.label_tag }}
      {{ form.week }}
      {% if form.week.help_text %}
        <p class="help-text" id="id_week-help">{{ form.week.help_text }}</p>
      {% endif %}
    </div>
    <div class="form-group" id="month-field">
      {{ form.month.label_tag }}
      {{ form.month }}
      {% if form.month.help_text %}
        <p class="help-text" id="id_month-help">{{ form.month.help_text }}</p>
      {% endif %}
    </div>
  </fieldset>
  <fieldset class="report-section" aria-describedby="delivery-help">
    <legend class="section-title">Delivery and ownership</legend>
    <p class="section-description" id="delivery-help">
      Control who receives the report and how it is scheduled for delivery.
    </p>
    <div class="form-group">
      {{ form.owner.label_tag }}
      {{ form.owner }}
      {% if form.owner.help_text %}
        <p class="help-text" id="id_owner-help">{{ form.owner.help_text }}</p>
      {% endif %}
    </div>
    <div class="form-group">
      {{ form.destinations.label_tag }}
      {{ form.destinations }}
      {% if form.destinations.help_text %}
        <p class="help-text" id="id_destinations-help">{{ form.destinations.help_text }}</p>
      {% endif %}
    </div>
    <div class="form-group">
      {{ form.recurrence.label_tag }}
      {{ form.recurrence }}
      {% if form.recurrence.help_text %}
        <p class="help-text" id="id_recurrence-help">{{ form.recurrence.help_text }}</p>
      {% endif %}
    </div>
    <div class="form-group checkbox-group">
      <div class="checkbox-wrapper">
        {{ form.disable_emails }}
        {{ form.disable_emails.label_tag }}
      </div>
      {% if form.disable_emails.help_text %}
        <p class="help-text" id="id_disable_emails-help">{{ form.disable_emails.help_text }}</p>
      {% endif %}
    </div>
  </fieldset>
  <div class="form-actions">
    <button type="submit" class="button button-primary" id="generate-report-button">
      Generate report
    </button>
  </div>
</form>
{% if report %}
  <h2>Report from {{ report.start_date }} to {{ report.end_date }}</h2>
  <table class="adminlist">
    <thead>
      <tr><th>RFID/Account</th><th>Sessions</th><th>Total kWh</th></tr>
    </thead>
    <tbody>
      {% for row in report.data.rows %}
        <tr><td>{{ row.subject }}</td><td>{{ row.count }}</td><td>{{ row.kw|floatformat:2 }}</td></tr>
      {% empty %}
        <tr><td colspan="3">No data available.</td></tr>
      {% endfor %}
    </tbody>
  </table>
  {% if schedule %}
    <p class="success">Next run scheduled ({{ schedule.get_periodicity_display }})</p>
  {% endif %}
{% endif %}
<script>
  const periodRadios = document.querySelectorAll('input[name="period"]');
  const rangeFields = document.getElementById('range-fields');
  const weekField = document.getElementById('week-field');
  const monthField = document.getElementById('month-field');
  function toggleFields() {
    const checked = document.querySelector('input[name="period"]:checked');
    const value = checked ? checked.value : 'range';
    rangeFields.style.display = value === 'range' ? 'grid' : 'none';
    weekField.style.display = value === 'week' ? 'flex' : 'none';
    monthField.style.display = value === 'month' ? 'flex' : 'none';
  }
  periodRadios.forEach(r => r.addEventListener('change', toggleFields));
  toggleFields();

  const describedByMap = {
    id_start: 'id_start-help',
    id_end: 'id_end-help',
    id_week: 'id_week-help',
    id_month: 'id_month-help',
    id_owner: 'id_owner-help',
    id_destinations: 'id_destinations-help',
    id_recurrence: 'id_recurrence-help',
    id_disable_emails: 'id_disable_emails-help',
  };

  Object.entries(describedByMap).forEach(([fieldId, helpId]) => {
    const field = document.getElementById(fieldId);
    const help = document.getElementById(helpId);
    if (field && help) {
      field.setAttribute('aria-describedby', helpId);
    }
  });

  periodRadios.forEach((radio) => {
    const help = document.getElementById('id_period-help');
    if (help) {
      radio.setAttribute('aria-describedby', 'id_period-help');
    }
  });
</script>
<style>
  .client-report-form {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    max-width: 48rem;
  }

  .client-report-form fieldset {
    border: 1px solid var(--hairline-color, rgba(255, 255, 255, 0.2));
    border-radius: 8px;
    padding: 0 1.5rem 1.5rem;
    background-color: var(--darkened-bg, rgba(255, 255, 255, 0.02));
  }

  .client-report-form .section-title {
    font-size: 1.1rem;
    font-weight: 600;
  }

  .client-report-form legend.section-title {
    display: block;
    box-sizing: border-box;
    width: calc(100% + 3rem);
    margin: 0 -1.5rem 1.25rem;
    padding: 1.25rem 1.5rem 1rem;
    background-color: inherit;
    border-bottom: 1px solid var(--hairline-color, rgba(255, 255, 255, 0.15));
    border-radius: 8px 8px 0 0;
  }

  .client-report-form .section-description {
    margin: 0 0 1.25rem;
    color: var(--body-quiet-color, #6b7280);
  }

  .client-report-form .report-section > *:not(legend):not(.section-description) {
    padding: 0 0 0.75rem;
  }

  .client-report-form
    .report-section
    > *:not(legend):not(.section-description)
    + *:not(legend):not(.section-description) {
    border-top: 1px solid rgba(148, 163, 184, 0.25);
    padding-top: 0.75rem;
  }

  .client-report-form .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .client-report-form .form-grid {
    display: grid;
    gap: 1rem;
  }

  @media (min-width: 40rem) {
    .client-report-form .form-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  .client-report-form .option-list ul,
  .client-report-form .option-list {
    margin: 0;
    padding: 0;
    list-style: none;
  }

  .client-report-form .help-text {
    margin: 0;
    font-size: 0.85rem;
    color: var(--body-quiet-color, #6b7280);
  }

  .client-report-form .checkbox-group {
    gap: 0.25rem;
  }

  .client-report-form .checkbox-wrapper {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .client-report-form .form-actions {
    display: flex;
    justify-content: flex-end;
  }

  #generate-report-button {
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    font-weight: 600;
    border-radius: 6px;
  }

  @media (max-width: 40rem) {
    .client-report-form {
      gap: 1.5rem;
    }

    .client-report-form .form-actions {
      justify-content: stretch;
    }

    #generate-report-button {
      width: 100%;
    }
  }
</style>
{% endblock %}
