{% extends "admin/base_site.html" %}
{% block content %}
<h1>Client Report</h1>
<form method="post" id="report-form">
  {% csrf_token %}
  <div>
    {{ form.period.label_tag }} {{ form.period }}
  </div>
  <div id="range-fields">
    {{ form.start.label_tag }} {{ form.start }}
    {{ form.end.label_tag }} {{ form.end }}
  </div>
  <div id="week-field">
    {{ form.week.label_tag }} {{ form.week }}
  </div>
  <div id="month-field">
    {{ form.month.label_tag }} {{ form.month }}
  </div>
  <fieldset>
    <legend>Recurrency</legend>
    <div class="form-row">
      {{ form.owner.label_tag }} {{ form.owner }}
    </div>
    <div class="form-row">
      {{ form.destinations.label_tag }} {{ form.destinations }}
      <p class="help">{{ form.destinations.help_text }}</p>
    </div>
    <div class="form-row">
      {{ form.recurrence.label_tag }} {{ form.recurrence }}
    </div>
    <div class="form-row">
      {{ form.disable_emails }} {{ form.disable_emails.label_tag }}
      <p class="help">{{ form.disable_emails.help_text }}</p>
    </div>
  </fieldset>
  <button type="submit">Generate</button>
</form>
{% if report %}
  <h2>Report from {{ report.start_date }} to {{ report.end_date }}</h2>
  <table class="adminlist">
    <thead>
      <tr><th>RFID/Account</th><th>Sessions</th><th>Total kWh</th></tr>
    </thead>
    <tbody>
      {% for row in report.data.rows %}
        <tr><td>{{ row.subject }}</td><td>{{ row.count }}</td><td>{{ row.kw|floatformat:2 }}</td></tr>
      {% empty %}
        <tr><td colspan="3">No data available.</td></tr>
      {% endfor %}
    </tbody>
  </table>
  {% if schedule %}
    <p class="success">Next run scheduled ({{ schedule.get_periodicity_display }})</p>
  {% endif %}
{% endif %}
<script>
  const periodRadios = document.querySelectorAll('input[name="period"]');
  const rangeFields = document.getElementById('range-fields');
  const weekField = document.getElementById('week-field');
  const monthField = document.getElementById('month-field');
  function toggleFields() {
    const value = document.querySelector('input[name="period"]:checked').value;
    rangeFields.style.display = value === 'range' ? 'block' : 'none';
    weekField.style.display = value === 'week' ? 'block' : 'none';
    monthField.style.display = value === 'month' ? 'block' : 'none';
  }
  periodRadios.forEach(r => r.addEventListener('change', toggleFields));
  toggleFields();
</script>
{% endblock %}
