{% extends "admin/base_site.html" %}
{% load i18n %}

{% block extrastyle %}
  {{ block.super }}
  <style>
    #content-main .pending-todos-form {
      max-width: none;
      width: 100%;
    }

    #content-main .pending-todos-form .pending-todos-table {
      width: 100%;
    }

    #content-main .pending-todos-table th,
    #content-main .pending-todos-table td {
      vertical-align: top;
    }

    #content-main .pending-todos-table textarea,
    #content-main .pending-todos-table input[type="text"],
    #content-main .pending-todos-table input[type="url"],
    #content-main .pending-todos-table select {
      width: 100%;
      box-sizing: border-box;
    }
  </style>
{% endblock %}

{% block content %}
<div id="content-main">
  <p class="help">
    {% trans "Review outstanding release TODOs, update their details, and approve multiple items at once." %}
  </p>
  {% if formset.total_form_count %}
    <form method="post" novalidate class="pending-todos-form">
      {% csrf_token %}
      {{ formset.management_form }}
      <table class="table table-striped pending-todos-table">
        <thead>
          <tr>
            <th scope="col">{% trans "Request" %}</th>
            <th scope="col">{% trans "Details" %}</th>
            <th scope="col">{% trans "URL" %}</th>
            <th scope="col">{% trans "Generated for" %}</th>
            <th scope="col">{% trans "Links" %}</th>
            <th scope="col">{% trans "Approve" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for row in rows %}
            {% with form=row.form todo=row.todo %}
            <tr>
              <td>
                {{ form.id }}
                {% if form.non_field_errors %}
                  <div class="errorlist nonfield">
                    {% for error in form.non_field_errors %}
                      <div>{{ error }}</div>
                    {% endfor %}
                  </div>
                {% endif %}
                {% if form.request.errors %}
                  <div class="errorlist">
                    {% for error in form.request.errors %}
                      <div>{{ error }}</div>
                    {% endfor %}
                  </div>
                {% endif %}
                {{ form.request }}
              </td>
              <td>
                {% if form.request_details.errors %}
                  <div class="errorlist">
                    {% for error in form.request_details.errors %}
                      <div>{{ error }}</div>
                    {% endfor %}
                  </div>
                {% endif %}
                {{ form.request_details }}
              </td>
              <td>
                {% if form.url.errors %}
                  <div class="errorlist">
                    {% for error in form.url.errors %}
                      <div>{{ error }}</div>
                    {% endfor %}
                  </div>
                {% endif %}
                {{ form.url }}
              </td>
              <td class="generated-for">
                <div class="generated-field">
                  <span class="label">{% trans "Version" %}</span>
                  {% if form.generated_for_version.errors %}
                    <div class="errorlist">
                      {% for error in form.generated_for_version.errors %}
                        <div>{{ error }}</div>
                      {% endfor %}
                    </div>
                  {% endif %}
                  {{ form.generated_for_version }}
                </div>
                <div class="generated-field">
                  <span class="label">{% trans "Revision" %}</span>
                  {% if form.generated_for_revision.errors %}
                    <div class="errorlist">
                      {% for error in form.generated_for_revision.errors %}
                        <div>{{ error }}</div>
                      {% endfor %}
                    </div>
                  {% endif %}
                  {{ form.generated_for_revision }}
                </div>
              </td>
              <td class="links-cell">
                <div class="todo-link-group">
                  <div>
                    <a class="todo-link-config" href="{% url 'admin:core_todo_change' todo.pk %}">
                      {% trans "Config" %}
                    </a>
                  </div>
                  <div>
                    <a class="todo-link-focus" href="{% url 'todo-focus' todo.pk %}?next={{ request.get_full_path|urlencode }}">
                      {% trans "Check" %}
                    </a>
                  </div>
                </div>
                {{ form.on_done_condition.as_hidden }}
              </td>
              <td class="approve-cell">
                {% if form.mark_done.errors %}
                  <div class="errorlist">
                    {% for error in form.mark_done.errors %}
                      <div>{{ error }}</div>
                    {% endfor %}
                  </div>
                {% endif %}
                <label class="checkbox">
                  {{ form.mark_done.as_widget(attrs={'class': 'approve-checkbox'}) }}
                  <span>{% trans "Approve" %}</span>
                </label>
              </td>
            </tr>
            {% endwith %}
          {% endfor %}
        </tbody>
      </table>
      <div class="submit-row">
        <button type="button" class="button" data-toggle-approvals>
          {% trans "Toggle selections" %}
        </button>
        <button type="submit" name="action" value="save" class="button default">
          {% trans "Save changes" %}
        </button>
        <button type="submit" name="action" value="approve" class="button">
          {% trans "Approve selected TODOs" %}
        </button>
      </div>
    </form>
  {% else %}
    <p class="help-empty">{% trans "No pending TODOs require approval." %}</p>
  {% endif %}
</div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.querySelector('.pending-todos-form');
    if (!form) {
      return;
    }

    const toggleButton = form.querySelector('[data-toggle-approvals]');
    if (!toggleButton) {
      return;
    }

    toggleButton.addEventListener('click', function (event) {
      event.preventDefault();
      const checkboxes = form.querySelectorAll('input[type="checkbox"][name$="-mark_done"]');
      checkboxes.forEach(function (checkbox) {
        if (checkbox.disabled) {
          return;
        }
        checkbox.checked = !checkbox.checked;
        checkbox.dispatchEvent(new Event('change', { bubbles: true }));
      });
    });
  });
</script>
{% endblock %}
