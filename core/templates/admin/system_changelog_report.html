{% extends "admin/base_site.html" %}
{% load i18n %}

{% block extrastyle %}
  {{ block.super }}
  <style>
    .open-changelog .changelog-refresh-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin: 0 0 0.5rem;
    }

    .open-changelog .changelog-refresh-actions form {
      margin: 0;
    }

    /* Use .changelog-action-button for future action buttons on this screen to keep styling consistent. */
    .open-changelog .changelog-action-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 1.25rem;
      gap: 0.375rem;
      min-height: 2.5rem;
    }
  </style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
  <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
  &rsaquo; <a href="{% url 'admin:system' %}">{% trans 'System' %}</a>
  &rsaquo; {% trans "Changelog Report" %}
</div>
{% endblock %}

{% block content %}
<div id="content-main">
  <div class="module open-changelog">
    <div class="changelog-refresh-actions">
      <form method="post" class="changelog-refresh-form">
        {% csrf_token %}
        <input type="hidden" name="action" value="recalculate">
        <button type="submit" class="button default changelog-action-button">
          {% trans "Recalculate changelog" %}
        </button>
      </form>
      <form method="post" class="changelog-commit-form">
        {% csrf_token %}
        <input type="hidden" name="action" value="commit">
        <button type="submit" class="button default changelog-action-button">
          {% trans "Commit changelog" %}
        </button>
      </form>
      {% if open_changelog_entries %}
        <button type="submit" class="button default changelog-action-button" form="changelog-exclude-form">
          {% trans "Exclude selected" %}
        </button>
      {% endif %}
    </div>
    <h2>{% trans "Open Changelog" %}</h2>
    {% if open_changelog_entries %}
      <form method="post" class="changelog-exclude-form" id="changelog-exclude-form">
        {% csrf_token %}
        <input type="hidden" name="action" value="exclude">
        <table class="table table-striped">
          <thead>
            <tr>
              <th scope="col">{% trans "Select" %}</th>
              <th scope="col">{% trans "Commit" %}</th>
              <th scope="col">{% trans "Message" %}</th>
            </tr>
          </thead>
          <tbody>
          {% for entry in open_changelog_entries %}
            {% with checkbox_id="exclude-sha-"|add:forloop.counter %}
            <tr>
              <td>
                <input type="checkbox" id="{{ checkbox_id }}" name="selected_shas" value="{{ entry.sha }}">
              </td>
              <td>
                <label for="{{ checkbox_id }}">
                  {% if entry.url %}
                    <a href="{{ entry.url }}" target="_blank" rel="noopener">
                      <code>{{ entry.sha }}</code>
                    </a>
                  {% else %}
                    <code>{{ entry.sha }}</code>
                  {% endif %}
                </label>
              </td>
              <td>{{ entry.message|default:"" }}</td>
            </tr>
            {% endwith %}
          {% endfor %}
          </tbody>
        </table>
      </form>
    {% else %}
      <p class="help">{% trans "No pending changelog entries." %}</p>
    {% endif %}
  </div>
  <div class="module latest-release-changelog">
    <h2>{% trans "Last Release Changelog" %}</h2>
    {% if latest_release_changelog.title %}
      <p class="help">
        {% blocktrans with release_title=latest_release_changelog.title %}
          Entries from {{ release_title }} are shown for reference.
        {% endblocktrans %}
      </p>
      {% if latest_release_changelog.entries %}
        <table class="table table-striped">
          <thead>
            <tr>
              <th scope="col">{% trans "Commit" %}</th>
              <th scope="col">{% trans "Message" %}</th>
            </tr>
          </thead>
          <tbody>
          {% for entry in latest_release_changelog.entries %}
            <tr>
              <td>
                {% if entry.url %}
                  <a href="{{ entry.url }}" target="_blank" rel="noopener">
                    <code>{{ entry.sha }}</code>
                  </a>
                {% else %}
                  <code>{{ entry.sha }}</code>
                {% endif %}
              </td>
              <td>{{ entry.message|default:"" }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p class="help">{% trans "No entries recorded for the latest release." %}</p>
      {% endif %}
    {% else %}
      <p class="help">{% trans "No previous releases have been recorded yet." %}</p>
    {% endif %}
  </div>
</div>
{% endblock %}
