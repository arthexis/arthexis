{% extends "admin/change_form.html" %}
{% load i18n %}

{% block extrastyle %}
{{ block.super }}
<style>
    #content-main {
        margin-right: 240px;
    }

    #user-section-nav {
        position: fixed;
        top: 120px;
        right: 32px;
        width: 200px;
        max-height: calc(100vh - 160px);
        overflow-y: auto;
        background: var(--body-bg, #fff);
        border-left: 1px solid var(--hairline-color, #e0e0e0);
        padding: 12px 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        font-size: 0.85rem;
        z-index: 2;
    }

    #user-section-nav.hidden {
        display: none;
    }

    #user-section-nav h2 {
        margin: 0 0 0.5em;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--body-quiet-color, #666);
    }

    #user-section-nav ul {
        list-style: none;
        margin: 0;
        padding: 0;
    }

    #user-section-nav li {
        margin-bottom: 0.5em;
    }

    #user-section-nav a {
        color: var(--link-fg, #0b6fad);
        text-decoration: none;
    }

    #user-section-nav a:hover,
    #user-section-nav a:focus {
        text-decoration: underline;
    }

    @media (max-width: 1200px) {
        #content-main {
            margin-right: 0;
        }

        #user-section-nav {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content_title %}
<div style="display:flex; justify-content:space-between; align-items:center;">
    <h1>{{ title }}</h1>
</div>
{% endblock %}

{% block content %}
{{ block.super }}
<nav id="user-section-nav" aria-label="{% trans 'User sections' %}">
    <h2>{% trans "Sections" %}</h2>
    <ul></ul>
</nav>
{% endblock %}

{% block admin_change_form_document_ready %}
{{ block.super }}
<script>
    (function () {
        function slugify(text) {
            return text
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, "-")
                .replace(/^-+|-+$/g, "")
                .replace(/-{2,}/g, "-");
        }

        function buildNav() {
            var nav = document.getElementById("user-section-nav");
            if (!nav) {
                return;
            }
            var list = nav.querySelector("ul");
            if (!list) {
                return;
            }

            var seenIds = {};
            var headings = document.querySelectorAll(
                "#content-main form h2.fieldset-heading, #content-main form h2.inline-heading"
            );

            headings.forEach(function (heading) {
                var text = heading.textContent ? heading.textContent.trim() : "";
                if (!text) {
                    return;
                }
                var id = heading.id;
                if (!id) {
                    id = slugify(text) || "section";
                }
                if (seenIds[id]) {
                    var counter = 2;
                    while (seenIds[id + "-" + counter]) {
                        counter += 1;
                    }
                    id = id + "-" + counter;
                }
                seenIds[id] = true;
                heading.id = id;

                var item = document.createElement("li");
                var link = document.createElement("a");
                link.href = "#" + id;
                link.textContent = text;
                item.appendChild(link);
                list.appendChild(item);
            });

            if (!list.children.length) {
                nav.classList.add("hidden");
            }
        }

        if (document.readyState !== "loading") {
            buildNav();
        } else {
            document.addEventListener("DOMContentLoaded", buildNav);
        }
    })();
</script>
{% endblock %}
