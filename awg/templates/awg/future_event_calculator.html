{% extends "pages/base.html" %}
{% load i18n tz %}
{% block title %}{% trans "Future Event Calculator" %}{% endblock %}
{% block content %}
<div class="container py-4">
  <h1 class="text-center mb-4">{% trans "Future Event Calculator" %}</h1>
  <style>
    .countdown-wrapper {
      max-width: 960px;
      margin: 0 auto;
      width: 100%;
    }
    .countdown-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1.25rem;
      width: 100%;
      max-width: 720px;
      margin: 0 auto;
    }
    .countdown-segment {
      background: var(--bs-body-bg);
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 1rem;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.08);
      padding: 1.5rem 1rem;
      text-align: center;
    }
    .countdown-value {
      font-size: clamp(3rem, 9vw, 5.5rem);
      font-weight: 700;
      letter-spacing: 0.08em;
      line-height: 1.1;
    }
    .countdown-label {
      font-size: clamp(0.85rem, 2.5vw, 1.2rem);
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: var(--bs-secondary-color);
      margin-top: 0.75rem;
    }
    .countdown-body {
      max-width: 100%;
    }
    .countdown-carousel {
      width: 100%;
      position: relative;
      overflow: hidden;
    }
    .countdown-carousel[data-enhanced="true"] {
      isolation: isolate;
    }
    .countdown-track {
      display: flex;
      flex-direction: column;
      gap: 2rem;
      transition: none;
    }
    .countdown-carousel[data-enhanced="true"] .countdown-track {
      gap: 0;
      transition: transform 0.6s ease;
    }
    .countdown-slide {
      position: relative;
      padding: 1.5rem 1rem 2.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
    }
    .countdown-slide[data-has-link="true"] {
      cursor: pointer;
    }
    .countdown-slide:focus-visible {
      outline: 2px solid var(--bs-primary);
      outline-offset: 4px;
    }
    .countdown-controls {
      width: 100%;
      max-width: 360px;
    }
    .countdown-indicators {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .countdown-indicator {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background-color: rgba(108, 117, 125, 0.45);
      transition: transform 0.3s ease, background-color 0.3s ease;
    }
    .countdown-indicator[data-active="true"] {
      background-color: var(--bs-primary);
      transform: scale(1.15);
    }
    @media (max-width: 576px) {
      .countdown-wrapper {
        padding: 0 0.5rem;
      }
    }
  </style>
  {% if events %}
  <div class="countdown-wrapper d-flex flex-column align-items-center gap-4" data-event-carousel>
    <div class="countdown-carousel" data-event-view>
      <div class="countdown-track" data-event-track>
        {% for item in events %}
        <article
          class="countdown-slide text-center"
          data-event-slide
          tabindex="-1"
          {% if item.article_url %}data-has-link="true"{% endif %}
        >
          {% if item.article_url %}
          <a
            class="stretched-link"
            href="{{ item.article_url }}"
            aria-label="{% blocktrans with event_title=item.timer.title %}View developer article for {{ event_title }}{% endblocktrans %}"
          ></a>
          {% endif %}
          <div class="countdown-slide-body w-100">
            <h2 class="fw-bold mb-2">{{ item.timer.title }}</h2>
            {% if item.timer.body %}
            <p class="lead countdown-body mb-3">{{ item.timer.body|linebreaksbr }}</p>
            {% endif %}
            <p class="text-muted mb-0">{% blocktrans with scheduled=item.scheduled %}Scheduled for {{ scheduled }}{% endblocktrans %}</p>
          </div>
          <div class="countdown-grid" data-countdown data-target="{{ item.target_iso }}">
            <div class="countdown-segment">
              <div class="countdown-value" data-countdown-days>00</div>
              <div class="countdown-label">{% trans "Days" %}</div>
            </div>
            <div class="countdown-segment">
              <div class="countdown-value" data-countdown-hours>00</div>
              <div class="countdown-label">{% trans "Hours" %}</div>
            </div>
            <div class="countdown-segment">
              <div class="countdown-value" data-countdown-minutes>00</div>
              <div class="countdown-label">{% trans "Minutes" %}</div>
            </div>
            <div class="countdown-segment">
              <div class="countdown-value" data-countdown-seconds>00</div>
              <div class="countdown-label">{% trans "Seconds" %}</div>
            </div>
          </div>
          {% if item.article_url %}
          <div class="mt-2">
            <span class="badge text-bg-primary fw-semibold">{% trans "Read article" %}</span>
          </div>
          {% endif %}
        </article>
        {% endfor %}
      </div>
    </div>
    {% if events|length > 1 %}
    <div class="countdown-controls d-flex align-items-center justify-content-center gap-3">
      <button type="button" class="btn btn-outline-secondary btn-sm px-3" data-event-prev aria-label="{% trans 'Previous event' %}">&lsaquo;</button>
      <div class="countdown-indicators" aria-hidden="true">
        {% for item in events %}
        <span class="countdown-indicator" data-event-indicator="{{ forloop.counter0 }}"></span>
        {% endfor %}
      </div>
      <button type="button" class="btn btn-outline-secondary btn-sm px-3" data-event-next aria-label="{% trans 'Next event' %}">&rsaquo;</button>
    </div>
    {% endif %}
    <p class="text-center text-muted mb-0">{% trans "The countdown updates automatically in real time." %}</p>
  </div>
  <script>
    (function () {
      const containers = Array.from(document.querySelectorAll('[data-countdown]'));
      if (!containers.length) {
        return;
      }

      const timers = containers
        .map((container) => {
          const targetString = container.getAttribute('data-target');
          if (!targetString) {
            return null;
          }
          const target = new Date(targetString);
          if (Number.isNaN(target.getTime())) {
            return null;
          }
          const segments = {
            days: container.querySelector('[data-countdown-days]'),
            hours: container.querySelector('[data-countdown-hours]'),
            minutes: container.querySelector('[data-countdown-minutes]'),
            seconds: container.querySelector('[data-countdown-seconds]'),
          };
          if (!segments.days || !segments.hours || !segments.minutes || !segments.seconds) {
            return null;
          }
          return { target, segments };
        })
        .filter(Boolean);

      if (!timers.length) {
        return;
      }

      const format = (value) => String(value).padStart(2, '0');

      const updateTimer = (timer) => {
        const now = new Date();
        let diff = timer.target.getTime() - now.getTime();
        if (diff <= 0) {
          timer.segments.days.textContent = '00';
          timer.segments.hours.textContent = '00';
          timer.segments.minutes.textContent = '00';
          timer.segments.seconds.textContent = '00';
          return;
        }

        const totalSeconds = Math.floor(diff / 1000);
        const days = Math.floor(totalSeconds / 86400);
        const hours = Math.floor((totalSeconds % 86400) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        timer.segments.days.textContent = format(days);
        timer.segments.hours.textContent = format(hours);
        timer.segments.minutes.textContent = format(minutes);
        timer.segments.seconds.textContent = format(seconds);
      };

      const tick = () => {
        timers.forEach(updateTimer);
      };

      tick();
      const interval = window.setInterval(tick, 1000);

      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          tick();
        }
      });

      window.addEventListener('beforeunload', () => {
        window.clearInterval(interval);
      });
    })();
  </script>
  <script>
    (function () {
      const carousel = document.querySelector('[data-event-carousel]');
      if (!carousel) {
        return;
      }

      const view = carousel.querySelector('[data-event-view]');
      const track = carousel.querySelector('[data-event-track]');
      const slides = track ? Array.from(track.querySelectorAll('[data-event-slide]')) : [];
      if (!view || !track || !slides.length) {
        return;
      }

      const prevButton = carousel.querySelector('[data-event-prev]');
      const nextButton = carousel.querySelector('[data-event-next]');
      const indicators = Array.from(carousel.querySelectorAll('[data-event-indicator]'));
      const reduceMotionQuery = window.matchMedia ? window.matchMedia('(prefers-reduced-motion: reduce)') : null;
      let activeIndex = 0;
      let intervalId = null;
      let resizeTimer = null;

      const setIndicators = (index) => {
        indicators.forEach((indicator) => {
          const matches = Number(indicator.dataset.eventIndicator) === index;
          if (matches) {
            indicator.setAttribute('data-active', 'true');
          } else {
            indicator.removeAttribute('data-active');
          }
        });
      };

      const activate = (index, options) => {
        const opts = options || {};
        if (slides.length === 0) {
          return;
        }

        activeIndex = (index + slides.length) % slides.length;
        const activeSlide = slides[activeIndex];
        if (!activeSlide) {
          return;
        }

        if (opts.skipTransition) {
          track.style.transition = 'none';
        }

        carousel.dataset.activeIndex = String(activeIndex);
        slides.forEach((slide, idx) => {
          const isActive = idx === activeIndex;
          slide.toggleAttribute('data-active', isActive);
          if (isActive) {
            slide.removeAttribute('aria-hidden');
          } else {
            slide.setAttribute('aria-hidden', 'true');
          }
        });

        const offset = activeSlide.offsetTop;
        track.style.transform = `translateY(${-offset}px)`;
        view.style.height = `${activeSlide.offsetHeight}px`;
        setIndicators(activeIndex);

        if (opts.focus) {
          activeSlide.focus({ preventScroll: true });
        }

        if (opts.skipTransition) {
          void track.offsetHeight; // force reflow
          track.style.transition = '';
        }
      };

      const shouldAutoAdvance = () => {
        return slides.length > 1 && !(reduceMotionQuery && reduceMotionQuery.matches);
      };

      const clearSchedule = () => {
        if (intervalId !== null) {
          window.clearInterval(intervalId);
          intervalId = null;
        }
      };

      const scheduleAdvance = () => {
        clearSchedule();
        if (!shouldAutoAdvance()) {
          return;
        }
        intervalId = window.setInterval(() => {
          activate(activeIndex + 1);
        }, 8000);
      };

      const go = (delta) => {
        activate(activeIndex + delta, { focus: true });
        scheduleAdvance();
      };

      carousel.dataset.enhanced = 'true';
      slides.forEach((slide) => {
        if (!slide.hasAttribute('tabindex')) {
          slide.setAttribute('tabindex', '-1');
        }
      });

      activate(0, { skipTransition: true });
      scheduleAdvance();

      if (prevButton) {
        prevButton.addEventListener('click', () => go(-1));
      }
      if (nextButton) {
        nextButton.addEventListener('click', () => go(1));
      }

      window.addEventListener('resize', () => {
        window.clearTimeout(resizeTimer);
        resizeTimer = window.setTimeout(() => activate(activeIndex, { skipTransition: true }), 150);
      });

      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          scheduleAdvance();
        } else {
          clearSchedule();
        }
      });

      if (reduceMotionQuery) {
        reduceMotionQuery.addEventListener('change', scheduleAdvance);
      }
    })();
  </script>
  {% else %}
  <div class="text-center py-5">
    <p class="display-6 fw-semibold mb-3">{% trans "No upcoming events" %}</p>
    <p class="text-muted mb-0">{% trans "Add a countdown timer in Horologia to see it here." %}</p>
  </div>
  {% endif %}
</div>
{% endblock %}
