---
- name: Ensure NetworkManager service is enabled
  ansible.builtin.service:
    name: NetworkManager
    enabled: true
    state: started
  when: network_manage_network_manager

- name: Verify nmcli is available
  ansible.builtin.stat:
    path: "{{ network_nmcli_path }}"
  register: network_nmcli_stat
  failed_when: not network_nmcli_stat.stat.exists
  when: network_manage_network_manager

- name: Ensure NetworkManager connection directory exists
  ansible.builtin.file:
    path: "{{ network_connection_directory }}"
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: Enable Wi-Fi radio when requested
  ansible.builtin.command:
    cmd: "{{ network_nmcli_path }} radio wifi on"
  register: network_wifi_radio
  changed_when: false
  failed_when: false
  when: network_enable_wifi_radio

- name: Remove unmanaged NetworkManager profiles
  ansible.builtin.command:
    cmd: "{{ network_nmcli_path }} connection delete '{{ item }}'"
  register: network_remove_profile
  changed_when: network_remove_profile.rc == 0
  failed_when: false
  loop: "{{ network_remove_connections }}"

- name: Install ethernet NetworkManager profile
  ansible.builtin.template:
    src: eth0-shared.nmconnection.j2
    dest: "{{ network_connection_directory }}/{{ network_eth_connection_name }}.nmconnection"
    owner: root
    group: root
    mode: "0600"
  notify:
    - Reload NetworkManager connections
    - Activate ethernet connection

- name: Install Wi-Fi access point profile
  ansible.builtin.template:
    src: wlan0-ap.nmconnection.j2
    dest: "{{ network_connection_directory }}/{{ network_wifi_connection_name }}.nmconnection"
    owner: root
    group: root
    mode: "0600"
  notify:
    - Reload NetworkManager connections
    - Activate Wi-Fi connection
  when: network_wifi_interface | length > 0

- name: Ensure secondary Wi-Fi interface stays disconnected
  ansible.builtin.command:
    cmd: "{{ network_nmcli_path }} device disconnect {{ network_wifi_secondary_interface }}"
  register: network_wifi_secondary_disconnect
  changed_when: network_wifi_secondary_disconnect.rc == 0
  failed_when: false
  when:
    - network_wifi_secondary_interface | length > 0
    - not network_wifi_secondary_autoconnect

- name: Create WireGuard configuration directory
  ansible.builtin.file:
    path: "{{ network_wireguard_directory }}"
    state: directory
    owner: "{{ network_wireguard_owner }}"
    group: "{{ network_wireguard_group }}"
    mode: "0750"
  when: network_constellation_enabled

- name: Install WireGuard constellation configuration
  ansible.builtin.template:
    src: wireguard/constellation.conf.j2
    dest: "{{ network_wireguard_directory }}/{{ network_constellation_interface }}.conf"
    owner: "{{ network_wireguard_owner }}"
    group: "{{ network_wireguard_group }}"
    mode: "{{ network_wireguard_mode }}"
  when:
    - network_constellation_enabled
    - network_constellation_address | length > 0
    - network_constellation_private_key | length > 0
  notify:
    - Restart WireGuard interface
