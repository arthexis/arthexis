name: Publish to PyPI (OIDC)

on:
  workflow_dispatch:
    inputs:
      repository:
        description: "Target repository: pypi or testpypi"
        required: true
        default: "pypi"
      tag:
        description: "Release tag to publish (e.g., v1.2.3)"
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: pypi
    steps:
      - name: Download release artifacts
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          mkdir -p dist
          gh release download "${{ inputs.tag }}" \
            --repo "${{ github.repository }}" \
            --pattern "*.whl" \
            --pattern "*.tar.gz" \
            --dir dist

      - name: Verify wheel and sdist artifacts
        run: |
          ls -la dist
          ls dist/*.whl
          ls dist/*.tar.gz

      - name: Publish to PyPI via OIDC
        uses: pypa/gh-action-pypi-publish@v1.8.11
        with:
          repository-url: ${{ inputs.repository == 'testpypi' && 'https://test.pypi.org/legacy/' || '' }}
          skip-existing: false
          packages-dir: dist
