name: Publish to PyPI (OIDC)

on:
  workflow_dispatch:
    inputs:
      repository:
        description: "Target repository: pypi or testpypi"
        required: true
        default: "pypi"
      tag:
        description: "Release tag to publish (e.g., v1.2.3)"
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.repository == 'testpypi' && 'testpypi' || 'pypi' }}
    steps:
      - name: Download release artifacts
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const fs = require('fs');
            const path = require('path');

            const tag = '${{ inputs.tag }}';
            const { owner, repo } = context.repo;
            const release = await github.rest.repos.getReleaseByTag({
              owner,
              repo,
              tag,
            });

            const assets = release.data.assets.filter((asset) =>
              asset.name.endsWith('.whl') || asset.name.endsWith('.tar.gz')
            );

            if (assets.length === 0) {
              core.setFailed(`No wheel or sdist assets found for tag ${tag}.`);
              return;
            }

            fs.mkdirSync('dist', { recursive: true });

            for (const asset of assets) {
              const download = await github.request(
                'GET /repos/{owner}/{repo}/releases/assets/{asset_id}',
                {
                  owner,
                  repo,
                  asset_id: asset.id,
                  headers: {
                    accept: 'application/octet-stream',
                  },
                }
              );
              const filePath = path.join('dist', asset.name);
              fs.writeFileSync(filePath, Buffer.from(download.data));
            }

      - name: Verify wheel and sdist artifacts
        run: |
          ls -la dist
          ls dist/*.whl
          ls dist/*.tar.gz

      - name: Publish to PyPI via OIDC
        uses: pypa/gh-action-pypi-publish@2f6f737ca5f74c637829c0f5c3acd0e29ea5e8bf # v1.8.11
        with:
          repository-url: ${{ inputs.repository == 'testpypi' && 'https://test.pypi.org/legacy/' || '' }}
          skip-existing: false
          packages-dir: dist
