name: CI

permissions:
  actions: read
  contents: read
  pull-requests: write

env:
  PYTHONDONTWRITEBYTECODE: '1'
  NODE_OPTIONS: '--no-deprecation'
  ARTHEXIS_DB_BACKEND: sqlite

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
  pull_request:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      run_slow_tests:
        description: 'Run slow pytest markers'
        required: false
        default: 'false'

jobs:
  install:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      OCPP_STATE_REDIS_URL: redis://localhost:6379
    steps:
      # GitHub-hosted runners start with a writable workspace; skipping manual chown saves setup time.
      - uses: actions/checkout@v6
        with:
          clean: false
      - uses: actions/setup-python@v6
        with:
          python-version: '3.x'
      - name: Cache pip
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('requirements*.txt', 'pyproject.toml') }}
          restore-keys: |
            pip-${{ runner.os }}-
      - name: Cache virtualenv
        uses: actions/cache@v5
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('requirements*.txt', 'pyproject.toml') }}
          restore-keys: |
            venv-${{ runner.os }}-
      - name: Install suite from repository
        run: |
          ./install.sh --no-start
      - name: Validate migrations
        run: |
          source .venv/bin/activate
          python manage.py makemigrations --check --dry-run
          python manage.py migrate --noinput --database default
      - name: Create docs admin user
        env:
          DOCS_ADMIN_PASSWORD: ${{ secrets.DOCS_ADMIN_PASSWORD }}
        run: |
          set -Eeuo pipefail
          source .venv/bin/activate
          if [ -z "${DOCS_ADMIN_PASSWORD}" ]; then
            DOCS_ADMIN_PASSWORD="$(openssl rand -base64 32)"
          fi
          echo "DOCS_ADMIN_PASSWORD=${DOCS_ADMIN_PASSWORD}" >> "${GITHUB_ENV}"
          python manage.py create_docs_admin --confirm --password "${DOCS_ADMIN_PASSWORD}"
      - name: Check import resolution
        run: |
          source .venv/bin/activate
          python scripts/check_import_resolution.py
      - name: Lint seed fixtures
        run: |
          source .venv/bin/activate
          python scripts/lint_seed_fixtures.py
      - name: Run tests
        run: |
          set -o pipefail
          source .venv/bin/activate
          pytest --maxfail=1 --disable-warnings -q --timeout=180 -m "not slow and not integration" | tee pytest.log
      - name: Upload pytest log
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: install-pytest-log
          path: pytest.log
          if-no-files-found: warn
  docs-changes:
    runs-on: ubuntu-latest
    outputs:
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - uses: actions/checkout@v6
        with:
          clean: false
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            docs:
              - 'docs/**'
              - 'README.md'
              - 'mkdocs.yml'
  docs-links:
    if: ${{ github.event_name == 'schedule' || needs.docs-changes.outputs.docs == 'true' }}
    needs: docs-changes
    runs-on: ubuntu-latest
    steps:
      # GitHub-hosted runners start with a writable workspace; skipping manual chown saves setup time.
      - uses: actions/checkout@v6
        with:
          clean: false
      - uses: actions/setup-python@v6
        with:
          python-version: '3.x'
      - name: Cache pip
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('requirements*.txt', 'pyproject.toml') }}
          restore-keys: |
            pip-${{ runner.os }}-
      - name: Cache virtualenv
        uses: actions/cache@v5
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('requirements*.txt', 'pyproject.toml') }}
          restore-keys: |
            venv-${{ runner.os }}-
      - name: Install suite from repository
        run: |
          ./install.sh --no-start
      - name: Check documentation links use HTTPS
        run: |
          source .venv/bin/activate
          python scripts/check_no_http_links.py
  upgrade:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      OCPP_STATE_REDIS_URL: redis://localhost:6379
    steps:
      # Workspace is already writable on GitHub runners, so we skip the chown to reduce overhead.
      - name: Checkout main
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.repository.default_branch }}
          clean: false
      - uses: actions/setup-python@v6
        with:
          python-version: '3.x'
      - name: Cache pip
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('requirements*.txt', 'pyproject.toml') }}
          restore-keys: |
            pip-${{ runner.os }}-
      - name: Cache virtualenv
        uses: actions/cache@v5
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('requirements*.txt', 'pyproject.toml') }}
          restore-keys: |
            venv-${{ runner.os }}-
      - name: Install from default branch
        run: |
          ./install.sh --no-start
      - name: Checkout PR changes
        uses: actions/checkout@v6
        with:
          clean: false
      - name: Apply upgrade
        run: |
          set -Eeuo pipefail
          source .venv/bin/activate
          ./upgrade.sh --local --no-restart

      - name: Validate upgraded migrations
        run: |
          set -Eeuo pipefail
          source .venv/bin/activate
          python manage.py makemigrations --check --dry-run
          python manage.py migrate --noinput --database default
      - name: Create docs admin user
        env:
          DOCS_ADMIN_PASSWORD: ${{ secrets.DOCS_ADMIN_PASSWORD }}
        run: |
          set -Eeuo pipefail
          source .venv/bin/activate
          if [ -z "${DOCS_ADMIN_PASSWORD}" ]; then
            DOCS_ADMIN_PASSWORD="$(openssl rand -base64 32)"
          fi
          echo "DOCS_ADMIN_PASSWORD=${DOCS_ADMIN_PASSWORD}" >> "${GITHUB_ENV}"
          python manage.py create_docs_admin --confirm --password "${DOCS_ADMIN_PASSWORD}"

      - name: Run tests on upgraded install
        run: |
          set -Eeuo pipefail
          source .venv/bin/activate
          pytest --maxfail=1 --disable-warnings -q --timeout=180 -m "not slow and not integration" | tee pytest.log
      - name: Upload pytest log
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: upgrade-pytest-log
          path: pytest.log
          if-no-files-found: warn
  slow-tests:
    if: ${{ github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.run_slow_tests == 'true') }}
    runs-on: ubuntu-latest
    env:
      RUN_SLOW_TESTS: '1'
      OCPP_STATE_REDIS_URL: redis://localhost:6379
    services:
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v6
        with:
          clean: false
      - uses: actions/setup-python@v6
        with:
          python-version: '3.x'
      - name: Cache pip
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('requirements*.txt', 'pyproject.toml') }}
          restore-keys: |
            pip-${{ runner.os }}-
      - name: Cache virtualenv
        uses: actions/cache@v5
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('requirements*.txt', 'pyproject.toml') }}
          restore-keys: |
            venv-${{ runner.os }}-
      - name: Install suite from repository
        run: |
          ./install.sh --no-start
      - name: Run slow tests
        run: |
          set -o pipefail
          source .venv/bin/activate
          pytest --maxfail=1 --disable-warnings -q --timeout=180 -m "slow or integration" | tee pytest.log
      - name: Upload pytest log
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: slow-tests-pytest-log
          path: pytest.log
          if-no-files-found: warn

  notify-failure:
    if: ${{ failure() && github.event_name == 'pull_request' }}
    needs:
      - install
      - docs-links
      - upgrade
      - slow-tests
    runs-on: ubuntu-latest
    steps:
      - name: Download install pytest log
        if: always()
        uses: actions/download-artifact@v7
        continue-on-error: true
        with:
          name: install-pytest-log
          path: artifacts/install-pytest-log
      - name: Download upgrade pytest log
        if: always()
        uses: actions/download-artifact@v7
        continue-on-error: true
        with:
          name: upgrade-pytest-log
          path: artifacts/upgrade-pytest-log
      - name: Download slow tests pytest log
        if: always()
        uses: actions/download-artifact@v7
        continue-on-error: true
        with:
          name: slow-tests-pytest-log
          path: artifacts/slow-tests-pytest-log
      - name: Comment on PR with failure summary
        uses: actions/github-script@v8
        env:
          INSTALL_RESULT: ${{ needs.install.result }}
          DOCS_LINKS_RESULT: ${{ needs.docs-links.result }}
          UPGRADE_RESULT: ${{ needs.upgrade.result }}
          SLOW_TESTS_RESULT: ${{ needs.slow-tests.result }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            const prNumber = context.payload.pull_request?.number;
            if (!prNumber) {
              core.info('No pull request context available for commenting.');
              return;
            }

            const results = {
              install: process.env.INSTALL_RESULT,
              'docs-links': process.env.DOCS_LINKS_RESULT,
              upgrade: process.env.UPGRADE_RESULT,
              'slow-tests': process.env.SLOW_TESTS_RESULT
            };

            const failedJobs = Object.entries(results)
              .filter(([, result]) => result === 'failure')
              .map(([name]) => `- ${name}`)
              .join('\n');

            const summaryLines = failedJobs || '- One or more jobs failed. Review the workflow run for details.';

            const logFiles = {
              install: 'artifacts/install-pytest-log/pytest.log',
              upgrade: 'artifacts/upgrade-pytest-log/pytest.log',
              'slow-tests': 'artifacts/slow-tests-pytest-log/pytest.log'
            };

            const logBlocks = Object.entries(logFiles)
              .map(([job, filePath]) => {
                if (!fs.existsSync(filePath)) {
                  return null;
                }
                const content = fs.readFileSync(filePath, 'utf8').trim();
                if (!content) {
                  return null;
                }
                const lines = content.split('\n');
                const tail = lines.slice(-200).join('\n');
                return [
                  `### ${job} pytest log (tail)`,
                  '```',
                  tail,
                  '```'
                ].join('\n');
              })
              .filter(Boolean)
              .join('\n\n');

            const body = [
              '@arthexis @codex CI failed for this PR.',
              '',
              '### Failed job summary',
              summaryLines,
              logBlocks ? `\n${logBlocks}` : '',
              '',
              `View the workflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body
            });
