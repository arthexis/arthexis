name: Screenshot

env:
  PYTHONDONTWRITEBYTECODE: '1'
  PLAYWRIGHT_VERSION: '1.45.2'

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/dashboard-screenshot.yml'
      - 'apps/**'
      - 'config/**'
      - 'scripts/**'
      - 'start.sh'
      - 'install.sh'
      - 'requirements.txt'
  pull_request:
    paths:
      - '.github/workflows/dashboard-screenshot.yml'
      - 'apps/**'
      - 'config/**'
      - 'scripts/**'
      - 'start.sh'
      - 'install.sh'
      - 'requirements.txt'

jobs:
  capture-dashboard:
    name: Capture admin dashboard
    runs-on: ubuntu-latest
    steps:
      - name: Ensure workspace is writable
        run: sudo chown -R "$USER:$USER" "$GITHUB_WORKSPACE"

      - uses: actions/checkout@v6
        with:
          clean: false

      - uses: actions/setup-python@v6
        with:
          python-version: '3.x'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Install suite from repository
        run: |
          ./install.sh --clean --no-start

      - name: Prepare database and admin account
        run: |
          source .venv/bin/activate
          python manage.py migrate --noinput --database default
          python manage.py check_admin --force
          python manage.py collectstatic --noinput

      - name: Seed OCPP demo data
        run: |
          source .venv/bin/activate
          python manage.py shell <<'PY'
          from decimal import Decimal
          from django.utils import timezone

          from apps.ocpp.models import Charger, MeterValue, Transaction

          now = timezone.now()
          charger, _ = Charger.objects.get_or_create(
              charger_id="SIM-CP-1",
              defaults={
                  "display_name": "Simulated Charger",
                  "connector_id": 1,
                  "public_display": True,
                  "last_status": "Charging",
                  "last_heartbeat": now,
              },
          )

          active_tx, _ = Transaction.objects.get_or_create(
              charger=charger,
              connector_id=1,
              stop_time=None,
              defaults={
                  "start_time": now - timezone.timedelta(minutes=15),
                  "received_start_time": now - timezone.timedelta(minutes=15),
                  "meter_start": 1000,
                  "ocpp_transaction_id": "SIM-ACTIVE",
              },
          )

          completed_tx, _ = Transaction.objects.get_or_create(
              charger=charger,
              connector_id=1,
              ocpp_transaction_id="SIM-COMPLETED",
              defaults={
                  "start_time": now - timezone.timedelta(hours=2),
                  "stop_time": now - timezone.timedelta(hours=1, minutes=30),
                  "received_start_time": now - timezone.timedelta(hours=2),
                  "received_stop_time": now - timezone.timedelta(hours=1, minutes=30),
                  "meter_start": 800,
                  "meter_stop": 1200,
              },
          )

          MeterValue.objects.get_or_create(
              charger=charger,
              transaction=completed_tx,
              connector_id=1,
              timestamp=completed_tx.stop_time or now,
              defaults={
                  "context": "Sample.Periodic",
                  "energy": Decimal("4.200"),
              },
          )

          MeterValue.objects.get_or_create(
              charger=charger,
              transaction=active_tx,
              connector_id=1,
              timestamp=now,
              defaults={
                  "context": "Sample.Periodic",
                  "energy": Decimal("1.800"),
              },
          )
          PY

      - name: Launch application server
        env:
          PORT: 8888
        run: |
          source .venv/bin/activate
          DJANGO_SUPPRESS_MIGRATION_CHECK=1 python manage.py runserver 0.0.0.0:"${PORT}" --noreload > /tmp/django-server.log 2>&1 &
          echo $! > /tmp/django-server.pid

          echo "Waiting for server to become healthy..."
          healthy=false
          for attempt in {1..30}; do
            if curl -fsS "http://localhost:${PORT}/admin/login/?next=/admin/" >/dev/null; then
              healthy=true
              break
            fi
            sleep 2
          done

          if [ "$healthy" = false ]; then
            echo "Server failed to start in time. Recent logs:"
            tail -n 50 /tmp/django-server.log || true
            exit 1
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}-playwright-${{ env.PLAYWRIGHT_VERSION }}
          restore-keys: |
            npm-${{ runner.os }}-

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ env.PLAYWRIGHT_VERSION }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install Playwright Chromium
        run: |
          npm install --no-save playwright@"${PLAYWRIGHT_VERSION}"
          npx playwright install --with-deps chromium

      - name: Capture dashboard screenshot
        env:
          BASE_URL: http://localhost:8888/admin/login/?next=/admin/
          ADMIN_USERNAME: admin
          ADMIN_PASSWORD: admin
        run: |
          mkdir -p artifacts
          cat > artifacts/capture.js <<'NODE'
          const { chromium } = require('playwright');

          const baseUrl = process.env.BASE_URL || 'http://localhost:8888/admin/login/?next=/admin/';
          const username = process.env.ADMIN_USERNAME || 'admin';
          const password = process.env.ADMIN_PASSWORD || 'admin';

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();

            await page.goto(baseUrl, { waitUntil: 'networkidle' });
            await page.fill('input[name="username"]', username);
            await page.fill('input[name="password"]', password);
            await Promise.all([
              page.waitForNavigation({ waitUntil: 'networkidle' }),
              page.click('input[type="submit"], button[type="submit"]'),
            ]);
            await page.waitForLoadState('networkidle');
            await page.screenshot({ path: 'artifacts/admin-dashboard.png', fullPage: true });

            await browser.close();
          })().catch((error) => {
            console.error(error);
            process.exit(1);
          });
          NODE

          node artifacts/capture.js

      - name: Upload dashboard screenshot
        uses: actions/upload-artifact@v6
        with:
          name: admin-dashboard
          path: artifacts/admin-dashboard.png

      - name: Capture public screenshot
        env:
          BASE_URL: http://localhost:8888/
        run: |
          mkdir -p artifacts
          cat > artifacts/capture-public.js <<'NODE'
          const { chromium } = require('playwright');

          const baseUrl = process.env.BASE_URL || 'http://localhost:8888/';

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();

            await page.goto(baseUrl, { waitUntil: 'networkidle' });
            await page.waitForLoadState('networkidle');
            await page.screenshot({ path: 'artifacts/public-site.png', fullPage: true });

            await browser.close();
          })().catch((error) => {
            console.error(error);
            process.exit(1);
          });
          NODE

          node artifacts/capture-public.js

      - name: Upload public screenshot
        uses: actions/upload-artifact@v6
        with:
          name: public-site
          path: artifacts/public-site.png

      - name: Capture OCPP dashboard screenshot
        env:
          BASE_URL: http://localhost:8888
          ADMIN_USERNAME: admin
          ADMIN_PASSWORD: admin
        run: |
          mkdir -p artifacts
          cat > artifacts/capture-ocpp.js <<'NODE'
          const { chromium } = require('playwright');

          const baseUrl = process.env.BASE_URL || 'http://localhost:8888';
          const username = process.env.ADMIN_USERNAME || 'admin';
          const password = process.env.ADMIN_PASSWORD || 'admin';
          const loginUrl = `${baseUrl}/login/?next=/ocpp/cpms/dashboard/`;
          const dashboardUrl = `${baseUrl}/ocpp/cpms/dashboard/`;

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();

            await page.goto(loginUrl, { waitUntil: 'networkidle' });
            await page.fill('input[name="username"]', username);
            await page.fill('input[name="password"]', password);
            await Promise.all([
              page.waitForNavigation({ waitUntil: 'networkidle' }),
              page.click('button[type="submit"], input[type="submit"]'),
            ]);

            await page.goto(dashboardUrl, { waitUntil: 'networkidle' });
            await page.waitForLoadState('networkidle');
            await page.waitForTimeout(1000);
            await page.screenshot({ path: 'artifacts/ocpp-dashboard.png', fullPage: true });

            await browser.close();
          })().catch((error) => {
            console.error(error);
            process.exit(1);
          });
          NODE

          node artifacts/capture-ocpp.js

      - name: Upload OCPP dashboard screenshot
        uses: actions/upload-artifact@v6
        with:
          name: ocpp-dashboard
          path: artifacts/ocpp-dashboard.png

      - name: Capture EVCS public screenshot
        env:
          BASE_URL: http://localhost:8888
        run: |
          mkdir -p artifacts
          cat > artifacts/capture-evcs.js <<'NODE'
          const { chromium } = require('playwright');

          const baseUrl = process.env.BASE_URL || 'http://localhost:8888';
          const publicUrl = `${baseUrl}/ocpp/c/SIM-CP-1/`;

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();

            await page.goto(publicUrl, { waitUntil: 'networkidle' });
            await page.waitForLoadState('networkidle');
            await page.waitForTimeout(1000);
            await page.screenshot({ path: 'artifacts/evcs-public.png', fullPage: true });

            await browser.close();
          })().catch((error) => {
            console.error(error);
            process.exit(1);
          });
          NODE

          node artifacts/capture-evcs.js

      - name: Upload EVCS public screenshot
        uses: actions/upload-artifact@v6
        with:
          name: evcs-public
          path: artifacts/evcs-public.png

      - name: Stop application server
        if: always()
        run: |
          if [ -f /tmp/django-server.pid ]; then
            kill $(cat /tmp/django-server.pid) || true
            rm /tmp/django-server.pid
          fi
          if [ -f /tmp/django-server.log ]; then
            echo "Server log tail:" && tail -n 20 /tmp/django-server.log || true
          fi
