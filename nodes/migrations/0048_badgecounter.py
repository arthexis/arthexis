# Generated by Django 5.2.8 on 2025-11-27 14:03

import django.db.models.deletion
from django.db import migrations, models


def create_default_badge_counters(apps, schema_editor):
    ContentType = apps.get_model("contenttypes", "ContentType")
    BadgeCounter = apps.get_model("nodes", "BadgeCounter")

    def get_content_type(app_label, model):
        try:
            model_class = apps.get_model(app_label, model)
        except LookupError:
            return None
        return ContentType.objects.get_for_model(
            model_class, for_concrete_model=False
        )

    entries = [
        {
            "content_type": get_content_type("core", "rfid"),
            "name": "RFID release status",
            "priority": 0,
            "css_class": "rfid-release-badge",
            "primary_source_type": "callable",
            "primary_source": "nodes.badge_values.rfid_release_stats",
        },
        {
            "content_type": get_content_type("ocpp", "charger"),
            "name": "Charger availability",
            "priority": 10,
            "css_class": "charger-availability-badge",
            "primary_source_type": "callable",
            "primary_source": "nodes.badge_values.charger_availability_stats",
        },
        {
            "content_type": get_content_type("teams", "invitelead"),
            "name": "Open leads",
            "priority": 20,
            "css_class": "lead-open-badge",
            "primary_source_type": "callable",
            "primary_source": "nodes.badge_values.open_lead_count",
        },
        {
            "content_type": get_content_type("teams", "powerlead"),
            "name": "Open power leads",
            "priority": 25,
            "css_class": "lead-open-badge",
            "primary_source_type": "callable",
            "primary_source": "nodes.badge_values.open_lead_count",
        },
        {
            "content_type": get_content_type("nodes", "node"),
            "name": "Known nodes",
            "priority": 30,
            "css_class": "node-count-badge",
            "primary_source_type": "callable",
            "primary_source": "nodes.badge_values.node_known_count",
        },
    ]

    for entry in entries:
        content_type = entry.pop("content_type")
        if content_type is None:
            continue
        BadgeCounter.objects.update_or_create(
            content_type=content_type,
            name=entry["name"],
            defaults=entry,
        )


def delete_default_badge_counters(apps, schema_editor):
    BadgeCounter = apps.get_model("nodes", "BadgeCounter")
    BadgeCounter.objects.filter(
        primary_source__in=[
            "nodes.badge_values.rfid_release_stats",
            "nodes.badge_values.charger_availability_stats",
            "nodes.badge_values.open_lead_count",
            "nodes.badge_values.node_known_count",
        ]
    ).delete()


class Migration(migrations.Migration):

    dependencies = [
        ("contenttypes", "0002_remove_content_type_name"),
        ("nodes", "0047_remove_roleconfigurationprofile_role_and_more"),
    ]

    operations = [
        migrations.CreateModel(
            name="BadgeCounter",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("name", models.CharField(max_length=150)),
                (
                    "label_template",
                    models.CharField(
                        blank=True,
                        help_text="Optional label template that can reference {name}, {primary}, {secondary}, and {separator}. Badge counters are intended for values that do not change often; remember to invalidate the cache after updates.",
                        max_length=255,
                    ),
                ),
                (
                    "priority",
                    models.PositiveIntegerField(
                        default=0,
                        help_text="Lower values appear first from left to right.",
                    ),
                ),
                (
                    "separator",
                    models.CharField(
                        default="/",
                        help_text="Symbol shown between counters when two values are present.",
                        max_length=8,
                    ),
                ),
                (
                    "primary_source_type",
                    models.CharField(
                        choices=[
                            ("sigil", "Sigil string"),
                            ("callable", "Python callable"),
                        ],
                        default="sigil",
                        max_length=20,
                    ),
                ),
                (
                    "primary_source",
                    models.CharField(
                        help_text="Value source expressed as [sigils] or a dotted callable path. Badge counters are intended for values that do not change often and may require manual cache invalidation.",
                        max_length=255,
                    ),
                ),
                (
                    "secondary_source_type",
                    models.CharField(
                        blank=True,
                        choices=[
                            ("sigil", "Sigil string"),
                            ("callable", "Python callable"),
                        ],
                        max_length=20,
                        null=True,
                    ),
                ),
                ("secondary_source", models.CharField(blank=True, max_length=255)),
                (
                    "css_class",
                    models.CharField(
                        default="badge-counter",
                        help_text="Additional CSS classes applied to the badge span.",
                        max_length=100,
                    ),
                ),
                ("is_enabled", models.BooleanField(default=True)),
                (
                    "content_type",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="badge_counters",
                        to="contenttypes.contenttype",
                        verbose_name="model",
                    ),
                ),
            ],
            options={
                "verbose_name": "Badge Counter",
                "verbose_name_plural": "Badge Counters",
                "ordering": ("priority", "pk"),
                "unique_together": {("content_type", "name")},
            },
        ),
        migrations.RunPython(
            create_default_badge_counters, delete_default_badge_counters
        ),
    ]
