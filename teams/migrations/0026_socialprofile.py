# Generated by Django 5.2.8 on 2025-11-29 00:58

import core.fields
import django.core.validators
import django.db.models.deletion
import re
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0122_delete_socialprofile"),
        ("teams", "0025_merge_20251128_1824"),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.SeparateDatabaseAndState(
            database_operations=[],
            state_operations=[
                migrations.CreateModel(
                    name="SocialProfile",
                    fields=[
                        (
                            "id",
                            models.BigAutoField(
                                auto_created=True,
                                primary_key=True,
                                serialize=False,
                                verbose_name="ID",
                            ),
                        ),
                        ("is_seed_data", models.BooleanField(default=False, editable=False)),
                        ("is_user_data", models.BooleanField(default=False, editable=False)),
                        ("is_deleted", models.BooleanField(default=False, editable=False)),
                        (
                            "network",
                            models.CharField(
                                choices=[("bluesky", "Bluesky"), ("discord", "Discord")],
                                default="bluesky",
                                help_text="Select the social network you want to connect. Bluesky and Discord are supported.",
                                max_length=32,
                            ),
                        ),
                        (
                            "handle",
                            models.CharField(
                                blank=True,
                                help_text="Bluesky handle that should resolve to Arthexis. Use the verified domain (for example arthexis.com).",
                                max_length=253,
                                validators=[
                                    django.core.validators.RegexValidator(
                                        code="invalid",
                                        message="Enter a valid domain name such as example.com.",
                                        regex=re.compile(
                                            "^(?=.{1,253}\\Z)(?!-)[A-Za-z0-9-]{1,63}(?<!-)(\\.(?!-)[A-Za-z0-9-]{1,63}(?<!-))*$"
                                        ),
                                    )
                                ],
                            ),
                        ),
                        (
                            "domain",
                            models.CharField(
                                blank=True,
                                help_text="Domain that hosts the Bluesky verification. Publish a _atproto TXT record or a /.well-known/atproto-did file with the DID below.",
                                max_length=253,
                                validators=[
                                    django.core.validators.RegexValidator(
                                        code="invalid",
                                        message="Enter a valid domain name such as example.com.",
                                        regex=re.compile(
                                            "^(?=.{1,253}\\Z)(?!-)[A-Za-z0-9-]{1,63}(?<!-)(\\.(?!-)[A-Za-z0-9-]{1,63}(?<!-))*$"
                                        ),
                                    )
                                ],
                            ),
                        ),
                        (
                            "did",
                            models.CharField(
                                blank=True,
                                help_text="Optional DID that Bluesky assigns once the domain is linked (for example did:plc:1234abcd).",
                                max_length=255,
                                validators=[
                                    django.core.validators.RegexValidator(
                                        code="invalid",
                                        message="Enter a valid DID such as did:plc:1234abcd.",
                                        regex="^(|did:[a-z0-9]+:[A-Za-z0-9.\\-_:]+)$",
                                    )
                                ],
                            ),
                        ),
                        (
                            "application_id",
                            models.CharField(
                                blank=True,
                                help_text="Discord application ID used to control the bot.",
                                max_length=32,
                            ),
                        ),
                        (
                            "public_key",
                            models.CharField(
                                blank=True,
                                help_text="Discord public key used to verify interaction requests.",
                                max_length=128,
                            ),
                        ),
                        (
                            "guild_id",
                            models.CharField(
                                blank=True,
                                help_text="Discord guild (server) identifier where the bot should operate.",
                                max_length=32,
                            ),
                        ),
                        (
                            "bot_token",
                            core.fields.SigilShortAutoField(
                                blank=True,
                                help_text="Discord bot token required for authenticated actions.",
                                max_length=255,
                            ),
                        ),
                        (
                            "default_channel_id",
                            models.CharField(
                                blank=True,
                                help_text="Optional Discord channel identifier used for default messaging.",
                                max_length=32,
                            ),
                        ),
                        (
                            "group",
                            models.OneToOneField(
                                blank=True,
                                null=True,
                                on_delete=django.db.models.deletion.CASCADE,
                                related_name="+",
                                to="core.securitygroup",
                            ),
                        ),
                        (
                            "user",
                            models.OneToOneField(
                                blank=True,
                                null=True,
                                on_delete=django.db.models.deletion.CASCADE,
                                related_name="+",
                                to=settings.AUTH_USER_MODEL,
                            ),
                        ),
                    ],
                    options={
                        "verbose_name": "Social Identity",
                        "verbose_name_plural": "Social Identities",
                        "db_table": "core_socialprofile",
                        "abstract": False,
                        "constraints": [
                            models.UniqueConstraint(
                                condition=models.Q(("handle", ""), _negated=True),
                                fields=("network", "handle"),
                                name="socialprofile_network_handle",
                            ),
                            models.UniqueConstraint(
                                condition=models.Q(("domain", ""), _negated=True),
                                fields=("network", "domain"),
                                name="socialprofile_network_domain",
                            ),
                            models.CheckConstraint(
                                condition=models.Q(
                                    models.Q(("user__isnull", False), ("group__isnull", True)),
                                    models.Q(("user__isnull", True), ("group__isnull", False)),
                                    _connector="OR",
                                ),
                                name="socialprofile_requires_owner",
                            ),
                        ],
                    },
                ),
            ],
        ),
    ]
