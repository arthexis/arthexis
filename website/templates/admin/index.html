{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrahead %}
  {{ block.super }}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.css">
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/python/python.min.js"></script>
{% endblock %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'admin/css/dashboard.css' %}">
  <style>
    .dashboard {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        box-sizing: border-box;
    }
    .dashboard-main {
        flex: 1 1 calc(70% - 0.5rem);
        min-width: 300px;
        max-width: 100%;
        box-sizing: border-box;
    }
    .dashboard-side {
        flex: 1 1 calc(30% - 0.5rem);
        min-width: 300px;
        max-width: 100%;
        box-sizing: border-box;
        background: var(--darkened-bg);
        padding-left: 12px;
        padding-right: 12px;
    }
    .dashboard-side .module {
        background: none;
    }
    .dashboard-side .module h2 {
        background: none;
        padding: 16px;
        margin-bottom: 16px;
        border-bottom: 1px solid var(--hairline-color);
        font-size: 1.125rem;
        color: var(--body-fg);
    }
    .dashboard-side h3 {
        color: var(--body-quiet-color);
        padding: 0 16px;
        margin: 0 0 16px;
    }
    .dashboard-side p {
        padding: 0 16px;
    }
    .dashboard-side .actionlist {
        padding: 0;
        margin: 16px;
    }
    .dashboard-side .actionlist li {
        line-height: 1.2;
        margin-bottom: 10px;
        padding-left: 18px;
    }
    /* Override Django's dashboard defaults so the flex layout works */
    .dashboard #content {
        width: auto;
        box-sizing: border-box;
    }
    #content-main,
    #recent-boxes {
        float: none;
        width: auto;
    }
  </style>
{% endblock %}

{% block coltype %}colM{% endblock %}

{% block bodyclass %}{{ block.super }} dashboard{% endblock %}

{% block content_title %}
<div id="admin-home-header" style="display:flex; justify-content:space-between; align-items:center;">
  <h1>Home</h1>
  <a href="#" id="switch-console" class="button">Switch to console mode</a>
 </div>
{% endblock %}

{% block nav-breadcrumbs %}{% endblock %}
{% block nav-sidebar %}{% endblock %}

{% block content %}
<div class="dashboard" id="admin-dashboard">
  <div id="content-main" class="dashboard-main">
    {% include "admin/app_list.html" with app_list=app_list show_changelinks=True %}
</div>
<div class="dashboard-side" id="recent-boxes">
    <div class="module" id="recent-history-module">
        <h2>{% translate 'Recent admin lists' %}</h2>
        {% with history=user.admin_history.all|slice:":10" %}
            {% if history %}
            <ul class="actionlist">
                {% for item in history %}
                <li class="changelink"><a href="{{ item.url }}">{{ item.admin_label }}</a></li>
                {% endfor %}
            </ul>
            {% else %}
            <p>{% translate 'None available' %}</p>
            {% endif %}
        {% endwith %}
    </div>
    <div class="module" id="recent-actions-module">
        <h2>{% translate 'Recent actions' %}</h2>
        <h3>{% translate 'My actions' %}</h3>
            {% load log %}
            {% get_admin_log 10 as admin_log for_user user %}
            {% if not admin_log %}
            <p>{% translate 'None available' %}</p>
            {% else %}
            <ul class="actionlist">
            {% for entry in admin_log %}
            <li class="{% if entry.is_addition %}addlink{% endif %}{% if entry.is_change %} changelink{% endif %}{% if entry.is_deletion %} deletelink{% endif %}">
                <span class="visually-hidden">{% if entry.is_addition %}{% translate 'Added:' %}{% elif entry.is_change %}{% translate 'Changed:' %}{% elif entry.is_deletion %}{% translate 'Deleted:' %}{% endif %}</span>
                {% if entry.is_deletion or not entry.get_admin_url %}
                    {{ entry.object_repr }}
                {% else %}
                    <a href="{{ entry.get_admin_url }}">{{ entry.object_repr }}</a>
                {% endif %}
                <br>
                {% if entry.content_type %}
                    <span class="mini quiet">{% filter capfirst %}{{ entry.content_type.name }}{% endfilter %}</span>
                {% else %}
                    <span class="mini quiet">{% translate 'Unknown content' %}</span>
                {% endif %}
            </li>
            {% endfor %}
            </ul>
            {% endif %}
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const link = document.getElementById('switch-console');
  if (!link) return;

  const dashboard = document.getElementById('admin-dashboard');
  const sidebar = document.getElementById('nav-sidebar');
  const content = document.getElementById('content');
  const header = document.getElementById('admin-home-header');

  let consoleWrapper = null;
  let editor = null;
  let output = null;
  let history = [];
  let historyIndex = 0;
  let consoleVisible = false;

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  function executeSource() {
    const source = editor.getValue();
    if (!source.trim()) return;
    const csrfToken = getCookie('csrftoken');
    fetch('/webshell/execute/', {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: new URLSearchParams({source, csrfmiddlewaretoken: csrfToken})
    }).then(r => r.text()).then(t => {
      output.textContent += `>>> ${source}\n${t}`;
      output.scrollTop = output.scrollHeight;
    });
    history.push(source);
    historyIndex = history.length;
    editor.setValue('');
  }

  function initConsole() {
    consoleWrapper = document.createElement('div');
    consoleWrapper.id = 'admin-console-wrapper';
    const height = (window.innerHeight - header.getBoundingClientRect().bottom) * 1.5;
    consoleWrapper.style.height = height + 'px';
    consoleWrapper.style.boxSizing = 'border-box';
    consoleWrapper.style.display = 'flex';
    consoleWrapper.style.flexDirection = 'column';
    consoleWrapper.style.display = 'none';
    consoleWrapper.innerHTML = '<textarea id="id_source"></textarea><pre id="id_output" style="flex:1; overflow:auto; margin-top:1rem;"></pre>';
    content.appendChild(consoleWrapper);

    editor = CodeMirror.fromTextArea(document.getElementById('id_source'), {
      mode: {name: "python", version: 3},
      lineNumbers: false,
      indentUnit: 4,
      matchBrackets: true
    });
    editor.setSize(null, Math.round(height * 0.4) + 'px');
    output = document.getElementById('id_output');
    output.style.height = Math.round(height * 0.6 - 16) + 'px';

    editor.on('keydown', function(cm, event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        executeSource();
      } else if (event.key === 'ArrowUp') {
        if (historyIndex > 0) {
          historyIndex -= 1;
          cm.setValue(history[historyIndex]);
          cm.setCursor(cm.lineCount(), 0);
        }
        event.preventDefault();
      } else if (event.key === 'ArrowDown') {
        if (historyIndex < history.length - 1) {
          historyIndex += 1;
          cm.setValue(history[historyIndex]);
        } else {
          historyIndex = history.length;
          cm.setValue('');
        }
        cm.setCursor(cm.lineCount(), 0);
        event.preventDefault();
      }
    });
  }

  function showConsole() {
    if (!consoleWrapper) {
      initConsole();
    }
    if (dashboard) dashboard.style.display = 'none';
    if (sidebar) sidebar.style.display = 'none';
    consoleWrapper.style.display = 'flex';
    link.textContent = 'Switch to browse mode';
  }

  function showDashboard() {
    consoleWrapper.style.display = 'none';
    if (dashboard) dashboard.style.display = '';
    if (sidebar) sidebar.style.display = '';
    link.textContent = 'Switch to console mode';
  }

  link.addEventListener('click', function (e) {
    e.preventDefault();
    if (consoleVisible) {
      showDashboard();
    } else {
      showConsole();
    }
    consoleVisible = !consoleVisible;
  });
});
</script>
{% endblock %}

{% block sidebar %}{% endblock %}
