{% extends "pages/base.html" %}

{% load i18n %}

{% block title %}{{ charger.display_name|default:charger.name|default:charger.charger_id }} - {% trans "Status" %}{% endblock %}

{% block content %}
<div id="status-content">
  {% if connector_links %}
  <div class="mb-3">
    <div class="nav nav-pills flex-wrap gap-2">
      {% for link in connector_links %}
      <a class="nav-link {% if link.active %}active{% endif %}" href="{{ link.url }}">{{ link.label }}</a>
      {% endfor %}
    </div>
  </div>
  {% endif %}
  <style>
    @keyframes text-update-fade {
      0% {
        color: #FFD700;
        text-shadow: 0 0 8px rgba(255,215,0,0.8);
      }
      100% {
        color: inherit;
        text-shadow: none;
      }
    }
    .text-update {
      animation: text-update-fade 1s ease-out;
    }
  </style>
    <h1>{{ charger.display_name|default:charger.name|default:charger.charger_id }}</h1>
    <p class="text-muted">{% trans "Connector" %}: {{ charger.connector_label }}</p>
    <p><a href="{{ page_url }}">{% trans "Landing page" %}</a></p>
    {% if past_session %}
  <div class="alert alert-info" role="alert">
    {% trans "Viewing past session" %} {{ tx.id }}. <a href="{{ page_url }}">{% trans "Back to live" %}</a>
  </div>
  {% endif %}
  <div class="row mb-4">
    <div class="col-md-4">
      <p>{% trans "Serial Number" %}: {{ charger.charger_id }}</p>
      <div class="mb-3 d-flex align-items-center">
        <span class="d-inline-block rounded-circle me-2" style="width:20px;height:20px;background-color: {{ color }};"></span>
        <strong id="charger-state">{{ state }}</strong>
      </div>
      {% if charger.last_status %}
      <p class="text-muted small mb-1" id="last-status-raw">{% trans "Reported status" %}: {{ charger.last_status }}</p>
      {% endif %}
      {% if charger.last_error_code %}
      <p class="text-muted small mb-1" id="last-status-error">{% trans "Error code" %}: {{ charger.last_error_code }}</p>
      {% endif %}
      {% if charger.last_status_timestamp %}
      <p class="text-muted small mb-1" id="last-status-timestamp">{% trans "Last status update" %}: {{ charger.last_status_timestamp|date:"SHORT_DATETIME_FORMAT" }}</p>
      {% endif %}
      {% if charger.last_status_vendor_info %}
        {% if charger.last_status_vendor_info.vendorId %}
        <p class="text-muted small mb-1" id="last-status-vendor">{% trans "Vendor" %}: {{ charger.last_status_vendor_info.vendorId }}</p>
        {% endif %}
        {% if charger.last_status_vendor_info.info %}
        <p class="text-muted small mb-1" id="last-status-info">{% trans "Info" %}: {{ charger.last_status_vendor_info.info }}</p>
        {% endif %}
      {% endif %}
      <p>{% trans "Total Energy" %}: <span id="total-kw">{{ charger.total_kw|floatformat:2 }}</span> kW</p>
      {% if charger.diagnostics_status or charger.diagnostics_timestamp or charger.diagnostics_location %}
      <div class="mb-3">
        <h2 class="h6 mb-1">{% trans "Diagnostics" %}</h2>
        {% if charger.diagnostics_status %}
        <p class="mb-1">
          {% trans "Status" %}: <span id="diagnostics-status">{{ charger.diagnostics_status }}</span>
        </p>
        {% endif %}
        {% if charger.diagnostics_timestamp %}
        <p class="mb-1 text-muted">
          <small>{% trans "Reported" %}: <span id="diagnostics-timestamp">{{ charger.diagnostics_timestamp|date:"SHORT_DATETIME_FORMAT" }}</span></small>
        </p>
        {% endif %}
        {% if charger.diagnostics_location %}
        <p class="mb-0 text-break">
          <small>{% trans "Location" %}: <span id="diagnostics-location">{{ charger.diagnostics_location }}</span></small>
        </p>
        {% endif %}
      </div>
      {% endif %}
      {% if charger.temperature is not None %}
      <p>{% trans "Temperature" %}: <span id="temperature">{{ charger.temperature }}</span> {{ charger.temperature_unit }}</p>
      {% endif %}
      <div class="mb-3">
        <h2 class="h6">{% trans "Firmware" %}</h2>
        {% if charger.firmware_status %}
        <p>{% trans "Status" %}: <span id="firmware-status">{{ charger.firmware_status }}</span></p>
        {% else %}
        <p>{% trans "Status" %}: <span id="firmware-status" class="text-muted">{% trans "Unknown" %}</span></p>
        {% endif %}
        {% if charger.firmware_status_info %}
        <p>{% trans "Details" %}: <span id="firmware-status-info">{{ charger.firmware_status_info }}</span></p>
        {% endif %}
        {% if charger.firmware_timestamp %}
        {% with iso_ts=charger.firmware_timestamp|date:"c" %}
        <p>{% trans "Updated" %}: <span id="firmware-timestamp" data-iso="{{ iso_ts }}">{{ charger.firmware_timestamp|date:"SHORT_DATETIME_FORMAT" }}</span></p>
        {% endwith %}
        {% endif %}
      </div>
      {% if tx %}
      <h2>{% if past_session %}{% trans "Session" %}{% else %}{% trans "Current Transaction" %}{% endif %}</h2>
      <ul>
        <li>{% trans "Transaction ID" %}: {{ tx.id }}</li>
        <li>{% trans "Meter Start" %}: {{ tx.meter_start }}</li>
        <li>{% trans "Start Time" %}: {{ tx.start_time }}</li>
        <li>{% trans "Session Energy" %}: <span id="session-kw">{{ tx.kw|floatformat:2 }}</span> kW</li>
      </ul>
      {% elif not past_session %}
      <p>{% trans "No active transaction" %}</p>
      {% endif %}
    </div>
    <div class="col-md-8">
      {% if show_chart %}
      <canvas id="kw-chart" style="width:100%;height:300px;"></canvas>
      {{ chart_data|json_script:"chart-data" }}
      {% else %}
      <div class="alert alert-info" role="alert">
        {% trans "Select a connector to view live chart data." %}
      </div>
      {% endif %}
    </div>
  </div>

  {% if charger.connector_id is None and connector_overview %}
  <h2 class="h5">{% trans "Connectors" %}</h2>
  <div class="row g-3 mb-4">
    {% for item in connector_overview %}
    <div class="col-12 col-lg-6">
      <div class="border rounded-3 p-3 h-100">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="fw-semibold">{{ item.label }}</span>
          <span class="badge" style="background-color: {{ item.color }};">{{ item.status }}</span>
        </div>
        {% if item.last_status or item.last_error_code or item.last_status_timestamp or item.last_status_vendor_info %}
        <div class="mb-2">
          {% if item.last_status %}<p class="mb-1 text-muted"><small>{% trans "Reported status" %}: {{ item.last_status }}</small></p>{% endif %}
          {% if item.last_error_code %}<p class="mb-1 text-muted"><small>{% trans "Error code" %}: {{ item.last_error_code }}</small></p>{% endif %}
          {% if item.last_status_timestamp %}<p class="mb-1 text-muted"><small>{% trans "Last status update" %}: {{ item.last_status_timestamp|date:"SHORT_DATETIME_FORMAT" }}</small></p>{% endif %}
          {% if item.last_status_vendor_info %}
            {% if item.last_status_vendor_info.vendorId %}<p class="mb-1 text-muted"><small>{% trans "Vendor" %}: {{ item.last_status_vendor_info.vendorId }}</small></p>{% endif %}
            {% if item.last_status_vendor_info.info %}<p class="mb-1 text-muted"><small>{% trans "Info" %}: {{ item.last_status_vendor_info.info }}</small></p>{% endif %}
          {% endif %}
        </div>
        {% endif %}
        {% if item.tx %}
        <p class="mb-1"><small>{% trans "Energy" %}: {{ item.tx.kw|floatformat:2 }} kW</small></p>
        <p class="mb-0 text-muted"><small>{% trans "Started" %}: {{ item.tx.start_time|date:"SHORT_DATETIME_FORMAT" }}</small></p>
        {% else %}
        <p class="mb-0 text-muted"><small>{% trans "No active transaction" %}</small></p>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <h2>{% trans "Sessions" %}</h2>
  <table class="table">
    <thead>
      <tr>
        {% if charger.connector_id is None %}
        <th>{% trans "Connector" %}</th>
        {% endif %}
        <th>{% trans "ID" %}</th>
        <th>{% trans "Start" %}</th>
        <th>{% trans "Stop" %}</th>
        <th>{% trans "Energy (kW)" %}</th>
      </tr>
    </thead>
    <tbody>
      {% for tx in transactions %}
      <tr>
        {% if charger.connector_id is None %}
        <td>{{ tx.charger.connector_label|default:tx.charger.connector_id }}</td>
        {% endif %}
        <td><a href="?session={{ tx.id }}">{{ tx.id }}</a></td>
        <td>{{ tx.start_time }}</td>
        <td>{{ tx.stop_time|default:"-" }}</td>
        <td>{{ tx.kw|floatformat:2 }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="{% if charger.connector_id is None %}5{% else %}4{% endif %}">{% trans "No sessions found." %}</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="d-flex justify-content-between align-items-center">
    {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}">{% trans "Previous 10" %}</a>
    {% else %}
    <span></span>
    {% endif %}
    <div class="d-flex align-items-center gap-3">
      <a href="{{ search_url }}">{% trans "Search" %}</a>
      {% if configuration_url %}
      <a href="{{ configuration_url }}">{% trans "Configuration" %}</a>
      {% endif %}
    </div>
    {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}">{% trans "Next 10" %}</a>
    {% else %}
    <span></span>
    {% endif %}
  </div>
 </div>
{% if show_chart %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let kwChart = null;
  const chartData = { labels: [], datasets: [] };
  const COLOR_PALETTE = [
    { border: 'rgba(255,69,0,1)', background: 'rgba(255,69,0,0.3)' },
    { border: 'rgba(30,144,255,1)', background: 'rgba(30,144,255,0.3)' },
    { border: 'rgba(34,139,34,1)', background: 'rgba(34,139,34,0.3)' },
    { border: 'rgba(147,112,219,1)', background: 'rgba(147,112,219,0.3)' },
    { border: 'rgba(255,140,0,1)', background: 'rgba(255,140,0,0.3)' }
  ];
  const CONNECTOR_COLOR_MAP = {
    1: COLOR_PALETTE[0],
    2: COLOR_PALETTE[1],
  };

  function parseConnectorId(dataset) {
    if (!dataset) {
      return null;
    }
    if (dataset.connector_id !== undefined && dataset.connector_id !== null) {
      const numericId = Number(dataset.connector_id);
      if (!Number.isNaN(numericId)) {
        return numericId;
      }
    }
    if (typeof dataset.label === 'string') {
      const match = dataset.label.match(/connector\s*(\d+)/i) || dataset.label.match(/^(\d+)$/);
      if (match) {
        const numericId = Number(match[1]);
        if (!Number.isNaN(numericId)) {
          return numericId;
        }
      }
    }
    return null;
  }

  function getPaletteForDataset(dataset, index) {
    const connectorId = parseConnectorId(dataset);
    if (
      connectorId !== null &&
      Object.prototype.hasOwnProperty.call(CONNECTOR_COLOR_MAP, connectorId)
    ) {
      return CONNECTOR_COLOR_MAP[connectorId];
    }
    return COLOR_PALETTE[index % COLOR_PALETTE.length];
  }

  function parseChartPayload(root) {
    if (!root || !root.querySelector) {
      return null;
    }
    const script = root.querySelector('#chart-data');
    if (!script) {
      return null;
    }
    try {
      return JSON.parse(script.textContent);
    } catch (err) {
      console.error('Failed to parse chart data', err);
      return null;
    }
  }

  function applyChartPayload(payload) {
    if (!payload) {
      chartData.labels = [];
      chartData.datasets = [];
      return;
    }
    const labels = Array.isArray(payload.labels) ? payload.labels : [];
    chartData.labels = labels.map((ts) => {
      const parsed = new Date(ts);
      return Number.isNaN(parsed.getTime()) ? ts : parsed.toLocaleTimeString();
    });
    chartData.datasets = (payload.datasets || []).map((dataset, index) => {
      const palette = getPaletteForDataset(dataset, index);
      const values = Array.isArray(dataset.values)
        ? dataset.values.map((value) => {
            if (value === null || value === undefined || value === '') {
              return null;
            }
            const numeric = Number(value);
            return Number.isNaN(numeric) ? null : numeric;
          })
        : [];
      return {
        label: dataset.label || `Connector ${index + 1}`,
        data: values,
        fill: true,
        borderColor: palette.border,
        backgroundColor: palette.background,
        tension: 0.4,
        spanGaps: true,
      };
    });
  }

  function renderChart() {
    const canvas = document.getElementById('kw-chart');
    if (!canvas) return;
    if (!kwChart) {
      const ctx = canvas.getContext('2d');
      kwChart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
          interaction: { mode: 'index', intersect: false },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    } else {
      kwChart.data.labels = chartData.labels;
      kwChart.data.datasets = chartData.datasets;
      kwChart.update();
    }
  }

  function highlightChange(el) {
    el.classList.add('text-update');
    setTimeout(() => el.classList.remove('text-update'), 1000);
  }

  function reloadStatus() {
    const current = document.getElementById('status-content');
    const oldCanvas = current.querySelector('#kw-chart');
    fetch(window.location.href, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
      .then(resp => resp.text())
      .then(html => {
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const newContent = doc.getElementById('status-content');
        if (newContent) {
          const changedIds = [];
          newContent.querySelectorAll('[id]').forEach(el => {
            const oldEl = current.querySelector(`#${el.id}`);
            if (oldEl && oldEl.textContent !== el.textContent) {
              changedIds.push(el.id);
            }
          });
          const payload = parseChartPayload(newContent);
          current.innerHTML = newContent.innerHTML;
          if (oldCanvas) {
            const placeholder = current.querySelector('#kw-chart');
            if (placeholder) {
              placeholder.replaceWith(oldCanvas);
            }
          }
          applyChartPayload(payload);
          if (kwChart || (payload && chartData.datasets.length)) {
            renderChart();
          }
          changedIds.forEach(id => {
            const el = current.querySelector(`#${id}`);
            if (el) {
              highlightChange(el);
            }
          });
        }
      });
  }

  document.addEventListener('DOMContentLoaded', () => {
    const payload = parseChartPayload(document);
    applyChartPayload(payload);
    renderChart();
  });

  setInterval(reloadStatus, 5000);
</script>
{% else %}
<script>
  function highlightChange(el) {
    el.classList.add('text-update');
    setTimeout(() => el.classList.remove('text-update'), 1000);
  }

  function reloadStatus() {
    const current = document.getElementById('status-content');
    fetch(window.location.href, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
      .then(resp => resp.text())
      .then(html => {
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const newContent = doc.getElementById('status-content');
        if (newContent) {
          const changedIds = [];
          newContent.querySelectorAll('[id]').forEach(el => {
            const oldEl = current.querySelector(`#${el.id}`);
            if (oldEl && oldEl.textContent !== el.textContent) {
              changedIds.push(el.id);
            }
          });
          current.innerHTML = newContent.innerHTML;
          changedIds.forEach(id => {
            const el = current.querySelector(`#${id}`);
            if (el) {
              highlightChange(el);
            }
          });
        }
      });
  }

  document.addEventListener('DOMContentLoaded', reloadStatus);
  setInterval(reloadStatus, 5000);
</script>
{% endif %}
{% endblock %}
