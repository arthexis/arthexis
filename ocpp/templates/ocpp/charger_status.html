{% extends "pages/base.html" %}

{% load i18n %}

{% block title %}{{ charger.name|default:charger.charger_id }} - {% trans "Status" %}{% endblock %}

{% block content %}
<div id="status-content">
  <style>
    @keyframes text-update-fade {
      0% {
        color: #FFD700;
        text-shadow: 0 0 8px rgba(255,215,0,0.8);
      }
      100% {
        color: inherit;
        text-shadow: none;
      }
    }
    .text-update {
      animation: text-update-fade 1s ease-out;
    }
  </style>
    <h1>{{ charger.name|default:charger.charger_id }}</h1>
    <p><a href="{% url 'charger-page' charger.charger_id %}">{% trans "Landing page" %}</a></p>
    {% if past_session %}
  <div class="alert alert-info" role="alert">
    {% trans "Viewing past session" %} {{ tx.id }}. <a href="{% url 'charger-page' charger.charger_id %}">{% trans "Back to live" %}</a>
  </div>
  {% endif %}
  <div class="row mb-4">
    <div class="col-md-4">
      <p>{% trans "Serial Number" %}: {{ charger.charger_id }}</p>
      <div class="mb-3 d-flex align-items-center">
        <span class="d-inline-block rounded-circle me-2" style="width:20px;height:20px;background-color: {{ color }};"></span>
        <strong id="charger-state">{{ state }}</strong>
      </div>
      <p>{% trans "Total Energy" %}: <span id="total-kw">{{ charger.total_kw|floatformat:2 }}</span> kW</p>
      {% if charger.temperature is not None %}
      <p>{% trans "Temperature" %}: <span id="temperature">{{ charger.temperature }}</span> {{ charger.temperature_unit }}</p>
      {% endif %}
      {% if tx %}
      <h2>{% if past_session %}{% trans "Session" %}{% else %}{% trans "Current Transaction" %}{% endif %}</h2>
      <ul>
        <li>{% trans "Transaction ID" %}: {{ tx.id }}</li>
        <li>{% trans "Meter Start" %}: {{ tx.meter_start }}</li>
        <li>{% trans "Start Time" %}: {{ tx.start_time }}</li>
        <li>{% trans "Session Energy" %}: <span id="session-kw">{{ tx.kw|floatformat:2 }}</span> kW</li>
      </ul>
      {% elif not past_session %}
      <p>{% trans "No active transaction" %}</p>
      {% endif %}
    </div>
    <div class="col-md-8">
      <canvas id="kw-chart" style="width:100%;height:300px;"></canvas>
    </div>
  </div>

  <h2>{% trans "Sessions" %}</h2>
  <table class="table">
    <thead>
      <tr>
        <th>{% trans "ID" %}</th>
        <th>{% trans "Start" %}</th>
        <th>{% trans "Stop" %}</th>
        <th>{% trans "Energy (kW)" %}</th>
      </tr>
    </thead>
    <tbody>
      {% for tx in transactions %}
      <tr>
        <td><a href="?session={{ tx.id }}">{{ tx.id }}</a></td>
        <td>{{ tx.start_time }}</td>
        <td>{{ tx.stop_time|default:"-" }}</td>
        <td>{{ tx.kw|floatformat:2 }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="4">{% trans "No sessions found." %}</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="d-flex justify-content-between">
    {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}">{% trans "Previous 10" %}</a>
    {% endif %}
    <a href="{% url 'charger-session-search' charger.charger_id %}">{% trans "Search" %}</a>
    {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}">{% trans "Next 10" %}</a>
    {% endif %}
  </div>
  {% if request.user.is_staff and charger.console_url %}
  <div class="mt-4 text-end">
    <a class="btn btn-outline-secondary" href="{% url 'charger-console' charger.charger_id %}" target="_blank" rel="noopener">{% trans "View Console" %}</a>
  </div>
  {% endif %}
 </div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let kwChart = null;
  const chartData = {
    labels: [],
    datasets: [{
      label: 'Energy (kW)',
      data: [],
      fill: true,
      borderColor: 'rgba(255,69,0,1)',
      tension: 0.4
    }]
  };

  const initialChart = {{ chart_data|safe }};
  chartData.labels = initialChart.labels.map(ts => new Date(ts).toLocaleTimeString());
  chartData.datasets[0].data = initialChart.values;

  function setupChart() {
    const canvas = document.getElementById('kw-chart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, 'rgba(255,0,0,0.5)');
    gradient.addColorStop(1, 'rgba(255,165,0,0.5)');
    chartData.datasets[0].backgroundColor = gradient;
    if (kwChart) {
      kwChart.destroy();
    }
    kwChart = new Chart(ctx, {
      type: 'line',
      data: chartData,
      options: {
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  function addDataPoint(kw) {
    const now = new Date();
    chartData.labels.push(now.toLocaleTimeString());
    chartData.datasets[0].data.push(kw);
  }

  function highlightChange(el) {
    el.classList.add('text-update');
    setTimeout(() => el.classList.remove('text-update'), 1000);
  }

  function reloadStatus() {
    const current = document.getElementById('status-content');
    const oldCanvas = current.querySelector('#kw-chart');
    fetch(window.location.href, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
      .then(resp => resp.text())
      .then(html => {
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const newContent = doc.getElementById('status-content');
        if (newContent) {
          const changedIds = [];
          newContent.querySelectorAll('[id]').forEach(el => {
            const oldEl = current.querySelector(`#${el.id}`);
            if (oldEl && oldEl.textContent !== el.textContent) {
              changedIds.push(el.id);
            }
          });
          const kwElem = newContent.querySelector('#session-kw');
          const stateElem = newContent.querySelector('#charger-state');
          const isCharging = stateElem && stateElem.textContent.trim() === 'Charging';
          let chartNeedsUpdate = false;
          if (kwElem && isCharging) {
            const kw = parseFloat(kwElem.textContent);
            const lastKw = chartData.datasets[0].data[chartData.datasets[0].data.length - 1];
            if (kw !== lastKw) {
              addDataPoint(kw);
              chartNeedsUpdate = true;
            }
          }
          current.innerHTML = newContent.innerHTML;
          if (oldCanvas) {
            const placeholder = current.querySelector('#kw-chart');
            if (placeholder) {
              placeholder.replaceWith(oldCanvas);
            }
          }
          if (chartNeedsUpdate && kwChart) {
            kwChart.update();
          }
          changedIds.forEach(id => {
            const el = current.querySelector(`#${id}`);
            if (el) {
              highlightChange(el);
            }
          });
        }
      });
  }

  document.addEventListener('DOMContentLoaded', () => {
    if (chartData.datasets[0].data.length === 0) {
      const kwElem = document.getElementById('session-kw');
      const stateElem = document.getElementById('charger-state');
      const isCharging = stateElem && stateElem.textContent.trim() === 'Charging';
      if (kwElem && isCharging) {
        addDataPoint(parseFloat(kwElem.textContent));
      }
    }
    setupChart();
    setInterval(reloadStatus, 5000);
  });
</script>
{% endblock %}
