{% extends "pages/base.html" %}
{% load i18n humanize %}

{% block title %}{% trans "Charge Points" %}{% endblock %}

{% block content %}
<h1>{% trans "Charge Points" %}</h1>
{% if show_demo_notice %}
<div id="demo-notice" class="alert alert-info position-relative" role="alert" data-session-key="ocppDemoNoticeDismissed">
  <button
    type="button"
    class="btn-close btn-close-white position-absolute top-0 end-0 mt-2 me-2"
    data-demo-notice-dismiss
    aria-label="{% trans "Dismiss demo notice" %}"
  ></button>
  <h2 class="h5 mb-2">{% trans "Demo OCPP 1.6 CPMS (Charge Point Management System)" %}</h2>
  <p class="mb-1">{% trans "Everyone is welcome to use this demo to test their charge points." %}</p>
  <p class="mb-1">{% blocktrans with limit=ws_rate_limit %}Rate limiting applies (maximum {{ limit }} simultaneous connections per IP).{% endblocktrans %}</p>
  <p class="mb-0">{% blocktrans %}Use the following WebSocket URL format, replacing &lt;CHARGE_POINT_ID&gt; with your charge point identifier:{% endblocktrans %}</p>
  <pre class="mb-0"><code>{{ demo_ws_url }}</code></pre>
  <p class="mb-0 mt-2">
    {% blocktrans trimmed %}You may also provide the identifier as a query parameter using any of the following names: <code>cid</code>, <code>chargePointId</code>, <code>charge_point_id</code>, <code>chargeBoxId</code>, <code>charge_box_id</code>, or <code>chargerId</code>.{% endblocktrans %}
  </p>
</div>
<script>
  (function () {
    if (typeof window === 'undefined' || typeof document === 'undefined') {
      return;
    }

    const notice = document.getElementById('demo-notice');
    if (!notice) {
      return;
    }

    const dismissButton = notice.querySelector('[data-demo-notice-dismiss]');
    if (!dismissButton) {
      return;
    }

    const storage = (() => {
      try {
        if (!('sessionStorage' in window)) {
          return null;
        }
        const testKey = '__ocppDemoNoticeTest__';
        window.sessionStorage.setItem(testKey, '1');
        window.sessionStorage.removeItem(testKey);
        return window.sessionStorage;
      } catch (error) {
        return null;
      }
    })();

    const storageKey = notice.dataset.sessionKey || 'ocppDemoNoticeDismissed';
    const dismissed = storage ? storage.getItem(storageKey) === '1' : false;
    if (dismissed) {
      notice.classList.add('d-none');
      return;
    }

    dismissButton.addEventListener('click', () => {
      notice.classList.add('d-none');
      if (!storage) {
        return;
      }
      try {
        storage.setItem(storageKey, '1');
      } catch (error) {
        // Ignore storage errors (e.g., disabled cookies)
      }
    });
  })();
</script>
{% endif %}
<table class="table">
  <thead>
    <tr>
      <th>{% trans "Name" %}</th>
      <th>{% trans "Serial Number" %}</th>
      <th class="text-end">{% trans "Total kW" %}</th>
      <th class="text-end">{% trans "Today's kW" %}</th>
      <th>{% trans "Status" %}</th>
      <th>{% trans "Last Seen" %}</th>
    </tr>
  </thead>
  <tbody>
    {% if charger_groups %}
      {% for group in charger_groups %}
        {% if group.parent %}
        <tr>
          <td>
            <a href="{{ group.parent.status_url }}">{{ group.parent.display_name }}</a>
          </td>
          <td>{{ group.parent.charger.charger_id }}</td>
          <td class="text-end">{{ group.parent.stats.total_kw|floatformat:2 }}</td>
          <td class="text-end">{{ group.parent.stats.today_kw|floatformat:2 }}</td>
          <td>
            <span class="badge" style="background-color: {{ group.parent.color }};">{{ group.parent.state }}</span>
          </td>
          <td>
            {% if group.parent.last_seen %}
              <time datetime="{{ group.parent.last_seen|date:'c' }}" title="{{ group.parent.last_seen|date:'DATETIME_FORMAT' }}">
                {{ group.parent.last_seen|naturaltime }}
              </time>
            {% else %}
              &mdash;
            {% endif %}
          </td>
        </tr>
        {% endif %}
        {% for item in group.children %}
        <tr>
          <td class="ps-4">
            <a href="{{ item.status_url }}">{{ item.display_name }}</a>
          </td>
          <td>
            {{ item.charger.charger_id }}{% if item.charger.connector_id %} #{{ item.charger.connector_id }}{% endif %}
          </td>
          <td class="text-end">{{ item.stats.total_kw|floatformat:2 }}</td>
          <td class="text-end">{{ item.stats.today_kw|floatformat:2 }}</td>
          <td>
            <span class="badge" style="background-color: {{ item.color }};">{{ item.state }}</span>
          </td>
          <td>
            {% if item.last_seen %}
              <time datetime="{{ item.last_seen|date:'c' }}" title="{{ item.last_seen|date:'DATETIME_FORMAT' }}">
                {{ item.last_seen|naturaltime }}
              </time>
            {% else %}
              &mdash;
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      {% endfor %}
    {% else %}
    <tr><td colspan="6">{% trans "No charge points found." %}</td></tr>
    {% endif %}
  </tbody>
</table>
{% if request.user.is_staff %}
<p class="text-center mt-3">
  <a href="{% url 'admin:ocpp_charger_changelist' %}">{% trans "Configure" %}</a>
</p>
{% endif %}
{% endblock %}
