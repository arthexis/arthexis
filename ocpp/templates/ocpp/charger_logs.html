{% extends "pages/base.html" %}
{% load i18n %}

{% block title %}Log for {{ charger.display_name|default:charger.name|default:charger.charger_id }}{% endblock %}

{% block extra_head %}
<style>
  #log {
    max-height: calc(1em * 40);
    overflow-y: auto;
    overflow-x: auto;
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="mb-0">Log for {{ charger.display_name|default:charger.name|default:charger.charger_id }}</h1>
  {% if status_url %}
  <a class="btn btn-secondary" href="{{ status_url }}">{% trans "Back to status" %}</a>
  {% endif %}
</div>
{% if log_type == "charger" and connector_links %}
<nav class="nav nav-pills mb-3">
  {% for item in connector_links %}
  <a class="nav-link{% if item.active %} active{% endif %}" href="{{ item.url }}">{{ item.label }}</a>
  {% endfor %}
</nav>
{% endif %}
<div class="form-check mb-2">
  <input class="form-check-input" type="checkbox" id="auto-reload">
  <label class="form-check-label" for="auto-reload">Auto reload</label>
</div>
<pre id="log" class="p-3 border rounded bg-body text-body">
{% for entry in log %}{{ entry }}
{% endfor %}
</pre>
<script>
  const logEl = document.getElementById('log');
  function scrollToBottom() {
    logEl.scrollTop = logEl.scrollHeight;
  }
  function fetchLog() {
    fetch(window.location.href, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
      .then(resp => resp.text())
      .then(html => {
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const newLog = doc.getElementById('log');
        if (newLog) {
          logEl.textContent = newLog.textContent;
          scrollToBottom();
        }
      });
  }
  scrollToBottom();
  let reloadTimer;
  document.getElementById('auto-reload').addEventListener('change', function() {
    if (this.checked) {
      reloadTimer = setInterval(fetchLog, 3000);
    } else if (reloadTimer) {
      clearInterval(reloadTimer);
    }
  });
</script>
{% endblock %}
