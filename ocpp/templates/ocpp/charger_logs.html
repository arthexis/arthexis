{% extends "pages/base.html" %}
{% load i18n %}

{% block title %}{% trans "Charge point log" %}{% endblock %}

{% block extra_head %}
<style>
  #log {
    max-height: calc(1em * 40);
    overflow-y: auto;
    overflow-x: auto;
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3">
  <div class="d-flex flex-wrap align-items-center gap-2">
    <h1 class="mb-0">Log for {{ charger.display_name|default:charger.name|default:charger.charger_id }}</h1>
    <a id="log-download-link" class="link-secondary fw-semibold" href="{{ log_download_url }}">{% trans "Download log" %}</a>
  </div>
  {% if status_url %}
  <a class="btn btn-secondary" href="{{ status_url }}">{% trans "Back to status" %}</a>
  {% endif %}
</div>
{% if log_type == "charger" and connector_links %}
<nav class="nav nav-pills mb-3">
  {% for item in connector_links %}
  <a class="nav-link{% if item.active %} active{% endif %}" href="{{ item.url }}">{{ item.label }}</a>
  {% endfor %}
</nav>
{% endif %}
<div class="form-check mb-2">
  <input class="form-check-input" type="checkbox" id="auto-reload">
  <label class="form-check-label" for="auto-reload">Auto reload</label>
</div>
<div class="mb-3">
  <label for="log-limit" class="form-label">{% trans "Lines to display" %}: <span id="log-limit-value">{{ log_limit_label }}</span></label>
  <input
    type="range"
    class="form-range"
    id="log-limit"
    min="0"
    max="{{ log_limit_options|length|add:'-1' }}"
    step="1"
    list="log-limit-options"
    value="{{ log_limit_index }}"
  >
  <datalist id="log-limit-options">
    {% for option in log_limit_options %}
    <option value="{{ forloop.counter0 }}" label="{{ option.label }}"></option>
    {% endfor %}
  </datalist>
</div>
{{ log_limit_options|json_script:"log-limit-data" }}
<pre id="log" class="p-3 border rounded bg-body text-body">
{% for entry in log %}{{ entry }}
{% endfor %}
</pre>
<script>
  const logEl = document.getElementById('log');
  const limitDataScript = document.getElementById('log-limit-data');
  const limitSlider = document.getElementById('log-limit');
  const limitValueEl = document.getElementById('log-limit-value');
  const downloadLink = document.getElementById('log-download-link');
  const limitData = limitDataScript ? JSON.parse(limitDataScript.textContent) : [];

  function getLimitItem(index) {
    return limitData[Math.max(0, Math.min(index, limitData.length - 1))];
  }

  function updateLimitLabel() {
    if (!limitSlider || !limitValueEl) {
      return;
    }
    const index = parseInt(limitSlider.value, 10) || 0;
    const item = getLimitItem(index);
    if (item) {
      limitValueEl.textContent = item.label;
    }
  }

  function scrollToBottom() {
    logEl.scrollTop = logEl.scrollHeight;
  }
  function fetchLog(url = window.location.href) {
    fetch(url, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
      .then(resp => resp.text())
      .then(html => {
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const newLog = doc.getElementById('log');
        if (newLog) {
          logEl.textContent = newLog.textContent;
          scrollToBottom();
        }
        const newDownload = doc.getElementById('log-download-link');
        if (newDownload && downloadLink) {
          downloadLink.href = newDownload.href;
        }
      });
  }
  function updateLimitSelection() {
    if (!limitSlider) {
      return;
    }
    const index = parseInt(limitSlider.value, 10) || 0;
    const item = getLimitItem(index);
    if (!item) {
      return;
    }
    const url = new URL(window.location);
    url.searchParams.set('limit', item.value);
    window.history.replaceState({}, '', url);
    fetchLog(url.toString());
  }
  if (limitSlider) {
    limitSlider.addEventListener('input', updateLimitLabel);
    limitSlider.addEventListener('change', () => {
      updateLimitLabel();
      updateLimitSelection();
    });
  }
  updateLimitLabel();
  scrollToBottom();
  let reloadTimer;
  document.getElementById('auto-reload').addEventListener('change', function() {
    if (this.checked) {
      reloadTimer = setInterval(fetchLog, 3000);
    } else if (reloadTimer) {
      clearInterval(reloadTimer);
    }
  });
</script>
{% endblock %}
