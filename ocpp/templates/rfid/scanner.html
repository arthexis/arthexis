{% with prefix=prefix|default:"rfid" %}
  <div id="{{ prefix }}-scanner">
    {% if toggle_url or admin_view_url or public_view_url %}
      <div class="rfid-mode-toggle">
        {% if toggle_url %}
          <a id="{{ prefix }}-mode-toggle" class="button" href="{{ toggle_url }}" data-toggle-url="{{ toggle_url }}">{{ toggle_label }}</a>
        {% endif %}
        {% if request.user.is_staff and admin_view_url %}
          <a class="button secondary" href="{{ admin_view_url }}">Admin View</a>
        {% elif request.user.is_staff and public_view_url %}
          <a class="button secondary" href="{{ public_view_url }}">Public View</a>
        {% endif %}
      </div>
    {% endif %}
  <p id="{{ prefix }}-status">Scanner ready</p>
  <p>
    {% if request.user.is_staff %}
      <button id="{{ prefix }}-connect-local">Connect Local Scanner</button>
      <button id="{{ prefix }}-deep-read">Enable Deep Read</button>
      <a id="{{ prefix }}-configure" href="#" style="display:none; margin-left:1em;"></a>
    {% endif %}
  </p>
  {% if table_mode %}
    <div class="rfid-table-mode">
      <table class="rfid-history" id="{{ prefix }}-history">
        <thead>
          <tr>
            <th>Time</th>
            <th>Label</th>
            <th>Type</th>
            <th>Color</th>
            <th>Valid</th>
            {% if request.user.is_staff %}
              <th>RFID</th>
            {% endif %}
            {% if show_release_info %}
              <th>Released</th>
              <th>Reference</th>
            {% endif %}
          </tr>
        </thead>
        <tbody id="{{ prefix }}-history-body"></tbody>
      </table>
      <p class="rfid-history-total">Total scanned: <span id="{{ prefix }}-total-count">0</span></p>
    </div>
  {% else %}
    <div class="field"><span class="label">Label:</span><span class="value" id="{{ prefix }}-label"></span></div>
    <div class="field"><span class="label">Type:</span><span class="value" id="{{ prefix }}-kind"></span></div>
    <div class="field"><span class="label">Color:</span><span class="value" id="{{ prefix }}-color"></span></div>
    <div class="field"><span class="label">Valid:</span><span class="value" id="{{ prefix }}-allowed"></span></div>
    {% if request.user.is_staff %}
      <div class="field"><span class="label">RFID:</span><span class="value" id="{{ prefix }}-rfid"></span></div>
    {% endif %}
    {% if show_release_info %}
      <div class="field"><span class="label">Released:</span><span class="value" id="{{ prefix }}-released"></span></div>
      <div class="field"><span class="label">Reference:</span><span class="value" id="{{ prefix }}-reference"></span></div>
    {% endif %}
  {% endif %}
</div>
<style>
#{{ prefix }}-scanner {
  --rfid-table-border: #d0d5dd;
  --rfid-header-bg: #f1f5f9;
  --rfid-header-text: #1f2937;
  --rfid-row-bg: #ffffff;
  --rfid-row-alt-bg: #f8fafc;
  --rfid-row-text: #111827;
  --rfid-row-hover-bg: #e0f2fe;
}

@media (prefers-color-scheme: dark) {
  #{{ prefix }}-scanner {
    --rfid-table-border: rgba(255, 255, 255, 0.24);
    --rfid-header-bg: rgba(255, 255, 255, 0.08);
    --rfid-header-text: #f9fafb;
    --rfid-row-bg: rgba(17, 24, 39, 0.7);
    --rfid-row-alt-bg: rgba(17, 24, 39, 0.55);
    --rfid-row-text: #e5e7eb;
    --rfid-row-hover-bg: rgba(59, 130, 246, 0.3);
  }
}

#{{ prefix }}-scanner .rfid-mode-toggle {
  display: flex;
  justify-content: flex-end;
  flex-wrap: wrap;
  gap: 0.75em;
  margin-bottom: 1em;
}

#{{ prefix }}-scanner .rfid-mode-toggle .button {
  text-decoration: none;
  padding: 0.35em 0.9em;
  border-radius: 9999px;
  font-weight: 600;
  background: var(--rfid-header-bg);
  color: var(--rfid-header-text);
  border: 1px solid var(--rfid-table-border);
  transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, border-color 0.2s ease-in-out;
}

#{{ prefix }}-scanner .rfid-mode-toggle .button:hover {
  background: var(--rfid-row-hover-bg);
}

#{{ prefix }}-scanner .rfid-mode-toggle .button.secondary {
  background: transparent;
  color: inherit;
}

#{{ prefix }}-scanner .rfid-mode-toggle .button.secondary:hover {
  background: var(--rfid-header-bg);
}

#{{ prefix }}-scanner .field {
  display: flex;
  margin: 0.5em 0;
  font-size: 1.2em;
}
#{{ prefix }}-scanner .label {
  width: 7em;
  font-weight: bold;
}
#{{ prefix }}-scanner .value {
  flex: 1;
}
#{{ prefix }}-scanner .rfid-table-mode {
  margin-top: 1em;
}
#{{ prefix }}-scanner .rfid-history {
  border-collapse: separate;
  border-spacing: 0;
  width: 100%;
  border: 1px solid var(--rfid-table-border);
  border-radius: 0.5rem;
  overflow: hidden;
  background-color: var(--rfid-row-bg);
  color: var(--rfid-row-text);
}
#{{ prefix }}-scanner .rfid-history th,
#{{ prefix }}-scanner .rfid-history td {
  padding: 0.5em 0.75em;
  text-align: left;
  border-right: 1px solid var(--rfid-table-border);
}
#{{ prefix }}-scanner .rfid-history th:last-child,
#{{ prefix }}-scanner .rfid-history td:last-child {
  border-right: none;
}
#{{ prefix }}-scanner .rfid-history thead th {
  background-color: var(--rfid-header-bg);
  color: var(--rfid-header-text);
  font-weight: 600;
  border-bottom: 1px solid var(--rfid-table-border);
}
#{{ prefix }}-scanner .rfid-history tbody tr {
  background-color: var(--rfid-row-bg);
  transition: background-color 0.2s ease-in-out;
}
#{{ prefix }}-scanner .rfid-history tbody tr:nth-child(odd) {
  background-color: var(--rfid-row-alt-bg);
}
#{{ prefix }}-scanner .rfid-history tbody tr:hover {
  background-color: var(--rfid-row-hover-bg);
}
#{{ prefix }}-scanner .rfid-history-total {
  font-weight: bold;
  margin-top: 0.75em;
  color: var(--rfid-row-text);
}
#{{ prefix }}-status {
  font-size: 1.2em;
  margin-bottom: 1em;
}
</style>
<script>
(function(){
  const statusEl = document.getElementById('{{ prefix }}-status');
  const labelEl = document.getElementById('{{ prefix }}-label');
  const kindEl = document.getElementById('{{ prefix }}-kind');
  const colorEl = document.getElementById('{{ prefix }}-color');
  const allowedEl = document.getElementById('{{ prefix }}-allowed');
  const rfidEl = document.getElementById('{{ prefix }}-rfid');
  const releasedEl = document.getElementById('{{ prefix }}-released');
  const referenceEl = document.getElementById('{{ prefix }}-reference');
  const connectBtn = document.getElementById('{{ prefix }}-connect-local');
  const deepBtn = document.getElementById('{{ prefix }}-deep-read');
  const configureEl = document.getElementById('{{ prefix }}-configure');
  const modeToggleBtn = document.getElementById('{{ prefix }}-mode-toggle');
  const adminTemplate = '{{ admin_change_url_template|default:""|escapejs }}';
  const tableMode = {% if table_mode %}true{% else %}false{% endif %};

  const historyBody = tableMode ? document.getElementById('{{ prefix }}-history-body') : null;
  const totalCountEl = tableMode ? document.getElementById('{{ prefix }}-total-count') : null;
  const isStaff = {{ request.user.is_staff|yesno:"true,false" }};
  const showReleaseInfo = {{ show_release_info|yesno:"true,false" }};

  let historyCount = 0;
  let localPort = null;
  let localReader = null;
  let localConnected = false;
  let lastLocalValue = null;
  let lastLocalAt = 0;
  const historyEntries = tableMode ? new Map() : null;

  if(modeToggleBtn){
    const toggleTarget = modeToggleBtn.getAttribute('data-toggle-url') || modeToggleBtn.getAttribute('href');
    if(toggleTarget){
      modeToggleBtn.addEventListener('click', function(event){
        event.preventDefault();
        window.location.href = toggleTarget;
      });
    }
  }

  function booleanText(value){
    if(value === undefined || value === null){
      return '';
    }
    return value ? 'Yes' : 'No';
  }

  function validText(data){
    if(data.allowed === undefined || data.allowed === null){
      return '';
    }
    return data.allowed && data.released ? 'Yes' : 'No';
  }

  function buildHistoryCells(data, labelValue){
    const values = [
      new Date().toLocaleTimeString(),
      labelValue,
      data.kind || '',
      data.color || '',
      validText(data),
    ];
    if(isStaff){
      values.push(data.rfid || '');
    }
    if(showReleaseInfo){
      values.push(booleanText(data.released));
      values.push(data.reference || '');
    }
    return values;
  }

  function appendHistoryRow(data, labelValue){
    if(!historyBody){
      return;
    }
    const key = data.rfid || (labelValue ? `label:${labelValue}` : null);
    if(!key){
      return;
    }
    if(historyEntries && historyEntries.has(key)){
      const existingRow = historyEntries.get(key);
      if(existingRow && existingRow.parentElement === historyBody){
        historyBody.removeChild(existingRow);
      }
    }
    const row = document.createElement('tr');
    buildHistoryCells(data, labelValue).forEach((value) => {
      const cell = document.createElement('td');
      cell.textContent = value;
      row.appendChild(cell);
    });
    historyBody.insertBefore(row, historyBody.firstChild);
    if(historyEntries){
      historyEntries.set(key, row);
      historyCount = historyEntries.size;
    } else {
      historyCount += 1;
    }
    if(totalCountEl){
      totalCountEl.textContent = String(historyCount);
    }
  }

  function showError(message){
    console.error(message);
    const defaultMsg = 'RFID reader not detected. Please connect the reader.';
    if(typeof message === 'string' && message){
      statusEl.textContent = message;
    } else {
      statusEl.textContent = defaultMsg;
    }
  }

  function updateFromData(data){
    if(!data || data.error){
      if(data && data.error){
        showError(data.error);
      }
      return;
    }
    if(!data.rfid){
      return;
    }
    const labelValue = data.label_id === undefined || data.label_id === null ? '' : data.label_id;
    if(labelEl){ labelEl.textContent = labelValue; }
    if(kindEl){ kindEl.textContent = data.kind || ''; }
    if(rfidEl){ rfidEl.textContent = data.rfid || ''; }
    if(colorEl){ colorEl.textContent = data.color || ''; }
    if(allowedEl){ allowedEl.textContent = validText(data); }
    if(releasedEl){ releasedEl.textContent = booleanText(data.released); }
    if(referenceEl){ referenceEl.textContent = data.reference || ''; }
    const hasReferenceLink = data.reference && /^https?:\/\//i.test(data.reference);
    if(referenceEl && hasReferenceLink){
      const w = window.open(data.reference, '_blank');
      if(w){ w.focus(); }
    } else if(!referenceEl && tableMode && showReleaseInfo && hasReferenceLink){
      const w = window.open(data.reference, '_blank');
      if(w){ w.focus(); }
    }
    if(configureEl){
      configureEl.textContent = `Configure RFID ${labelValue}`;
      configureEl.href = adminTemplate ? adminTemplate.replace('0', labelValue) : '#';
      configureEl.style.display = 'inline';
    }
    const okText = data.allowed === undefined ? '' : (data.allowed ? 'OK' : 'BAD');
    const statusMsg = okText ? `RFID ${labelValue} ${okText}` : `RFID ${labelValue}`;
    statusEl.textContent = data.created ? `Created ${statusMsg}` : statusMsg;
    if(tableMode){
      appendHistoryRow(data, labelValue);
    }
  }

  async function poll(){
    try {
      const resp = await fetch('{{ scan_url }}');
      const data = await resp.json();
      if(data.error){
        showError(data.error);
      } else {
        updateFromData(data);
      }
    } catch(err){
      showError(err);
    } finally {
      setTimeout(poll, 200);
    }
  }

  function getCookie(name){
    const cookies = document.cookie ? document.cookie.split('; ') : [];
    for(let i = 0; i < cookies.length; i += 1){
      const parts = cookies[i].split('=');
      const key = parts.shift();
      if(key === name){
        return decodeURIComponent(parts.join('='));
      }
    }
    return null;
  }

  async function sendLocalScan(rfidValue){
    const headers = {
      'Content-Type': 'application/json',
      'Accept': 'application/json',
    };
    const csrf = getCookie('csrftoken');
    if(csrf){
      headers['X-CSRFToken'] = csrf;
    }
    try {
      const resp = await fetch('{{ scan_url }}', {
        method: 'POST',
        credentials: 'same-origin',
        headers,
        body: JSON.stringify({rfid: rfidValue})
      });
      const data = await resp.json();
      if(!resp.ok || data.error){
        showError(data.error || 'Unable to validate RFID');
        return;
      }
      updateFromData(data);
    } catch(err){
      showError('Local scanner validation failed');
    }
  }

  function handleLocalScan(rawValue){
    if(!rawValue){
      return;
    }
    const cleaned = rawValue.replace(/[^0-9A-Fa-f]/g, '').toUpperCase();
    if(!cleaned){
      return;
    }
    const now = Date.now();
    if(lastLocalValue === cleaned && now - lastLocalAt < 300){
      return;
    }
    lastLocalValue = cleaned;
    lastLocalAt = now;
    sendLocalScan(cleaned);
  }

  async function readFromLocalPort(){
    if(!localPort || !localPort.readable){
      throw new Error('Local scanner is not readable');
    }
    localReader = localPort.readable.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    try {
      while(true){
        const {value, done} = await localReader.read();
        if(done){
          break;
        }
        if(value){
          buffer += decoder.decode(value, {stream: true});
          const parts = buffer.split(/[\r\n]+/);
          buffer = parts.pop() || '';
          for(let i = 0; i < parts.length; i += 1){
            handleLocalScan(parts[i].trim());
          }
        }
      }
      buffer += decoder.decode();
      if(buffer.trim()){
        handleLocalScan(buffer.trim());
      }
    } finally {
      if(localReader){
        try { localReader.releaseLock(); } catch(err) { /* ignore */ }
        localReader = null;
      }
    }
  }

  async function connectLocalScanner(){
    if(!('serial' in navigator)){
      showError('This browser does not support connecting to local scanners.');
      return;
    }
    try {
      statusEl.textContent = 'Select a local scanner to connect.';
      const port = await navigator.serial.requestPort();
      await port.open({baudRate: 9600});
      localPort = port;
      localConnected = true;
      if(connectBtn){
        connectBtn.disabled = true;
        connectBtn.textContent = 'Scanner Connected';
      }
      statusEl.textContent = 'Local scanner connected. Awaiting RFID...';
      await readFromLocalPort();
    } catch(err){
      if(err && err.name === 'NotFoundError'){
        statusEl.textContent = 'Scanner ready';
      } else if(localConnected){
        showError('Local scanner disconnected');
      } else {
        showError('Failed to connect to local scanner');
      }
    } finally {
      if(localReader){
        try { await localReader.cancel(); } catch(err) { /* ignore */ }
      }
      if(localPort){
        try { await localPort.close(); } catch(err) { /* ignore */ }
        localPort = null;
      }
      if(connectBtn){
        connectBtn.disabled = false;
        connectBtn.textContent = 'Connect Local Scanner';
      }
      if(localConnected){
        statusEl.textContent = 'Local scanner disconnected';
      }
      localConnected = false;
      localReader = null;
    }
  }

  function setupLocalScanner(){
    if(!connectBtn){
      return;
    }
    if(!('serial' in navigator)){
      connectBtn.disabled = true;
      connectBtn.title = 'Web Serial API is not supported in this browser.';
      return;
    }
    connectBtn.addEventListener('click', () => {
      connectLocalScanner();
    });
    if(navigator.serial.addEventListener){
      navigator.serial.addEventListener('disconnect', (event) => {
        if(localPort && event.target === localPort){
          localPort = null;
          localConnected = false;
          if(connectBtn){
            connectBtn.disabled = false;
            connectBtn.textContent = 'Connect Local Scanner';
          }
          showError('Local scanner disconnected');
        }
      });
    }
  }

  if(deepBtn){
    deepBtn.addEventListener('click', async () => {
      try {
        await fetch('{{ deep_read_url|default:"" }}', {method: 'POST'});
        statusEl.textContent = 'Deep read enabled for 60 seconds';
      } catch(err){
        statusEl.textContent = 'Deep read failed';
      }
    });
  }
  setupLocalScanner();
  poll();
})();
</script>
{% endwith %}
