<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Net Monitor Console</title>
    <style>
      body {
        margin: 0;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #0b0c10;
        color: #e2e8f0;
      }
      main {
        min-height: 100vh;
        display: grid;
        place-items: center;
        padding: clamp(1rem, 4vw, 2rem);
      }
      .viewport-shell {
        width: min(1200px, 100%);
        background: #0f172a;
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: 1rem;
        box-shadow: 0 1.25rem 3rem rgba(0, 0, 0, 0.35);
        overflow: hidden;
      }
      .viewport-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: linear-gradient(90deg, rgba(59, 130, 246, 0.08), rgba(59, 130, 246, 0));
      }
      .viewport-header h1 {
        margin: 0;
        font-size: 1.1rem;
        letter-spacing: 0.01em;
      }
      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.7rem;
        font-size: 0.85rem;
        border-radius: 999px;
        background: rgba(59, 130, 246, 0.15);
        border: 1px solid rgba(59, 130, 246, 0.4);
      }
      .status-dot {
        width: 0.55rem;
        height: 0.55rem;
        border-radius: 50%;
        background: #38bdf8;
        box-shadow: 0 0 0 0.25rem rgba(56, 189, 248, 0.15);
      }
      .viewport-body {
        position: relative;
        aspect-ratio: 16 / 9;
        background: radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.08), transparent 25%),
          radial-gradient(circle at 80% 30%, rgba(45, 212, 191, 0.08), transparent 22%),
          #0b0c10;
      }
      .viewport-body iframe {
        width: 100%;
        height: 100%;
        border: 0;
        display: block;
        background: transparent;
      }
      .notice {
        padding: 1rem 1.25rem;
        border-top: 1px solid rgba(148, 163, 184, 0.15);
        background: rgba(15, 23, 42, 0.7);
        color: #cbd5e1;
        font-size: 0.95rem;
      }
      .notice strong {
        color: #e2e8f0;
      }
    </style>
  </head>
  <body>
    <main>
      <div class="viewport-shell">
        <div class="viewport-header">
          <h1>WASM Net Monitor</h1>
          <span class="status-pill" id="wasm-status">
            <span class="status-dot" aria-hidden="true"></span>
            <span>Initializing</span>
          </span>
        </div>
        <div class="viewport-body" id="viewport-body">
          <div id="viewport-placeholder" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:0.5rem;color:#cbd5e1;">
            <div style="font-weight:600;">Preparing Pyxel viewportâ€¦</div>
            <div style="font-size:0.95rem;max-width:540px;text-align:center;line-height:1.5;">
              The WASM bundle generated by <code>pyxel_viewport</code> will be loaded here when available.
            </div>
          </div>
        </div>
        <div class="notice" id="viewport-notice">
          <strong>Tip:</strong> Run <code>./pyxel-viewport.sh</code> (or the Windows equivalent) and copy the generated <code>pyxel_viewport</code> output into <code>static/ocpp/net_monitor/pyxel_viewport</code> to surface the live canvas here.
        </div>
      </div>
    </main>
    <script>
      (async function () {
        const status = document.getElementById('wasm-status');
        const placeholder = document.getElementById('viewport-placeholder');
        const viewportBody = document.getElementById('viewport-body');
        const notice = document.getElementById('viewport-notice');
        const label = status.querySelector('span:last-child');
        const parentOrigin = (() => {
          try {
            const { origin } = new URL(document.referrer);
            return origin === 'null' ? '*' : origin;
          } catch (error) {
            return '*';
          }
        })();

        const notifyParent = (state) => {
          try {
            window.parent?.postMessage(
              { type: 'net-monitor-status', status: state },
              parentOrigin,
            );
          } catch (error) {
            /* no-op */
          }
        };

        if (typeof WebAssembly === 'undefined') {
          label.textContent = 'Unavailable';
          status.style.background = 'rgba(248, 180, 0, 0.15)';
          status.style.borderColor = 'rgba(248, 180, 0, 0.4)';
          status.querySelector('.status-dot').style.background = '#f59e0b';
          placeholder.innerHTML = '<div style="font-weight:600;">WebAssembly is not available.</div><div style="max-width:520px;text-align:center;line-height:1.5;">Use a modern browser to render the Pyxel viewport inside this console.</div>';
          notifyParent('unsupported');
          return;
        }

        label.textContent = 'Supported';

        const iframe = document.createElement('iframe');
        iframe.src = 'pyxel_viewport/index.html';
        iframe.setAttribute('title', 'Pyxel WASM viewport');
        iframe.setAttribute('allowfullscreen', 'true');
        iframe.style.opacity = '0';
        let resolved = false;
        const markMissing = () => {
          if (resolved) {
            return;
          }
          resolved = true;
          label.textContent = 'Asset missing';
          status.querySelector('.status-dot').style.background = '#f87171';
          placeholder.innerHTML =
            '<div style="font-weight:600;">Pyxel viewport assets not found.</div><div style="max-width:540px;text-align:center;line-height:1.5;">Place the WebAssembly build produced by <code>pyxel_viewport</code> inside <code>static/ocpp/net_monitor/pyxel_viewport</code> to launch the console.</div>';
          notifyParent('missing');
        };
        const loadTimeout = setTimeout(markMissing, 8000);
        iframe.addEventListener('load', () => {
          resolved = true;
          clearTimeout(loadTimeout);
          iframe.style.opacity = '1';
          placeholder.style.display = 'none';
          notice.innerHTML = '<strong>Connected:</strong> The Pyxel viewport is running. If you do not see live data, ensure the backend suite is feeding snapshots to the WASM build.';
          label.textContent = 'Ready';
          status.querySelector('.status-dot').style.background = '#34d399';
          notifyParent('ready');
        });
        iframe.addEventListener('error', () => {
          markMissing();
        });

        try {
          const headResponse = await fetch(iframe.src, { method: 'HEAD' });
          if (!headResponse.ok) {
            throw new Error('missing');
          }
          notifyParent('loading');
          viewportBody.appendChild(iframe);
        } catch (error) {
          markMissing();
        }
      })();
    </script>
  </body>
</html>
